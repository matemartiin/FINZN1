(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();const K="modulepreload",Z=function(v,e){return new URL(v,e).href},V={},L=function(e,t,o){let n=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),r=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));n=Promise.allSettled(t.map(l=>{if(l=Z(l,o),l in V)return;V[l]=!0;const c=l.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(!!o)for(let g=a.length-1;g>=0;g--){const p=a[g];if(p.href===l&&(!c||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${d}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":K,c||(u.as="script"),u.crossOrigin="",u.href=l,r&&u.setAttribute("nonce",r),document.head.appendChild(u),c)return new Promise((g,p)=>{u.addEventListener("load",g),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return n.then(a=>{for(const i of a||[])i.status==="rejected"&&s(i.reason);return e().catch(s)})};let f;console.warn("âš ï¸  Missing Supabase environment variables - using mock mode:",{url:"Missing",key:"Missing"}),f={from:()=>({select:()=>({data:[],error:null}),insert:()=>({data:null,error:{message:"Mock mode - no database"}}),update:()=>({data:null,error:{message:"Mock mode - no database"}}),delete:()=>({data:null,error:{message:"Mock mode - no database"}}),eq:function(){return this},gte:function(){return this},lte:function(){return this},order:function(){return this},single:function(){return this}}),auth:{getUser:()=>({data:{user:null},error:null}),signIn:()=>({data:null,error:{message:"Mock mode"}}),signOut:()=>({error:null})}};const B=Object.freeze(Object.defineProperty({__proto__:null,get supabase(){return f}},Symbol.toStringTag,{value:"Module"}));class Q{constructor(){this.currentUser=null,this.initializeAuth()}async initializeAuth(){var e;console.log("ğŸ” Initializing authentication...");try{if(!f||typeof((e=f.auth)==null?void 0:e.getSession)!="function"){console.warn("âš ï¸ Supabase not properly configured, using mock auth"),this.currentUser=null;return}const{data:{session:t},error:o}=await f.auth.getSession();o&&(console.error("Error getting session:",o),await this.handleAuthError(o)),this.currentUser=(t==null?void 0:t.user)||null}catch(t){console.error("Error in initializeAuth:",t),this.currentUser=null}f.auth.onAuthStateChange((t,o)=>{this.currentUser=(o==null?void 0:o.user)||null,t==="SIGNED_OUT"?(this.clearUserData(),window.location.reload()):t==="SIGNED_IN"&&setTimeout(async()=>{window.app&&window.app.userProfile&&(console.log("ğŸ” Loading user profile after sign in..."),await window.app.userProfile.loadUserProfile())},500)})}async handleAuthError(e){console.log("ğŸ”§ Handling auth error:",e.message);try{await f.auth.signOut(),this.clearUserData()}catch(t){console.error("Error during auth recovery:",t)}}async login(e,t){try{const{data:o,error:n}=await f.auth.signInWithPassword({email:e.trim(),password:t});if(n)throw console.error("Login error:",n),n.message.includes("Invalid login credentials")?new Error("Email o contraseÃ±a incorrectos"):n.message.includes("Email not confirmed")?new Error("Por favor confirma tu email antes de iniciar sesiÃ³n"):new Error(n.message);return this.currentUser=o.user,!0}catch(o){throw console.error("Login error:",o),o}}async register(e,t){var o;try{if(!f||typeof((o=f.auth)==null?void 0:o.signUp)!="function")throw new Error("Supabase no estÃ¡ configurado correctamente. Verifica las variables de entorno.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))throw new Error("Por favor ingresa un email vÃ¡lido");if(t.length<6)throw new Error("La contraseÃ±a debe tener al menos 6 caracteres");const{data:s,error:a}=await f.auth.signUp({email:e.trim(),password:t});if(a)throw console.error("Registration error:",a),a.message.includes("User already registered")?new Error("Este email ya estÃ¡ registrado. Intenta iniciar sesiÃ³n."):a.message.includes("Invalid email")?new Error("Email invÃ¡lido. Por favor verifica el formato."):a.message.includes("Password")?new Error("La contraseÃ±a debe tener al menos 6 caracteres."):a.message.includes("signup is disabled")?new Error("El registro estÃ¡ deshabilitado en Supabase. Verifica la configuraciÃ³n en Authentication > Settings."):a.message.includes("signups not allowed")?new Error("Los registros no estÃ¡n permitidos. Contacta al administrador."):a.message.includes("Email signups are disabled")?new Error("Los registros por email estÃ¡n deshabilitados en Supabase. Ve a Authentication > Settings > Auth Providers > Email y actÃ­valo."):new Error(a.message);return s.user?s.user.email_confirmed_at||s.session?(this.currentUser=s.user,{success:!0,needsConfirmation:!1,user:s.user}):{success:!0,needsConfirmation:!0,user:s.user}:{success:!0,needsConfirmation:!1,user:s.user}}catch(n){throw console.error("Registration error:",n),n}}async logout(){try{console.log("ğŸ‘‹ Logging out...");const{error:e}=await f.auth.signOut();e&&console.error("Logout error:",e),this.clearUserData(),this.currentUser=null}catch(e){console.error("Logout error:",e)}}getCurrentUser(){var e;return((e=this.currentUser)==null?void 0:e.email)||null}getCurrentUserId(){var t;return((t=this.currentUser)==null?void 0:t.id)||null}isAuthenticated(){return!!this.currentUser}clearUserData(){Object.keys(localStorage).forEach(t=>{(t.startsWith("finzn-")||t.startsWith("sb-"))&&localStorage.removeItem(t)});try{localStorage.removeItem("finzn-google-calendar-sync"),console.log("ğŸ”Œ Google Calendar sync state cleared on logout")}catch(t){console.error("Error clearing Google Calendar sync state:",t)}}generateTestEmail(){const e=Date.now(),t=Math.floor(Math.random()*1e3);return`test${e}${t}@finzn.app`}}class X{constructor(){this.data={expenses:{},income:{},extraIncomes:{},goals:[],categories:this.getDefaultCategories(),achievements:[],recurringExpenses:[],spendingLimits:[],monthlySavings:{}},this.currentMonth=this.getCurrentMonth()}getDefaultCategories(){return[{id:"1",name:"Comida",icon:'<i class="ph ph-fork-knife"></i>',color:"#ef4444"},{id:"2",name:"Transporte",icon:'<i class="ph ph-car"></i>',color:"#3b82f6"},{id:"3",name:"Salud",icon:'<i class="ph ph-heart-straight"></i>',color:"#10b981"},{id:"4",name:"Ocio",icon:'<i class="ph ph-game-controller"></i>',color:"#f59e0b"},{id:"5",name:"Supermercado",icon:'<i class="ph ph-shopping-cart"></i>',color:"#14b8a6"},{id:"6",name:"Servicios",icon:'<i class="ph ph-house"></i>',color:"#6366f1"},{id:"7",name:"Ropa",icon:'<i class="ph ph-t-shirt"></i>',color:"#ec4899"},{id:"8",name:"EducaciÃ³n",icon:'<i class="ph ph-book"></i>',color:"#8b5cf6"},{id:"9",name:"TecnologÃ­a",icon:'<i class="ph ph-laptop"></i>',color:"#06b6d4"},{id:"10",name:"Deportes",icon:'<i class="ph ph-soccer-ball"></i>',color:"#84cc16"},{id:"11",name:"Viajes",icon:'<i class="ph ph-airplane"></i>',color:"#f97316"},{id:"12",name:"PedidosYa",icon:'<img src="/assets/svg/pedidosya-logo.svg" alt="PedidosYa" width="20" height="20" style="display: inline-block;">',color:"#dc2626"},{id:"13",name:"Otros",icon:'<i class="ph ph-dots-three"></i>',color:"#9ca3af"}]}async loadUserData(){if(this.getCurrentUserId())try{await this.loadCategories(),await this.migrateCategoryIconsToPhosphor(),await this.migrateCategoryColors(),await this.loadSpendingLimits(),await this.loadGoals(),await this.loadAchievements(),await this.loadExpenses(this.currentMonth),await this.loadIncome(this.currentMonth),await this.loadExtraIncomes(this.currentMonth),console.log("âœ… User data loaded successfully")}catch(t){console.error("âŒ Error loading user data:",t)}}getCurrentUserId(){var e,t;return((t=(e=window.app)==null?void 0:e.auth)==null?void 0:t.getCurrentUserId())||null}getCurrentMonth(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`}getCategories(){return this.data.categories}async loadCategories(){const e=this.getCurrentUserId();if(e)try{const{data:t,error:o}=await f.from("categories").select("*").eq("user_id",e);if(o){if(console.error("âŒ Error loading categories:",o),o.message&&o.message.includes("Failed to fetch")){console.log("ğŸ”„ Using default categories due to connection error"),this.data.categories=this.getDefaultCategories();return}return}t&&t.length>0?(this.data.categories=t.map(n=>({id:n.id,name:n.name,icon:n.icon,color:n.color})),console.log("âœ… Categories loaded from database:",this.data.categories.length)):(console.log("ğŸ“ No categories found, creating defaults"),await this.createDefaultCategories())}catch(t){console.error("âŒ Error in loadCategories:",t),console.log("ğŸ”„ Using default categories as fallback"),this.data.categories=this.getDefaultCategories(),this.migrateLocalCategoryIcons()}}async createDefaultCategories(){const e=this.getCurrentUserId();if(e)try{const t=this.getDefaultCategories().map(n=>({user_id:e,name:n.name,icon:n.icon,color:n.color})),{error:o}=await f.from("categories").insert(t);o?console.error("Error creating default categories:",o):console.log("âœ… Default categories created")}catch(t){console.error("Error in createDefaultCategories:",t)}}async migrateCategoryIconsToPhosphor(){const e=this.getCurrentUserId();if(e)try{console.log("ğŸ”„ Migrating category icons to Phosphor...");const t={"ğŸ”":'<i class="ph ph-fork-knife"></i>',"ğŸš—":'<i class="ph ph-car"></i>',"ğŸ’Š":'<i class="ph ph-heart-straight"></i>',"ğŸ‰":'<i class="ph ph-game-controller"></i>',"ğŸ›’":'<i class="ph ph-shopping-cart"></i>',"ğŸ“±":'<i class="ph ph-house"></i>',"ğŸ“¦":'<i class="ph ph-dots-three"></i>',"ğŸ½ï¸":'<i class="ph ph-fork-knife"></i>',"ğŸ¥":'<i class="ph ph-heart-straight"></i>',"ğŸ®":'<i class="ph ph-game-controller"></i>',"ğŸ ":'<i class="ph ph-house"></i>',"ğŸ¦":'<i class="ph ph-bank"></i>',"ğŸ”§":'<i class="ph ph-wrench"></i>'},{data:o,error:n}=await f.from("categories").select("*").eq("user_id",e);if(n){console.error("Error fetching categories for migration:",n);return}let s=0;for(const a of o){const i=t[a.icon];if(i){const{error:r}=await f.from("categories").update({icon:i}).eq("id",a.id).eq("user_id",e);r?console.error(`Error updating category ${a.name}:`,r):(console.log(`âœ… Migrated ${a.name}: ${a.icon} â†’ ${i}`),s++)}}s>0?(console.log(`âœ… Migration completed! Updated ${s} categories.`),await this.loadCategories()):console.log("â„¹ï¸ No categories needed migration.")}catch(t){console.error("Error in migrateCategoryIconsToPhosphor:",t)}}async migrateCategoryColors(){const e=this.getCurrentUserId();if(e)try{console.log("ğŸ¨ Checking for category color migration...");const t=this.data.categories;if(!t||t.length===0){console.log("â„¹ï¸ No categories loaded, skipping color migration.");return}const o=t.map(u=>u.color),n=o.filter((u,g)=>o.indexOf(u)!==g),s=[t.find(u=>u.name==="Salud"&&u.color==="#ef4444"),t.find(u=>u.name==="Supermercado"&&u.color==="#10b981"),t.find(u=>u.name==="PedidosYa"&&(u.color==="#ff6b35"||u.color==="#ef4444"))].filter(Boolean);if(n.length===0&&s.length===0){console.log("âœ… All category colors are already unique and correct!");return}console.log("ğŸ¨ ğŸ”§ SELECTIVE MIGRATION NEEDED - Problematic categories found:",s.map(u=>({name:u.name,color:u.color}))),console.log("ğŸ”§ UPDATING ONLY PROBLEMATIC DEFAULT CATEGORIES...");const a=this.getDefaultCategories().map(u=>u.name),i=t.filter(u=>!a.includes(u.name));if(console.log("ğŸ‘¤ User custom categories to preserve:",i.map(u=>u.name)),s.length>0)for(const u of s){const{error:g}=await f.from("categories").delete().eq("user_id",e).eq("name",u.name);g?console.error(`âŒ Error deleting category ${u.name}:`,g):console.log(`ğŸ—‘ï¸ Deleted problematic category: ${u.name}`)}console.log("ğŸ¨ CREATING FRESH DEFAULT CATEGORIES WITH UNIQUE COLORS...");const r=this.getDefaultCategories(),l=t.filter(u=>!s.some(g=>g.id===u.id)).map(u=>u.name),c=r.filter(u=>!l.includes(u.name)).map(u=>({user_id:e,name:u.name,icon:u.icon,color:u.color}));if(c.length>0){const{data:u,error:g}=await f.from("categories").insert(c).select();if(g){console.error("âŒ Error creating fresh categories:",g);return}console.log("âœ… FRESH DEFAULT CATEGORIES CREATED:",c.map(p=>p.name))}else console.log("â„¹ï¸ No default categories needed to be created");await this.loadCategories();const d=this.data.categories.map(u=>u.color),m=d.filter((u,g)=>d.indexOf(u)!==g);m.length===0?console.log("âœ… ğŸ‰ MIGRATION SUCCESSFUL! All colors are now unique and will remain stable."):console.error("âŒ Migration failed - still have duplicates:",m)}catch(t){console.error("âŒ Color migration failed:",t)}}migrateLocalCategoryIcons(){const e={"ğŸ”":'<i class="ph ph-fork-knife"></i>',"ğŸš—":'<i class="ph ph-car"></i>',"ğŸ’Š":'<i class="ph ph-heart-straight"></i>',"ğŸ‰":'<i class="ph ph-game-controller"></i>',"ğŸ›’":'<i class="ph ph-shopping-cart"></i>',"ğŸ“±":'<i class="ph ph-house"></i>',"ğŸ“¦":'<i class="ph ph-dots-three"></i>',"ğŸ½ï¸":'<i class="ph ph-fork-knife"></i>',"ğŸ¥":'<i class="ph ph-heart-straight"></i>',"ğŸ®":'<i class="ph ph-game-controller"></i>',"ğŸ ":'<i class="ph ph-house"></i>',"ğŸ¦":'<i class="ph ph-bank"></i>',"ğŸ”§":'<i class="ph ph-wrench"></i>'};let t=0;this.data.categories=this.data.categories.map(o=>{const n=e[o.icon];return n?(console.log(`âœ… Migrated local category ${o.name}: ${o.icon} â†’ ${n}`),t++,{...o,icon:n}):o}),t>0&&console.log(`âœ… Local migration completed! Updated ${t} categories.`)}async loadExpenses(e){const t=this.getCurrentUserId();if(!t)return[];try{console.log("ğŸ’³ Loading expenses for month:",e);const{data:o,error:n}=await f.from("expenses").select("*").eq("user_id",t).eq("month",e).order("created_at",{ascending:!1});if(n)return console.error("Error loading expenses:",n),[];const s=o||[];return this.data.expenses[e]=s,console.log("ğŸ’³ Expenses loaded:",s.length,"items"),s}catch(o){return console.error("Error in loadExpenses:",o),[]}}async addExpense(e){const t=this.getCurrentUserId();if(!t)return!1;try{const o=e.transactionDate?this.parseFormDate(e.transactionDate):this.parseFormDate(),n={user_id:t,description:e.description,amount:parseFloat(e.amount),category:e.category,transaction_date:o,month:e.month,installment:e.installment||1,total_installments:e.totalInstallments||1,original_id:e.originalId||null,original_amount:e.originalAmount||null,recurring:e.recurring||!1},{data:s,error:a}=await f.from("expenses").insert([n]).select();return a?(console.error("Error adding expense:",a),!1):(this.data.expenses[n.month]||(this.data.expenses[n.month]=[]),this.data.expenses[n.month].unshift(s[0]),!0)}catch(o){return console.error("Error in addExpense:",o),!1}}async deleteExpense(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{error:o}=await f.from("expenses").delete().eq("id",e).eq("user_id",t);return o?(console.error("Error deleting expense:",o),!1):(Object.keys(this.data.expenses).forEach(n=>{this.data.expenses[n]=this.data.expenses[n].filter(s=>s.id!==e)}),!0)}catch(o){return console.error("Error in deleteExpense:",o),!1}}async updateExpense(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const n={};t.description!==void 0&&(n.description=t.description),t.amount!==void 0&&(n.amount=parseFloat(t.amount)),t.category!==void 0&&(n.category=t.category),t.transaction_date!==void 0&&(n.transaction_date=this.parseFormDate(t.transaction_date)),t.month!==void 0&&(n.month=t.month),t.installment!==void 0&&(n.installment=t.installment),t.total_installments!==void 0&&(n.total_installments=t.total_installments),t.original_amount!==void 0&&(n.original_amount=t.original_amount),t.recurring!==void 0&&(n.recurring=!!t.recurring);const{data:s,error:a}=await f.from("expenses").update(n).eq("id",e).eq("user_id",o).select();if(a)return console.error("Error updating expense:",a),!1;const i=s==null?void 0:s[0];return i&&Object.keys(this.data.expenses).forEach(r=>{this.data.expenses[r]=this.data.expenses[r].map(l=>l.id===e?{...l,...i}:l)}),!0}catch(n){return console.error("Error in updateExpense:",n),!1}}getExpenses(e){return this.data.expenses[e]||[]}async loadIncome(e){const t=this.getCurrentUserId();if(!t)return{fixed:0,extra:0};try{console.log("ğŸ’° Loading income for month:",e);const{data:o,error:n}=await f.from("incomes").select("*").eq("user_id",t).eq("month",e).maybeSingle();if(n&&n.code!=="PGRST116")return console.error("Error loading income:",n),{fixed:0,extra:0};const s=o?{fixed:parseFloat(o.fixed_amount)||0,extra:parseFloat(o.extra_amount)||0}:{fixed:0,extra:0};return console.log("ğŸ’° Income loaded:",s),this.data.income[e]=s,s}catch(o){return console.error("Error in loadIncome:",o),{fixed:0,extra:0}}}async addFixedIncome(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const{data:n,error:s}=await f.from("incomes").upsert({user_id:o,month:e,fixed_amount:parseFloat(t),extra_amount:0},{onConflict:"user_id,month"}).select();return s?(console.error("Error adding fixed income:",s),!1):(n&&n.length>0&&(this.data.income[e]={fixed:parseFloat(n[0].fixed_amount)||0,extra:parseFloat(n[0].extra_amount)||0}),console.log("âœ… Fixed income added successfully"),!0)}catch(n){return console.error("Error in addFixedIncome:",n),!1}}async addExtraIncome(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const n={user_id:o,description:t.description,amount:parseFloat(t.amount),category:t.category,month:e},{data:s,error:a}=await f.from("extra_incomes").insert([n]).select();return a?(console.error("Error adding extra income:",a),!1):(this.data.extraIncomes[e]||(this.data.extraIncomes[e]=[]),this.data.extraIncomes[e].unshift(s[0]),console.log("âœ… Extra income added successfully"),!0)}catch(n){return console.error("Error in addExtraIncome:",n),!1}}async deleteExtraIncome(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{error:o}=await f.from("extra_incomes").delete().eq("id",e).eq("user_id",t);return o?(console.error("Error deleting extra income:",o),!1):(Object.keys(this.data.extraIncomes).forEach(n=>{this.data.extraIncomes[n]=(this.data.extraIncomes[n]||[]).filter(s=>s.id!==e)}),!0)}catch(o){return console.error("Error in deleteExtraIncome:",o),!1}}async updateExtraIncome(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const n={};t.description!==void 0&&(n.description=t.description),t.amount!==void 0&&(n.amount=parseFloat(t.amount)),t.category!==void 0&&(n.category=t.category),t.month!==void 0&&(n.month=t.month);const{data:s,error:a}=await f.from("extra_incomes").update(n).eq("id",e).eq("user_id",o).select();if(a)return console.error("Error updating extra income:",a),!1;const i=s==null?void 0:s[0];if(i){const r=i.month;this.data.extraIncomes[r]&&(this.data.extraIncomes[r]=this.data.extraIncomes[r].map(l=>l.id===e?{...l,...i}:l))}return!0}catch(n){return console.error("Error in updateExtraIncome:",n),!1}}getIncome(e){return this.data.income[e]||{fixed:0,extra:0}}async loadExtraIncomes(e){const t=this.getCurrentUserId();if(!t)return[];try{console.log("ğŸ’µ Loading extra incomes for month:",e);const{data:o,error:n}=await f.from("extra_incomes").select("*").eq("user_id",t).eq("month",e).order("created_at",{ascending:!1});if(n)return console.error("Error loading extra incomes:",n),[];const s=o||[];return this.data.extraIncomes[e]=s,console.log("ğŸ’µ Extra incomes loaded:",s.length,"items"),s}catch(o){return console.error("Error in loadExtraIncomes:",o),[]}}getExtraIncomes(e){return this.data.extraIncomes[e]||[]}async getTrendData(){const e=this.getCurrentUserId();if(!e)return[];try{const t=[],o=new Date;for(let s=5;s>=0;s--){const a=new Date(o.getFullYear(),o.getMonth()-s,1),i=`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}`;t.push(i)}const n=[];for(const s of t){const{data:a,error:i}=await f.from("expenses").select("amount").eq("user_id",e).eq("month",s);if(i){console.error("Error loading trend data for month:",s,i);continue}const r=(a||[]).reduce((c,d)=>c+parseFloat(d.amount),0),l=new Date(s+"-01").toLocaleDateString("es-ES",{month:"short"});n.push({month:l,amount:r})}return n}catch(t){return console.error("Error in getTrendData:",t),[]}}async loadGoals(){const e=this.getCurrentUserId();if(e)try{const{data:t,error:o}=await f.from("goals").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(o){console.error("Error loading goals:",o);return}this.data.goals=t||[]}catch(t){console.error("Error in loadGoals:",t)}}async addGoal(e){const t=this.getCurrentUserId();if(!t)return!1;try{const o={user_id:t,name:e.name,target_amount:parseFloat(e.targetAmount),current_amount:parseFloat(e.currentAmount)||0},{data:n,error:s}=await f.from("goals").insert([o]).select();return s?(console.error("Error adding goal:",s),!1):(this.data.goals.unshift(n[0]),!0)}catch(o){return console.error("Error in addGoal:",o),!1}}getGoals(){return this.data.goals}async updateGoal(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const{data:n,error:s}=await f.from("goals").update(t).eq("id",e).eq("user_id",o).select();if(s)return console.error("Error updating goal:",s),!1;const a=this.data.goals.findIndex(i=>i.id===e);return a!==-1&&(this.data.goals[a]={...this.data.goals[a],...n[0]}),console.log("âœ… Goal updated successfully"),!0}catch(n){return console.error("Error in updateGoal:",n),!1}}async addMoneyToGoal(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const n=parseFloat(t);if(isNaN(n)||n<=0)throw new Error("El monto debe ser un nÃºmero positivo");const s=this.data.goals.find(m=>m.id===e);if(!s)throw new Error("Objetivo no encontrado");const a=parseFloat(s.current_amount)||0,i=a+n,r=parseFloat(s.target_amount);if(i>r){const m=r-a;throw new Error(`Solo puedes agregar $${m.toFixed(2)} mÃ¡s para completar este objetivo`)}const{data:l,error:c}=await f.from("goals").update({current_amount:i}).eq("id",e).eq("user_id",o).select();if(c)throw console.error("Error adding money to goal:",c),new Error("Error al actualizar el objetivo");const d=this.data.goals.findIndex(m=>m.id===e);return d!==-1&&(this.data.goals[d]=l[0]),console.log("âœ… Money added to goal successfully"),i>=r?{success:!0,completed:!0,goal:l[0]}:{success:!0,completed:!1,goal:l[0]}}catch(n){throw console.error("Error in addMoneyToGoal:",n),n}}async deleteGoal(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{error:o}=await f.from("goals").delete().eq("id",e).eq("user_id",t);return o?(console.error("Error deleting goal:",o),!1):(this.data.goals=this.data.goals.filter(n=>n.id!==e),!0)}catch(o){return console.error("Error in deleteGoal:",o),!1}}async loadSpendingLimits(){const e=this.getCurrentUserId();if(e)try{const{data:t,error:o}=await f.from("spending_limits").select("*").eq("user_id",e);if(o){console.error("Error loading spending limits:",o);return}this.data.spendingLimits=t||[],console.log("ğŸš¦ Spending limits loaded:",this.data.spendingLimits.length,"items")}catch(t){console.error("Error in loadSpendingLimits:",t)}}getSpendingLimits(){return this.data.spendingLimits}async addSpendingLimit(e){const t=this.getCurrentUserId();if(!t)return!1;try{const o={user_id:t,category:e.category,amount:parseFloat(e.amount),warning_percentage:parseInt(e.warningPercentage)||80},{data:n,error:s}=await f.from("spending_limits").insert([o]).select();return s?(console.error("Error adding spending limit:",s),!1):(this.data.spendingLimits.unshift(n[0]),console.log("âœ… Spending limit added successfully"),!0)}catch(o){return console.error("Error in addSpendingLimit:",o),!1}}async deleteSpendingLimit(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{error:o}=await f.from("spending_limits").delete().eq("id",e).eq("user_id",t);return o?(console.error("Error deleting spending limit:",o),!1):(this.data.spendingLimits=this.data.spendingLimits.filter(n=>n.id!==e),!0)}catch(o){return console.error("Error in deleteSpendingLimit:",o),!1}}async updateExpense(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const{data:n,error:s}=await f.from("expenses").update({description:t.description,amount:parseFloat(t.amount),category:t.category,transaction_date:this.parseFormDate(t.transaction_date)}).eq("id",e).eq("user_id",o).select();return s?(console.error("Error updating expense:",s),!1):(Object.keys(this.data.expenses).forEach(a=>{this.data.expenses[a]=(this.data.expenses[a]||[]).map(i=>i.id===e?{...i,...n[0]}:i)}),!0)}catch(n){return console.error("Error in updateExpense:",n),!1}}async updateSpendingLimit(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const{data:n,error:s}=await f.from("spending_limits").update({category:t.category,amount:parseFloat(t.amount),warning_percentage:parseInt(t.warning_percentage||t.warningPercentage)||80}).eq("id",e).eq("user_id",o).select();return s?(console.error("Error updating spending limit:",s),!1):(this.data.spendingLimits=(this.data.spendingLimits||[]).map(a=>a.id===e?{...a,...n[0]}:a),!0)}catch(n){return console.error("Error in updateSpendingLimit:",n),!1}}async updateSpendingLimit(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{const n={};t.category!==void 0&&(n.category=t.category),t.amount!==void 0&&(n.amount=parseFloat(t.amount)),t.warningPercentage!==void 0&&(n.warning_percentage=parseInt(t.warningPercentage,10));const{data:s,error:a}=await f.from("spending_limits").update(n).eq("id",e).eq("user_id",o).select();if(a)return console.error("Error updating spending limit:",a),!1;const i=s==null?void 0:s[0];return i&&(this.data.spendingLimits=this.data.spendingLimits.map(r=>r.id===e?i:r)),!0}catch(n){return console.error("Error in updateSpendingLimit:",n),!1}}async loadAchievements(){const e=this.getCurrentUserId();if(e)try{const{data:t,error:o}=await f.from("achievements").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(o){console.error("Error loading achievements:",o);return}this.data.achievements=t||[]}catch(t){console.error("Error in loadAchievements:",t)}}getAchievements(){return this.data.achievements}async addCategory(e){const t=this.getCurrentUserId();if(console.log("ğŸ·ï¸ addCategory called with:",{categoryData:e,userId:t}),!t)return console.error("âŒ No userId found"),!1;try{console.log("ğŸ·ï¸ Preparing category data...");const o={user_id:t,name:e.name,icon:e.icon,color:e.color};console.log("ğŸ·ï¸ Category to insert:",o),console.log("ğŸ·ï¸ Inserting into Supabase...");const{data:n,error:s}=await f.from("categories").insert([o]).select();return console.log("ğŸ·ï¸ Supabase response:",{data:n,error:s}),s?(console.error("âŒ Supabase error adding category:",s),!1):!n||n.length===0?(console.error("âŒ No data returned from Supabase"),!1):(console.log("ğŸ·ï¸ Adding to local categories array..."),this.data.categories.push(n[0]),console.log("âœ… Category added successfully:",n[0]),console.log("ğŸ“Š Total categories now:",this.data.categories.length),!0)}catch(o){return console.error("âŒ Exception in addCategory:",o),!1}}async deleteCategory(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{error:o}=await f.from("categories").delete().eq("id",e).eq("user_id",t);return o?(console.error("Error deleting category:",o),!1):(this.data.categories=this.data.categories.filter(n=>n.id!==e),!0)}catch(o){return console.error("Error in deleteCategory:",o),!1}}exportDataToCSV(e="complete"){try{let t=[],o="",n=[];if(e==="complete"){n=["tipo","descripcion","monto","categoria","fecha","mes","cuota_actual","total_cuotas","monto_original","es_recurrente"];const l=[];Object.values(this.data.expenses).forEach(c=>{c.forEach(d=>{l.push(["gasto",d.description,d.amount,d.category,d.transaction_date,d.month,d.installment||1,d.total_installments||1,d.original_amount||d.amount,d.recurring?"si":"no"])})}),Object.entries(this.data.income).forEach(([c,d])=>{d.fixed>0&&l.push(["ingreso_fijo","Sueldo mensual",d.fixed,"sueldo",`${c}-01`,c,1,1,d.fixed,"si"])}),Object.values(this.data.extraIncomes).forEach(c=>{c.forEach(d=>{l.push(["ingreso_extra",d.description,d.amount,d.category,d.created_at?d.created_at.split("T")[0]:`${d.month}-01`,d.month,1,1,d.amount,"no"])})}),t=l,o="finzn_datos_completos.csv"}else if(e==="expenses"){const l=[];Object.values(this.data.expenses).forEach(c=>{l.push(...c)}),n=["descripcion","monto","categoria","fecha","mes","cuota_actual","total_cuotas","monto_original"],t=l.map(c=>[c.description,c.amount,c.category,c.transaction_date,c.month,c.installment||1,c.total_installments||1,c.original_amount||c.amount]),o="finzn_gastos.csv"}else if(e==="incomes"){const l=[];Object.entries(this.data.income).forEach(([c,d])=>{d.fixed>0&&l.push(["fijo",d.fixed,"Sueldo mensual",c,`${c}-01`])}),Object.values(this.data.extraIncomes).forEach(c=>{c.forEach(d=>{l.push(["extra",d.amount,d.description,d.month,d.created_at?d.created_at.split("T")[0]:`${d.month}-01`])})}),n=["tipo","monto","descripcion","mes","fecha"],t=l,o="finzn_ingresos.csv"}const s=[n,...t].map(l=>l.map(c=>`"${c}"`).join(",")).join(`
`),a=new Blob([s],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),r=URL.createObjectURL(a);return i.setAttribute("href",r),i.setAttribute("download",o),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),!0}catch(t){return console.error("Error exporting data:",t),!1}}async importDataFromCSV(e,t="expenses"){try{const n=(await e.text()).split(`
`).filter(c=>c.trim());if(n.length<2)throw new Error("El archivo CSV debe tener al menos una fila de datos");const s=n[0].split(",").map(c=>c.replace(/"/g,"").trim().toLowerCase()),a=n.slice(1);let i=0,r=0;console.log("ğŸ“¥ CSV Headers detected:",s);const l=this.detectCSVFormat(s);console.log("ğŸ“¥ Detected format:",l);for(const c of a)try{const d=this.parseCSVRow(c);if(d.length<2)continue;if(l==="complete")await this.processCompleteFormatRow(s,d),i++;else if(l==="expenses"||t==="expenses")await this.processExpenseRow(s,d),i++;else if(l==="incomes"||t==="incomes")await this.processIncomeRow(s,d),i++;else if(l==="bank")await this.processBankFormatRow(s,d),i++;else{const m=this.detectRowType(d);m==="expense"?(await this.processExpenseRow(s,d),i++):m==="income"&&(await this.processIncomeRow(s,d),i++)}}catch(d){console.error("Error importing row:",c,d),r++}return{imported:i,errors:r}}catch(o){throw console.error("Error importing CSV:",o),o}}parseCSVRow(e){const t=[];let o="",n=!1;for(let s=0;s<e.length;s++){const a=e[s];a==='"'?n=!n:a===","&&!n?(t.push(o.trim()),o=""):o+=a}return t.push(o.trim()),t.map(s=>s.replace(/"/g,""))}detectCSVFormat(e){const t=e.join(",").toLowerCase();return t.includes("tipo")&&t.includes("cuota_actual")&&t.includes("total_cuotas")?"complete":t.includes("fecha")&&(t.includes("debito")||t.includes("credito")||t.includes("movimiento"))?"bank":t.includes("gasto")||t.includes("categoria")||t.includes("descripcion")?"expenses":t.includes("ingreso")||t.includes("sueldo")?"incomes":"unknown"}detectRowType(e){if(e.length<2)return"unknown";const t=e[0].toLowerCase(),o=parseFloat(e[1]);return t.includes("gasto")||t.includes("expense")?"expense":t.includes("ingreso")||t.includes("income")||t.includes("sueldo")?"income":(o<0,"expense")}async processCompleteFormatRow(e,t){const o={};e.forEach((s,a)=>{o[s]=t[a]||""});const n=o.tipo||o.type||"";if(n.includes("gasto")||n.includes("expense")){const s={description:o.descripcion||o.description||"Gasto importado",amount:Math.abs(parseFloat(o.monto||o.amount||0)),category:o.categoria||o.category||"Otros",transactionDate:this.parseDate(o.fecha||o.date),month:o.mes||o.month||this.parseDate(o.fecha||o.date).substring(0,7),installment:parseInt(o.cuota_actual||o.installment||1),totalInstallments:parseInt(o.total_cuotas||o.total_installments||1),originalAmount:parseFloat(o.monto_original||o.original_amount)||Math.abs(parseFloat(o.monto||o.amount||0)),recurring:(o.es_recurrente||o.recurring||"").toLowerCase()==="si"||(o.es_recurrente||o.recurring||"").toLowerCase()==="true"};await this.addExpense(s)}else if(n.includes("ingreso")||n.includes("income")){const s=o.mes||o.month||this.parseDate(o.fecha||o.date).substring(0,7),a=Math.abs(parseFloat(o.monto||o.amount||0));if(n.includes("fijo")||n.includes("fixed"))await this.addFixedIncome(s,a);else{const i={description:o.descripcion||o.description||"Ingreso importado",amount:a,category:o.categoria||o.category||"other"};await this.addExtraIncome(s,i)}}}async processExpenseRow(e,t){const o={};e.forEach((s,a)=>{o[s]=t[a]||""});const n={description:o.descripcion||o.description||o.concepto||t[0]||"Gasto importado",amount:Math.abs(parseFloat(o.monto||o.amount||o.importe||t[1]||0)),category:o.categoria||o.category||o.tipo||"Otros",transactionDate:this.parseDate(o.fecha||o.date||o.transaction_date),month:o.mes||o.month||this.parseDate(o.fecha||o.date||o.transaction_date).substring(0,7),installment:parseInt(o.cuota_actual||o.installment||1),totalInstallments:parseInt(o.total_cuotas||o.total_installments||1),originalAmount:parseFloat(o.monto_original||o.original_amount)||Math.abs(parseFloat(o.monto||o.amount||t[1]||0)),recurring:!1};await this.addExpense(n)}async processIncomeRow(e,t){const o={};e.forEach((i,r)=>{o[i]=t[r]||""});const n=o.mes||o.month||this.parseDate(o.fecha||o.date).substring(0,7),s=Math.abs(parseFloat(o.monto||o.amount||o.importe||t[1]||0)),a=(o.tipo||o.type||t[0]||"").toLowerCase();if(a.includes("fijo")||a.includes("fixed")||a.includes("sueldo"))await this.addFixedIncome(n,s);else{const i={description:o.descripcion||o.description||o.concepto||"Ingreso importado",amount:s,category:o.categoria||o.category||"other"};await this.addExtraIncome(n,i)}}async processBankFormatRow(e,t){const o={};e.forEach((r,l)=>{o[r]=t[l]||""});const n=parseFloat(o.monto||o.amount||o.importe||t[1]||0),s=o.descripcion||o.description||o.concepto||o.detalle||t[0]||"Movimiento bancario",a=this.parseDate(o.fecha||o.date),i=a.substring(0,7);if(n<0){const r={description:s,amount:Math.abs(n),category:this.categorizeTransaction(s),transactionDate:a,month:i,installment:1,totalInstallments:1,recurring:!1};await this.addExpense(r)}else if(n>0){const r={description:s,amount:n,category:"other"};await this.addExtraIncome(i,r)}}parseFormDate(e){if(!e){const i=new Date,r=i.getFullYear(),l=String(i.getMonth()+1).padStart(2,"0"),c=String(i.getDate()).padStart(2,"0");return`${r}-${l}-${c}`}const t=e.toString().trim();if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const[i,r,l]=t.split("-"),c=parseInt(i),d=parseInt(r),m=parseInt(l);if(c>=1900&&c<=2100&&d>=1&&d<=12&&m>=1&&m<=31)return t}const o=new Date,n=o.getFullYear(),s=String(o.getMonth()+1).padStart(2,"0"),a=String(o.getDate()).padStart(2,"0");return`${n}-${s}-${a}`}parseDate(e){if(!e){const r=new Date,l=r.getFullYear(),c=String(r.getMonth()+1).padStart(2,"0"),d=String(r.getDate()).padStart(2,"0");return`${l}-${c}-${d}`}const t=e.toString().trim(),o=[/^(\d{4})-(\d{2})-(\d{2})$/,/^(\d{2})\/(\d{2})\/(\d{4})$/,/^(\d{2})-(\d{2})-(\d{4})$/,/^(\d{4})\/(\d{2})\/(\d{2})$/,/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,/^(\d{1,2})-(\d{1,2})-(\d{4})$/];for(let r=0;r<o.length;r++){const l=o[r],c=t.match(l);if(c){let d,m,u;r===0||r===3?(d=c[1],m=c[2].padStart(2,"0"),u=c[3].padStart(2,"0")):(u=c[1].padStart(2,"0"),m=c[2].padStart(2,"0"),d=c[3]);const g=parseInt(d),p=parseInt(m),h=parseInt(u);if(g>=1900&&g<=2100&&p>=1&&p<=12&&h>=1&&h<=31)return`${d}-${m}-${u}`}}try{if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const r=new Date(t+"T12:00:00");if(!isNaN(r.getTime())){const l=r.getFullYear(),c=String(r.getMonth()+1).padStart(2,"0"),d=String(r.getDate()).padStart(2,"0");return`${l}-${c}-${d}`}}catch(r){console.warn("Could not parse date:",e,r)}const n=new Date,s=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0");return`${s}-${a}-${i}`}categorizeTransaction(e){const t=e.toLowerCase();return t.includes("supermercado")||t.includes("market")||t.includes("grocery")?"Supermercado":t.includes("restaurant")||t.includes("comida")||t.includes("food")?"Comida":t.includes("transporte")||t.includes("uber")||t.includes("taxi")||t.includes("bus")?"Transporte":t.includes("farmacia")||t.includes("hospital")||t.includes("medic")?"Salud":t.includes("cine")||t.includes("teatro")||t.includes("entretenimiento")?"Ocio":t.includes("telefono")||t.includes("internet")||t.includes("luz")||t.includes("gas")?"Servicios":"Otros"}async loadBudgetInsights(){const e=this.getCurrentUserId();if(!e)return[];try{const{data:t,error:o}=await f.from("budget_insights").select("*").eq("user_id",e).eq("status","active").order("created_at",{ascending:!1});return o?(console.error("Error loading budget insights:",o),[]):t||[]}catch(t){return console.error("Error in loadBudgetInsights:",t),[]}}async saveBudgetInsight(e){const t=this.getCurrentUserId();if(!t)return!1;try{const o={user_id:t,budget_id:e.budget_id||null,insight_type:e.insight_type,title:e.title,description:e.description,data:e.data||{},confidence_score:e.confidence_score||null,status:"active"},{error:n}=await f.from("budget_insights").insert([o]);return n?(console.error("Error saving budget insight:",n),!1):!0}catch(o){return console.error("Error in saveBudgetInsight:",o),!1}}async loadBudgetAlerts(){const e=this.getCurrentUserId();if(!e)return[];try{const{data:t,error:o}=await f.from("budget_alerts").select("*").eq("user_id",e).eq("status","active").order("created_at",{ascending:!1});return o?(console.error("Error loading budget alerts:",o),[]):t||[]}catch(t){return console.error("Error in loadBudgetAlerts:",t),[]}}async saveBudgetAlert(e){const t=this.getCurrentUserId();if(!t)return!1;try{const o={user_id:t,budget_id:e.budget_id,alert_type:e.alert_type,severity:e.severity,title:e.title,message:e.message,category:e.category||null,data:e.data||{},status:"active"},{error:n}=await f.from("budget_alerts").insert([o]);return n?(console.error("Error saving budget alert:",n),!1):!0}catch(o){return console.error("Error in saveBudgetAlert:",o),!1}}async loadExpensesByPeriod(e,t){const o=this.getCurrentUserId();if(!o)return[];try{const{data:n,error:s}=await f.from("expenses").select("*").eq("user_id",o).gte("transaction_date",e).lte("transaction_date",t).order("transaction_date",{ascending:!1});return s?(console.error("Error loading expenses by period:",s),[]):n||[]}catch(n){return console.error("Error in loadExpensesByPeriod:",n),[]}}async loadIncomesByPeriod(e,t){const o=this.getCurrentUserId();if(!o)return[];try{const n=new Date(e),s=new Date(t),a=[],i=new Date(n.getFullYear(),n.getMonth(),1);for(;i<=s;){const m=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}`;a.push(m),i.setMonth(i.getMonth()+1)}const{data:r,error:l}=await f.from("incomes").select("*").eq("user_id",o).in("month",a);l&&console.error("Error loading incomes by period:",l);const{data:c,error:d}=await f.from("extra_incomes").select("*").eq("user_id",o).in("month",a);return d&&console.error("Error loading extra incomes by period:",d),{fixedIncomes:r||[],extraIncomes:c||[]}}catch(n){return console.error("Error in loadIncomesByPeriod:",n),{fixedIncomes:[],extraIncomes:[]}}}calculateBalance(e){const t=this.getExpenses(e),o=this.getIncome(e),n=this.getExtraIncomes(e),s=t.reduce((u,g)=>{const p=parseFloat(g.amount)||0;return u+p},0),a=parseFloat(o.fixed)||0,i=parseFloat(o.extra)||0,r=n.reduce((u,g)=>{const p=parseFloat(g.amount)||0;return u+p},0),l=a+i+r,c=l-s,d=t.filter(u=>u.total_installments>1).length;return{totalIncome:l,totalExpenses:s,available:c,installments:d}}getExpensesByCategory(e){const t=this.getExpenses(e),o={};return t.forEach(n=>{const s=n.category,a=parseFloat(n.amount)||0;o[s]=(o[s]||0)+a}),o}checkSpendingLimits(e){const t=this.getExpenses(e),o=this.getSpendingLimits(),n=[];return o.forEach(s=>{const r=t.filter(l=>l.category===s.category).reduce((l,c)=>l+parseFloat(c.amount),0)/s.amount*100;r>=100?n.push({type:"danger",category:s.category,message:`Has superado el lÃ­mite de ${s.category}`,percentage:r.toFixed(1)}):r>=s.warning_percentage&&n.push({type:"warning",category:s.category,message:`Te acercas al lÃ­mite de ${s.category}`,percentage:r.toFixed(1)})}),n}}class J{constructor(){this.patterns={email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,date:/^\d{4}-\d{2}-\d{2}$/,monthYear:/^\d{4}-\d{2}$/,currency:/^\d+(\.\d{1,2})?$/,percentage:/^\d+(\.\d{1,2})?$/,positiveInteger:/^\d+$/,alphanumeric:/^[a-zA-Z0-9\s\-_,.!?]+$/,description:/^[a-zA-Z0-9\s\-_,.!?Ã¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘Ã¼Ãœ]+$/},this.limits={amount:999999999,percentage:100,installments:60,descriptionLength:200,nameLength:100,categoryLength:50}}escapeHtml(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}sanitizeText(e){if(typeof e!="string")return"";const t=e.replace(/<[^>]*>/g,"");return this.escapeHtml(t.trim())}validateAmount(e){if(e==null||e==="")return{isValid:!1,error:"El monto es requerido",value:null};const t=parseFloat(e);return isNaN(t)?{isValid:!1,error:"El monto debe ser un nÃºmero vÃ¡lido",value:null}:t<0?{isValid:!1,error:"El monto no puede ser negativo",value:null}:t>this.limits.amount?{isValid:!1,error:`El monto no puede exceder $${this.limits.amount.toLocaleString()}`,value:null}:{isValid:!0,error:null,value:Math.round(t*100)/100}}validatePercentage(e){if(e==null||e==="")return{isValid:!0,error:null,value:0};const t=parseFloat(e);return isNaN(t)?{isValid:!1,error:"El porcentaje debe ser un nÃºmero vÃ¡lido",value:null}:t<0?{isValid:!1,error:"El porcentaje no puede ser negativo",value:null}:t>this.limits.percentage?{isValid:!1,error:`El porcentaje no puede exceder ${this.limits.percentage}%`,value:null}:{isValid:!0,error:null,value:t}}validateDate(e){if(!e||typeof e!="string")return{isValid:!1,error:"La fecha es requerida",value:null};if(!this.patterns.date.test(e))return{isValid:!1,error:"Formato de fecha invÃ¡lido (use YYYY-MM-DD)",value:null};const t=new Date(e);if(isNaN(t.getTime()))return{isValid:!1,error:"Fecha invÃ¡lida",value:null};const o=new Date;if(o.setFullYear(o.getFullYear()+10),t>o)return{isValid:!1,error:"La fecha no puede ser mÃ¡s de 10 aÃ±os en el futuro",value:null};const n=new Date;return n.setFullYear(n.getFullYear()-100),t<n?{isValid:!1,error:"La fecha no puede ser mÃ¡s de 100 aÃ±os en el pasado",value:null}:{isValid:!0,error:null,value:e}}validateDescription(e){if(!e||typeof e!="string")return{isValid:!1,error:"La descripciÃ³n es requerida",value:null};const t=e.trim();return t.length===0?{isValid:!1,error:"La descripciÃ³n no puede estar vacÃ­a",value:null}:t.length>this.limits.descriptionLength?{isValid:!1,error:`La descripciÃ³n no puede exceder ${this.limits.descriptionLength} caracteres`,value:null}:this.patterns.description.test(t)?{isValid:!0,error:null,value:this.sanitizeText(t)}:{isValid:!1,error:"La descripciÃ³n contiene caracteres no permitidos",value:null}}validateName(e){if(!e||typeof e!="string")return{isValid:!1,error:"El nombre es requerido",value:null};const t=e.trim();return t.length===0?{isValid:!1,error:"El nombre no puede estar vacÃ­o",value:null}:t.length>this.limits.nameLength?{isValid:!1,error:`El nombre no puede exceder ${this.limits.nameLength} caracteres`,value:null}:this.patterns.description.test(t)?{isValid:!0,error:null,value:this.sanitizeText(t)}:{isValid:!1,error:"El nombre contiene caracteres no permitidos",value:null}}validateCategory(e){if(!e||typeof e!="string")return{isValid:!1,error:"La categorÃ­a es requerida",value:null};const t=e.trim();return t.length===0?{isValid:!1,error:"La categorÃ­a no puede estar vacÃ­a",value:null}:t.length>this.limits.categoryLength?{isValid:!1,error:`La categorÃ­a no puede exceder ${this.limits.categoryLength} caracteres`,value:null}:{isValid:!0,error:null,value:this.sanitizeText(t)}}validateInstallmentCount(e){if(e==null||e==="")return{isValid:!0,error:null,value:1};const t=parseInt(e,10);return isNaN(t)?{isValid:!1,error:"El nÃºmero de cuotas debe ser un nÃºmero entero",value:null}:t<1?{isValid:!1,error:"El nÃºmero de cuotas debe ser al menos 1",value:null}:t>this.limits.installments?{isValid:!1,error:`El nÃºmero de cuotas no puede exceder ${this.limits.installments}`,value:null}:{isValid:!0,error:null,value:t}}validateEmail(e){if(!e||typeof e!="string")return{isValid:!1,error:"El email es requerido",value:null};const t=e.trim().toLowerCase();return this.patterns.email.test(t)?{isValid:!0,error:null,value:t}:{isValid:!1,error:"Formato de email invÃ¡lido",value:null}}validateMonthYear(e){if(!e||typeof e!="string")return{isValid:!1,error:"El mes/aÃ±o es requerido",value:null};if(!this.patterns.monthYear.test(e))return{isValid:!1,error:"Formato de mes/aÃ±o invÃ¡lido (use YYYY-MM)",value:null};const[t,o]=e.split("-").map(Number);return o<1||o>12?{isValid:!1,error:"Mes invÃ¡lido (debe ser 01-12)",value:null}:t<1900||t>2100?{isValid:!1,error:"AÃ±o invÃ¡lido",value:null}:{isValid:!0,error:null,value:e}}validateExpenseForm(e){const t=[],o={},n=this.validateDescription(e.description);n.isValid?o.description=n.value:t.push(n.error);const s=this.validateAmount(e.amount);s.isValid?o.amount=s.value:t.push(s.error);const a=this.validateCategory(e.category);a.isValid?o.category=a.value:t.push(a.error);const i=this.validateDate(e.transactionDate);if(i.isValid?o.transactionDate=i.value:t.push(i.error),e.hasInstallments){const r=this.validateInstallmentCount(e.installmentsCount);if(r.isValid?o.installmentsCount=r.value:t.push(r.error),e.installmentsInterest!==void 0&&e.installmentsInterest!==""){const l=this.validatePercentage(e.installmentsInterest);l.isValid?o.installmentsInterest=l.value:t.push(l.error)}}return{isValid:t.length===0,errors:t,sanitizedData:o}}validateIncomeForm(e){const t=[],o={};if(!e.type||!["fixed","extra"].includes(e.type)?t.push("Tipo de ingreso invÃ¡lido"):o.type=e.type,e.type==="extra"){const s=this.validateDescription(e.description);s.isValid?o.description=s.value:t.push(s.error)}else e.type==="fixed"&&(o.description="Ingreso Fijo");const n=this.validateAmount(e.amount);if(n.isValid?o.amount=n.value:t.push(n.error),e.date){const s=this.validateDate(e.date);s.isValid?o.date=s.value:t.push(s.error)}return{isValid:t.length===0,errors:t,sanitizedData:o}}validateBudgetForm(e){const t=[],o={},n=this.validateName(e.name);n.isValid?o.name=n.value:t.push(n.error);const s=this.validateCategory(e.category);s.isValid?o.category=s.value:t.push(s.error);const a=this.validateAmount(e.amount);a.isValid?o.amount=a.value:t.push(a.error);const i=this.validateDate(e.start_date);i.isValid?o.start_date=i.value:t.push("Fecha de inicio: "+i.error);const r=this.validateDate(e.end_date);if(r.isValid?o.end_date=r.value:t.push("Fecha de fin: "+r.error),o.start_date&&o.end_date){const l=new Date(o.start_date);new Date(o.end_date)<=l&&t.push("La fecha de fin debe ser posterior a la fecha de inicio")}return{isValid:t.length===0,errors:t,sanitizedData:o}}validateGoalForm(e){const t=[],o={},n=this.validateName(e.name);n.isValid?o.name=n.value:t.push(n.error);const s=this.validateAmount(e.targetAmount);s.isValid?o.targetAmount=s.value:t.push("Monto objetivo: "+s.error);const a=this.validateAmount(e.currentAmount||0);a.isValid?o.currentAmount=a.value:t.push("Monto actual: "+a.error);const i=this.validateDate(e.targetDate);if(!i.isValid)t.push("Fecha objetivo: "+i.error);else{o.targetDate=i.value;const r=new Date(i.value),l=new Date;l.setHours(0,0,0,0),r<=l&&t.push("La fecha objetivo debe ser en el futuro")}return o.currentAmount&&o.targetAmount&&o.currentAmount>o.targetAmount&&t.push("El monto actual no puede ser mayor al monto objetivo"),{isValid:t.length===0,errors:t,sanitizedData:o}}}const T=new J;class ee{constructor(){this.alertContainer=document.getElementById("alert-container"),this.mascotMessageQueue=[],this.isShowingMascotMessage=!1,this.currentMascotTimeout=null,this.setupMascotHoverBehavior()}escapeHtml(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}safeSetText(e,t){e&&typeof t=="string"&&(e.textContent=t)}formatDateSafe(e,t={}){if(!e)return"Sin fecha";if(e instanceof Date){if(isNaN(e.getTime()))return"Sin fecha";const s={...{day:"numeric",month:"short"},...t};return e.toLocaleDateString("es-ES",s)}const o=String(e);if(/^\d{4}-\d{2}-\d{2}$/.test(o)){const[n,s,a]=o.split("-"),i=new Date(parseInt(n),parseInt(s)-1,parseInt(a)),l={...{day:"numeric",month:"short"},...t};return i.toLocaleDateString("es-ES",l)}try{const n=new Date(o.includes("T")?o:o+"T12:00:00");if(isNaN(n.getTime()))throw new Error("Invalid date");const a={...{day:"numeric",month:"short"},...t};return n.toLocaleDateString("es-ES",a)}catch(n){return console.warn("Could not format date:",o,n),"Sin fecha"}}parseDateSafe(e){if(!e)return new Date;if(e instanceof Date)return isNaN(e.getTime())?new Date:e;const t=String(e);if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const[o,n,s]=t.split("-");return new Date(parseInt(o),parseInt(n)-1,parseInt(s))}try{const o=new Date(t.includes("T")?t:t+"T12:00:00");return isNaN(o.getTime())?new Date:o}catch(o){return console.warn("Could not parse date:",t,o),new Date}}setupMascotHoverBehavior(){document.addEventListener("DOMContentLoaded",()=>{this.initializeMascotHover()}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.initializeMascotHover()}):this.initializeMascotHover()}initializeMascotHover(){const e=document.querySelector(".chart-mascot-container"),t=document.getElementById("mascot-dynamic-message");if(!e||!t){setTimeout(()=>this.initializeMascotHover(),500);return}console.log("Initializing mascot hover behavior"),e.addEventListener("mouseenter",()=>{this.showHoverMessage(t)}),e.addEventListener("mouseleave",()=>{this.hideHoverMessage(t)})}showHoverMessage(e){if(!e)return;this.clearMascotMessage(e);const t=this.getContextualMascotMessages(),o=t[Math.floor(Math.random()*t.length)];this.isShowingMascotMessage=!0,e.textContent=o.text,e.className=`mascot-alert mascot-alert-${o.type}`,e.style.opacity="1",e.style.visibility="visible",e.style.pointerEvents="none",console.log("Mascot speaking on hover:",o.text)}hideHoverMessage(e){e&&(this.clearMascotMessage(e),console.log("Mascot returning to silent state"))}clearMascotMessage(e){e&&(this.currentMascotTimeout&&(clearTimeout(this.currentMascotTimeout),this.currentMascotTimeout=null),e.style.opacity="0",e.style.visibility="hidden",e.textContent="",e.className="mascot-alert",this.isShowingMascotMessage=!1)}getContextualMascotMessages(){const e=document.getElementById("balance-amount-new")||document.querySelector(".balance-amount"),t=e?e.textContent:"",o=parseFloat(t.replace(/[^0-9.-]/g,""))||0,n=[{text:"Â¡Hola! Soy tu asistente financiero personal",type:"info"},{text:"Â¿SabÃ­as que ahorrar el 20% de tus ingresos es ideal?",type:"info"},{text:"Revisa tus gastos regularmente para mantener el control",type:"info"},{text:"Â¡Cada peso ahorrado es un paso hacia tus metas!",type:"success"},{text:"Planifica tus compras para evitar gastos impulsivos",type:"info"}];return o<0?n.push({text:"Â¡Cuidado! EstÃ¡s gastando mÃ¡s de lo que ingresas",type:"warning"},{text:"Considera revisar tus gastos no esenciales",type:"warning"}):o>1e3&&n.push({text:"Â¡Excelente! Tienes un buen balance este mes",type:"success"},{text:"Â¡Buen trabajo! Considera invertir tus ahorros",type:"success"}),n}updateBalance(e){const t=document.getElementById("balance-amount-new"),o=document.getElementById("monthly-expenses-summary"),n=document.getElementById("income-summary"),s=document.getElementById("installments-count"),a=document.querySelector(".balance-amount"),i=document.querySelector(".new-balance-amount"),r=document.querySelector("#income-summary"),l=document.querySelector("#monthly-expenses-summary"),c=document.querySelector("#installments-count");console.log("ğŸ”„ Updating balance UI with:",e);const d=t||a||i;d&&(d.textContent=this.formatCurrency(e.available),console.log("ğŸ’° Balance amount updated:",e.available),t&&(t.style.color="#C8B6FF"));const m=o||l;m&&(m.textContent=this.formatCurrency(e.totalExpenses),l&&(m.style.setProperty("color","#C8B6FF","important"),m.setAttribute("data-color-forced","true")),console.log("ğŸ’³ Monthly expenses updated:",e.totalExpenses));const u=n||r;u&&(u.textContent=this.formatCurrency(e.totalIncome),r&&(u.style.setProperty("color","#C8B6FF","important"),u.setAttribute("data-color-forced","true")),console.log("ğŸ’µ Income amount updated:",e.totalIncome));const g=s||c;g&&(g.textContent=e.installments,console.log("ğŸ“Š Installments count updated:",e.installments))}updateExpensesList(e,t){const o=document.getElementById("expenses-list");if(o){if(o.innerHTML="",e.length===0){o.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon"><i class="ph ph-credit-card"></i></div>
          <h3>No hay gastos registrados</h3>
          <p>Comienza agregando tu primer gasto del mes</p>
          <button class="btn btn-primary" onclick="window.app.showAddExpenseModal()">
            <i class="ph ph-plus" aria-hidden="true"></i>
            Agregar Gasto
          </button>
        </div>
      `;return}e.forEach(n=>{const s=document.createElement("div");s.className="expense-item fade-in";const a=this.getCategoryInfo(n.category),i=n.transaction_date?this.formatDateSafe(n.transaction_date,{day:"numeric",month:"short"}):"Sin fecha",r=document.createElement("div");r.className="expense-icon",r.style.backgroundColor=`${a.color}20`,r.style.color=a.color,r.innerHTML=a.icon;const l=document.createElement("div");l.className="expense-details";const c=document.createElement("div");c.className="expense-description",c.textContent=n.description;const d=document.createElement("div");if(d.className="expense-category",d.textContent=`${a.name} â€¢ ${i}`,l.appendChild(c),l.appendChild(d),n.total_installments>1){const h=document.createElement("div");h.className="expense-installment",h.textContent=`Cuota ${n.installment} de ${n.total_installments}`,l.appendChild(h)}const m=document.createElement("div");m.className="expense-amount",m.textContent=this.formatCurrency(n.amount);const u=document.createElement("div");u.className="expense-actions";const g=document.createElement("button");g.className="expense-action-btn edit-btn js-expense-edit",g.setAttribute("data-id",n.id),g.setAttribute("title","Editar"),g.innerHTML='<i class="ph ph-pencil-simple" aria-hidden="true"></i>';const p=document.createElement("button");p.className="expense-action-btn delete-btn js-expense-delete",p.setAttribute("data-id",n.id),p.setAttribute("data-description",n.description),p.setAttribute("title","Eliminar"),p.innerHTML='<i class="ph ph-trash" aria-hidden="true"></i>',u.appendChild(g),u.appendChild(p),s.appendChild(r),s.appendChild(l),s.appendChild(m),s.appendChild(u),s.style.borderLeftColor=a.color,o.appendChild(s)})}}updateRecentTransactions(e,t,o){const n=document.getElementById("recent-transactions-list");if(!n)return;n.innerHTML="";const s=[];if(e.forEach(i=>{s.push({type:"expense",id:i.id,description:i.description,amount:-i.amount,date:this.parseDateSafe(i.transaction_date),category:i.category})}),t&&t.fixed>0){const i=new Date;i.setDate(1),s.push({type:"income",id:"fixed-income",description:"Salario fijo",amount:t.fixed,date:i,category:"income"})}o.forEach(i=>{s.push({type:"income",id:i.id,description:i.description,amount:i.amount,date:this.parseDateSafe(i.created_at||i.date),category:"income"})});const a=s.sort((i,r)=>r.date-i.date).slice(0,5);if(a.length===0){n.innerHTML=`
        <div class="empty-state-small">
          <i class="ph ph-list-dashes"></i>
          <span>No hay transacciones recientes</span>
        </div>
      `;return}a.forEach(i=>{const r=document.createElement("div");r.className="recent-transaction-item";const l=i.type==="income",c=l?{icon:'<i class="ph ph-arrow-up"></i>',color:"#22c55e"}:this.getCategoryInfo(i.category),d=this.formatDateSafe(i.date,{day:"numeric",month:"short"}),m=document.createElement("div");m.className="transaction-icon",m.style.backgroundColor=`${c.color}20`,m.style.color=c.color,m.innerHTML=c.icon;const u=document.createElement("div");u.className="transaction-details";const g=document.createElement("div");g.className="transaction-description",g.textContent=i.description;const p=document.createElement("div");p.className="transaction-date",p.textContent=d,u.appendChild(g),u.appendChild(p);const h=document.createElement("div");h.className=`transaction-amount ${l?"income":"expense"}`,h.textContent=`${l?"+":""}${this.formatCurrency(Math.abs(i.amount))}`,r.appendChild(m),r.appendChild(u),r.appendChild(h),n.appendChild(r)})}updateGoalsList(e){const t=document.getElementById("goals-list");if(t){if(t.innerHTML="",e.length===0){t.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon"><i class="ph ph-target"></i></div>
          <h3>No tienes objetivos de ahorro</h3>
          <p>Establece metas para motivarte a ahorrar</p>
          <button class="btn btn-primary" data-action="create-goal">
            <i class="ph ph-plus" aria-hidden="true"></i>
            Crear Objetivo
          </button>
        </div>
      `;return}e.forEach(o=>{const n=o.current_amount/o.target_amount*100,s=document.createElement("div");s.className="goal-item fade-in";const a=document.createElement("div");a.className="goal-header";const i=document.createElement("div");i.className="goal-name",i.textContent=o.name;const r=document.createElement("div");r.className="goal-amount",r.textContent=`${this.formatCurrency(o.current_amount)} / ${this.formatCurrency(o.target_amount)}`,a.appendChild(i),a.appendChild(r);const l=document.createElement("div");l.className="goal-progress";const c=document.createElement("div");c.className="progress-bar";const d=document.createElement("div");d.className="progress-fill",d.style.width=`${Math.min(n,100)}%`;const m=document.createElement("div");m.className="progress-text",m.textContent=`${n.toFixed(1)}%`,c.appendChild(d),l.appendChild(c),l.appendChild(m);const u=document.createElement("div");u.className="goal-actions";const g=document.createElement("button");g.className="btn btn-secondary btn-sm",g.setAttribute("data-action","add-money"),g.setAttribute("data-goal-id",o.id),g.innerHTML='<i class="ph ph-plus-circle" aria-hidden="true"></i> Agregar';const p=document.createElement("button");p.className="btn btn-secondary btn-sm",p.setAttribute("data-action","edit-goal"),p.setAttribute("data-goal-id",o.id),p.innerHTML='<i class="ph ph-pencil-simple" aria-hidden="true"></i> Editar';const h=document.createElement("button");h.className="btn btn-danger btn-sm",h.setAttribute("data-action","delete-goal"),h.setAttribute("data-goal-id",o.id),h.setAttribute("data-goal-name",o.name),h.innerHTML='<i class="ph ph-trash" aria-hidden="true"></i> Eliminar',u.appendChild(g),u.appendChild(p),u.appendChild(h),s.appendChild(a),s.appendChild(l),s.appendChild(u),t.appendChild(s)})}}updateSpendingLimitsList(e,t){const o=document.getElementById("spending-limits-summary"),n=document.getElementById("category-limits-display"),s=document.getElementById("total-limits-count");if(console.log("ğŸš¦ Updating spending limits UI:",{limits:e.length,expenses:t.length}),s&&(s.textContent=e.length),n&&this.updateCategoryLimitsDisplay(e,t),o&&(o.innerHTML=""),e.length===0){o&&(o.innerHTML=`
          <div class="empty-state">
            <div class="empty-icon"><i class="ph ph-warning"></i></div>
            <h3>No tienes lÃ­mites de gasto configurados</h3>
            <p>Establece lÃ­mites para controlar mejor tus gastos</p>
            <button class="btn btn-primary" onclick="window.app.showAddSpendingLimitModal()">
              <i class="ph ph-plus" aria-hidden="true"></i>
              Agregar LÃ­mite
            </button>
          </div>
        `);return}e.forEach(a=>{const r=t.filter(m=>m.category===a.category).reduce((m,u)=>m+parseFloat(u.amount),0),l=r/a.amount*100;let c="safe",d="";if(l>=100?(c="danger",d=`
          <div class="functional-semaphore">
            <div class="semaphore-light red active"></div>
            <div class="semaphore-light yellow"></div>
            <div class="semaphore-light green"></div>
          </div>
        `):l>=a.warning_percentage?(c="warning",d=`
          <div class="functional-semaphore">
            <div class="semaphore-light red"></div>
            <div class="semaphore-light yellow active"></div>
            <div class="semaphore-light green"></div>
          </div>
        `):(c="safe",d=`
          <div class="functional-semaphore">
            <div class="semaphore-light red"></div>
            <div class="semaphore-light yellow"></div>
            <div class="semaphore-light green active"></div>
          </div>
        `),console.log("ğŸš¦ Creating limit item:",{category:a.category,percentage:l,statusClass:c}),o){const m=document.createElement("div");m.className=`spending-limit-summary-item ${c}`,m.innerHTML=`
          ${d}
          <div class="limit-category-info">
            <span class="limit-category-name">${a.category}</span>
          </div>
          <div class="limit-progress-info">
            <div class="limit-amount-info">${this.formatCurrency(r)} / ${this.formatCurrency(a.amount)}</div>
            <div class="limit-percentage">${l.toFixed(1)}%</div>
          </div>
          <div class="limit-actions">
  <button class="expense-action-btn edit-btn js-limit-edit" 
          data-id="${a.id}" 
          title="Editar lÃ­mite">
    <i class="ph ph-pencil-simple" aria-hidden="true"></i>
  </button>
  <button class="expense-action-btn delete-btn js-limit-delete" 
          data-id="${a.id}" 
          title="Eliminar lÃ­mite">
    <i class="ph ph-trash" aria-hidden="true"></i>
  </button>
</div>
        `,o.appendChild(m)}}),console.log("âœ… Spending limits UI updated successfully")}updateCategoryLimitsDisplay(e,t){var i,r;const o=document.getElementById("category-limits-display");if(!o)return;if(o.innerHTML="",e.length===0){o.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon"><i class="ph ph-money"></i></div>
          <h3>No hay lÃ­mites de gasto configurados</h3>
          <p>Establece lÃ­mites presupuestarios para controlar mejor tus gastos por categorÃ­a</p>
          <button class="btn btn-primary" onclick="window.app.showAddSpendingLimitModal()">
            <i class="ph ph-plus" aria-hidden="true"></i>
            Configurar Primer LÃ­mite
          </button>
        </div>
      `;return}const n=((r=(i=window.app)==null?void 0:i.data)==null?void 0:r.getCategories())||[],s=new Set(e.map(l=>l.category));e.forEach(l=>{const d=t.filter(y=>y.category===l.category).reduce((y,b)=>y+parseFloat(b.amount),0),m=d/l.amount*100,u=l.amount-d;let g="safe",p="ğŸŸ¢",h="Dentro del lÃ­mite";m>=100?(g="danger",p="ğŸ”´",h="LÃ­mite superado"):m>=l.warning_percentage&&(g="warning",p="ğŸŸ¡",h="Cerca del lÃ­mite");const E=this.getCategoryInfo(l.category),w=document.createElement("div");w.className=`category-limit-item ${g}`,w.innerHTML=`
        <div class="category-limit-header">
          <div class="category-info-display">
            <div class="category-icon-large">${E.icon}</div>
            <div class="category-details">
              <h4 class="category-name">${l.category}</h4>
              <div class="category-status">
                ${p} ${h}
              </div>
            </div>
          </div>
         <div class="limit-actions">
  <button class="expense-action-btn edit-btn js-limit-edit" 
          data-id="${l.id}" 
          title="Editar lÃ­mite">
    <i class="ph ph-pencil-simple" aria-hidden="true"></i>
  </button>
  <button class="expense-action-btn delete-btn js-limit-delete" 
          data-id="${l.id}" 
          title="Eliminar lÃ­mite">
    <i class="ph ph-trash" aria-hidden="true"></i>
  </button>
</div>
        </div>
        
        <div class="limit-details">
          <div class="limit-amounts">
            <div class="limit-amount-row">
              <span class="limit-label">LÃ­mite Mensual:</span>
              <span class="limit-value primary">${this.formatCurrency(l.amount)}</span>
            </div>
            <div class="limit-amount-row">
              <span class="limit-label">Gastado:</span>
              <span class="limit-value ${g}">${this.formatCurrency(d)}</span>
            </div>
            <div class="limit-amount-row">
              <span class="limit-label">Disponible:</span>
              <span class="limit-value ${u>=0?"positive":"negative"}">${this.formatCurrency(u)}</span>
            </div>
          </div>
          
          <div class="limit-progress">
            <div class="progress-bar-limit">
              <div class="progress-fill-limit ${g}" style="width: ${Math.min(m,100)}%"></div>
            </div>
            <div class="progress-text-limit">${m.toFixed(1)}% utilizado</div>
          </div>
          
          <div class="limit-config">
            <div class="config-item">
              <span class="config-label">PerÃ­odo:</span>
              <span class="config-value">Mensual</span>
            </div>
            <div class="config-item">
              <span class="config-label">Alerta al:</span>
              <span class="config-value">${l.warning_percentage}%</span>
            </div>
          </div>
        </div>
      `,o.appendChild(w)});const a=n.filter(l=>!s.has(l.name));if(a.length>0){const l=document.createElement("div");l.className="no-limits-section",l.innerHTML=`
        <div class="section-divider">
          <h4>ğŸ“‹ CategorÃ­as sin lÃ­mites configurados</h4>
        </div>
      `,a.forEach(c=>{const d=document.createElement("div");d.className="category-no-limit-item",d.innerHTML=`
          <div class="category-info-display">
            <div class="category-icon-large">${c.icon}</div>
            <div class="category-details">
              <h4 class="category-name">${c.name}</h4>
              <div class="category-status no-limit">
                âšª Sin lÃ­mite establecido
              </div>
            </div>
          </div>
          <div class="no-limit-actions">
            <button class="btn btn-secondary btn-sm" onclick="window.app.showAddSpendingLimitModal('${c.name}')">
              <i class="ph ph-plus" aria-hidden="true"></i>
              Configurar LÃ­mite
            </button>
          </div>
        `,l.appendChild(d)}),o.appendChild(l)}}updateCategoriesSelect(e,t){const o=document.getElementById(t);o&&(o.innerHTML='<option value="">Selecciona una categorÃ­a</option>',e.forEach(n=>{const s=document.createElement("option");s.value=n.name,s.textContent=`${n.name}`,o.appendChild(s)}))}showAlert(e,t="info"){const o=document.createElement("div");o.className=`alert alert-${t}`,o.textContent=e,this.alertContainer.appendChild(o),setTimeout(()=>o.classList.add("show"),100),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},5e3)}showMascotAlert(e,t="info"){console.log("Mascot alert suppressed (hover-only mode):",e)}formatCurrency(e){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}getCategoryInfo(e){if(console.log("ğŸ” getCategoryInfo called for:",e),window.app&&window.app.data){const o=window.app.data.getCategories();console.log("ğŸ“Š Available categories:",o.map(s=>({name:s.name,color:s.color})));const n=o.find(s=>s.name===e);if(n)return console.log("âœ… Found category:",{name:n.name,color:n.color}),{name:n.name,icon:n.icon,color:n.color};console.log("âŒ Category not found in database categories")}else console.log("âŒ No app.data available");return{Comida:{icon:'<i class="ph ph-fork-knife"></i>',color:"#ef4444"},Transporte:{icon:'<i class="ph ph-car"></i>',color:"#3b82f6"},Salud:{icon:'<i class="ph ph-heart-straight"></i>',color:"#10b981"},Ocio:{icon:'<i class="ph ph-game-controller"></i>',color:"#f59e0b"},Supermercado:{icon:'<i class="ph ph-shopping-cart"></i>',color:"#14b8a6"},Servicios:{icon:'<i class="ph ph-house"></i>',color:"#6366f1"},Ropa:{icon:'<i class="ph ph-t-shirt"></i>',color:"#ec4899"},EducaciÃ³n:{icon:'<i class="ph ph-book"></i>',color:"#8b5cf6"},TecnologÃ­a:{icon:'<i class="ph ph-laptop"></i>',color:"#06b6d4"},Deportes:{icon:'<i class="ph ph-soccer-ball"></i>',color:"#84cc16"},Viajes:{icon:'<i class="ph ph-airplane"></i>',color:"#f97316"},PedidosYa:{icon:'<img src="/assets/svg/pedidosya-logo.svg" alt="PedidosYa" width="20" height="20" style="display: inline-block;">',color:"#dc2626"},Otros:{icon:'<i class="ph ph-dots-three"></i>',color:"#9ca3af"}}[e]||{name:e,icon:'<i class="ph ph-package"></i>',color:"#9ca3af"}}updateIncomeDetails(e,t=[]){const o=document.getElementById("all-incomes-list"),n=document.getElementById("incomes-indicator"),s=document.getElementById("income-summary");console.log("ğŸ’° Updating income details:",{income:e,extraIncomes:t.length});let a=0;e.fixed>0&&a++,t.length>0&&(a+=t.length);const i=t.reduce((l,c)=>l+parseFloat(c.amount),0),r=e.fixed+e.extra+i;if(console.log("ğŸ’° Income calculation:",{fixed:e.fixed,extraFromTable:e.extra,extraFromIncomes:i,total:r,count:a}),s&&(s.textContent=this.formatCurrency(r),console.log("ğŸ’° Income summary updated:",r)),n){const l=n.querySelector(".indicator-count");l&&(l.textContent=a),n.classList.remove("hidden"),n.classList.add("visible"),n.style.display="flex",n.style.visibility="visible",n.style.opacity="1",console.log("ğŸ’° Income indicator updated:",a)}if(o)if(o.innerHTML="",a===0)o.innerHTML=`
          <div class="empty-state">
            <p>No hay ingresos registrados este mes</p>
          </div>
        `;else{if(e.fixed>0){const l=document.createElement("div");l.className="income-list-item fixed",l.innerHTML=`
            <div class="income-item-details">
              <div class="income-item-type"><i class="ph ph-coins"></i> Ingreso Fijo</div>
              <div class="income-item-description">Sueldo mensual</div>
            </div>
            <div class="income-item-amount">${this.formatCurrency(e.fixed)}</div>
            <div class="income-item-actions">
              <button class="btn btn-sm btn-secondary edit-income-btn" data-type="fixed">
                <i class="ph ph-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger delete-income-btn" data-type="fixed">
                <i class="ph ph-trash"></i> Eliminar
              </button>
            </div>
          `,o.appendChild(l)}t.forEach(l=>{const c=document.createElement("div");c.className="income-list-item extra",c.innerHTML=`
            <div class="income-item-details">
              <div class="income-item-type"><i class="ph ph-money"></i> ${l.category}</div>
              <div class="income-item-description">${l.description}</div>
              <div class="income-item-date">${new Date(l.created_at).toLocaleDateString("es-ES")}</div>
            </div>
            <div class="income-item-amount">${this.formatCurrency(l.amount)}</div>
            <div class="income-item-actions">
              <button class="btn btn-sm btn-secondary edit-income-btn" data-id="${l.id}" data-type="extra">
                <i class="ph ph-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger delete-income-btn" data-id="${l.id}" data-type="extra">
                <i class="ph ph-trash"></i> Eliminar
              </button>
            </div>
          `,o.appendChild(c)})}this.setupIncomeActionListeners(),console.log("âœ… Income details updated successfully")}updateIncomeList(e,t){const o=document.getElementById("income-list");if(!o)return;console.log("ğŸ’° Updating income list in transactions tab:",{income:t,extraIncomes:e.length}),o.innerHTML="";let n=0;if(t.fixed>0&&n++,n+=e.length,n===0){o.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon"><i class="ph ph-money"></i></div>
          <h3>No hay ingresos este mes</h3>
          <p>Los ingresos que agregues aparecerÃ¡n aquÃ­</p>
        </div>
      `;return}if(t.fixed>0){const s=document.createElement("div");s.className="income-list-item fixed",s.innerHTML=`
        <div class="income-item-details">
          <div class="income-item-type"><i class="ph ph-coins"></i> Ingreso Fijo</div>
          <div class="income-item-description">Sueldo mensual</div>
        </div>
        <div class="income-item-amount">${this.formatCurrency(t.fixed)}</div>
        <div class="income-item-actions">
          <button class="btn btn-sm btn-secondary edit-income-btn" data-type="fixed">
            <i class="ph ph-pencil"></i> Editar
          </button>
          <button class="btn btn-sm btn-danger delete-income-btn" data-type="fixed">
            <i class="ph ph-trash"></i> Eliminar
          </button>
        </div>
      `,o.appendChild(s)}e.forEach(s=>{const a=document.createElement("div");a.className="income-list-item extra",a.innerHTML=`
        <div class="income-item-details">
          <div class="income-item-type"><i class="ph ph-money"></i> ${s.category}</div>
          <div class="income-item-description">${s.description}</div>
          <div class="income-item-date">${new Date(s.created_at).toLocaleDateString("es-ES")}</div>
        </div>
        <div class="income-item-amount">${this.formatCurrency(s.amount)}</div>
        <div class="income-item-actions">
          <button class="btn btn-sm btn-secondary edit-income-btn" data-id="${s.id}" data-type="extra">
            <i class="ph ph-pencil"></i> Editar
          </button>
          <button class="btn btn-sm btn-danger delete-income-btn" data-id="${s.id}" data-type="extra">
            <i class="ph ph-trash"></i> Eliminar
          </button>
        </div>
      `,o.appendChild(a)}),this.setupIncomeActionListeners(),console.log("âœ… Income list updated successfully")}updateInstallmentsList(e){const t=document.getElementById("installments-list");if(!t)return;console.log("ğŸ“Š Updating installments list with expenses:",e.length);const o=e.filter(n=>n.total_installments>1);if(console.log("ğŸ“Š Found installments:",o.length),t.innerHTML="",o.length===0){t.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon"><i class="ph ph-chart-pie"></i></div>
          <h3>No hay cuotas activas este mes</h3>
          <p>Los gastos en cuotas aparecerÃ¡n aquÃ­</p>
        </div>
      `;return}o.forEach(n=>{const s=document.createElement("div");s.className="installment-item fade-in";const a=this.getCategoryInfo(n.category),i=n.transaction_date?this.formatDateSafe(n.transaction_date,{day:"numeric",month:"short"}):"Sin fecha";s.innerHTML=`
        <div class="installment-details">
          <div class="installment-description">
            <span class="installment-icon" style="color: ${a.color}; background-color: ${a.color}20; padding: 4px; border-radius: 4px; display: inline-block; margin-right: 8px;">${a.icon}</span>
            ${n.description}
          </div>
          <div class="installment-info">${a.name} â€¢ ${i}</div>
          <div class="installment-progress">Cuota ${n.installment} de ${n.total_installments}</div>
        </div>
        <div class="installment-amount">
          ${this.formatCurrency(n.amount)}
          ${n.original_amount?`<div class="installment-original">Total: ${this.formatCurrency(n.original_amount)}</div>`:""}
        </div>
      `,s.style.borderLeftColor=a.color,t.appendChild(s)}),console.log("âœ… Installments list updated successfully")}updateCategoriesManagementList(e){const t=document.getElementById("categories-management-list");if(t){if(t.innerHTML="",e.length===0){t.innerHTML=`
        <div class="empty-state">
          <p>No hay categorÃ­as personalizadas</p>
        </div>
      `;return}e.forEach(o=>{const n=document.createElement("div");n.className="category-management-item",n.style.borderLeftColor=o.color,n.innerHTML=`
        <div class="category-info">
          <div class="category-icon-display" style="background-color: ${o.color}20;">
            ${o.icon}
          </div>
          <div class="category-name-display">${o.name}</div>
        </div>
        <div class="category-actions">
          <button class="expense-action-btn delete-btn delete-category-btn" data-category-id="${o.id}" title="Eliminar">
            <i class="ph ph-trash" aria-hidden="true"></i>
          </button>
        </div>
      `,t.appendChild(n)})}}clearForm(e){const t=document.getElementById(e);t&&t.reset()}setFormData(e,t){const o=document.getElementById(e);o&&Object.keys(t).forEach(n=>{const s=o.querySelector(`[name="${n}"]`);s&&(s.value=t[n])})}getFormData(e){const t=document.getElementById(e);if(!t)return{};const o=new FormData(t),n={};for(let[s,a]of o.entries())n[s]=a;return n}showEditGoalModal(e){console.log("âœï¸ Showing edit goal modal for:",e);const t=document.getElementById("edit-goal-name"),o=document.getElementById("edit-goal-target"),n=document.getElementById("edit-goal-current"),s=document.getElementById("edit-goal-modal");t&&(t.value=e.name),o&&(o.value=e.target_amount),n&&(n.value=e.current_amount),s&&(s.dataset.goalId=e.id),window.app&&window.app.modals&&window.app.modals.show("edit-goal-modal")}showAddMoneyModal(e){console.log("ğŸ’° Showing add money modal for:",e);const t=document.getElementById("add-money-goal-name"),o=document.getElementById("add-money-goal-progress"),n=document.getElementById("add-money-max-amount"),s=document.getElementById("add-money-amount"),a=document.getElementById("add-money-modal"),i=e.current_amount/e.target_amount*100,r=e.target_amount-e.current_amount;t&&(t.textContent=e.name),o&&(o.textContent=`${this.formatCurrency(e.current_amount)} / ${this.formatCurrency(e.target_amount)} (${i.toFixed(1)}%)`),n&&(n.textContent=`MÃ¡ximo disponible: ${this.formatCurrency(r)}`),s&&(s.max=r,s.value=""),a&&(a.dataset.goalId=e.id),window.app&&window.app.modals&&window.app.modals.show("add-money-modal")}updateBudgetsList(e,t=[]){const o=document.getElementById("budgets-list"),n=document.getElementById("budgets-count");if(o){if(console.log("ğŸ’° Updating budgets list:",e.length,"budgets"),n&&(n.textContent=e.length),this.loadAIBudgetInsights(),o.innerHTML="",e.length===0){o.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon"><i class="ph ph-money"></i></div>
          <h3>No tienes presupuestos configurados</h3>
          <p>Crea tu primer presupuesto para controlar mejor tus gastos</p>
          <button class="btn btn-primary" data-action="create-budget">
            <i class="ph ph-plus" aria-hidden="true"></i>
            Crear Presupuesto
          </button>
        </div>
      `;return}e.forEach(s=>{const a=window.app.budget.calculateBudgetProgress(s,t),i=document.createElement("div");i.className="budget-card fade-in";const r=this.getCategoryInfo(s.category),l=new Date(s.start_date).toLocaleDateString("es-ES",{day:"numeric",month:"short"}),c=new Date(s.end_date).toLocaleDateString("es-ES",{day:"numeric",month:"short"});let d="safe",m="ğŸŸ¢",u="En control";a.status==="exceeded"?(d="exceeded",m="ğŸ”´",u="Superado"):a.status==="warning"?(d="warning",m="ğŸŸ¡",u="Cerca del lÃ­mite"):a.status==="caution"&&(d="caution",m="ğŸŸ ",u="PrecauciÃ³n"),i.innerHTML=`
        <div class="budget-card-header">
          <div class="budget-info">
            <div class="budget-category">
              <span class="category-icon">${r.icon}</span>
              <span class="category-name">${s.category}</span>
            </div>
            <div class="budget-name">${s.name}</div>
            <div class="budget-period">${l} - ${c}</div>
          </div>
          <div class="budget-status ${d}">
            <span class="status-icon">${m}</span>
            <span class="status-text">${u}</span>
          </div>
        </div>
        
        <div class="budget-progress-section">
          <div class="budget-amounts">
            <div class="amount-spent">
              <span class="amount-label">Gastado:</span>
              <span class="amount-value ${d}">${this.formatCurrency(a.spent)}</span>
            </div>
            <div class="amount-limit">
              <span class="amount-label">LÃ­mite:</span>
              <span class="amount-value">${this.formatCurrency(s.amount)}</span>
            </div>
            <div class="amount-remaining">
              <span class="amount-label">Disponible:</span>
              <span class="amount-value ${a.remaining>=0?"positive":"negative"}">${this.formatCurrency(a.remaining)}</span>
            </div>
          </div>
          
          <div class="budget-progress-bar">
            <div class="progress-bar-budget">
              <div class="progress-fill-budget ${d}" style="width: ${a.percentage}%"></div>
            </div>
            <div class="progress-text-budget">${a.percentage.toFixed(1)}% utilizado</div>
          </div>
          
          <div class="budget-details">
            <div class="detail-item">
              <span class="detail-label">Transacciones:</span>
              <span class="detail-value">${a.expenseCount}</span>
            </div>
            ${s.ai_recommended?'<div class="ai-badge"><i class="ph ph-robot" aria-hidden="true"></i> Recomendado por IA</div>':""}
          </div>
        </div>
        
        <div class="budget-actions">
          <button class="btn btn-secondary btn-sm" data-action="edit-budget" data-budget-id="${s.id}">
            <i class="ph ph-pencil-simple" aria-hidden="true"></i> Editar
          </button>
          <button class="btn btn-danger btn-sm" data-action="delete-budget" data-budget-id="${s.id}" data-budget-name="${s.name}">
            <i class="ph ph-trash" aria-hidden="true"></i> Eliminar
          </button>
          <button class="btn btn-primary btn-sm" data-action="analyze-budget" data-budget-id="${s.id}">
            <i class="ph ph-robot" aria-hidden="true"></i> Analizar
          </button>
        </div>
      `,i.style.borderLeftColor=r.color,o.appendChild(i)})}}showAddBudgetModal(){console.log("ğŸ’° Show add budget modal");const e=new Date,t=new Date(e.getFullYear(),e.getMonth()+1,0),o=document.getElementById("budget-start-date"),n=document.getElementById("budget-end-date");if(o&&(o.value=e.toISOString().split("T")[0]),n&&(n.value=t.toISOString().split("T")[0]),window.app&&window.app.data){const s=window.app.data.getCategories();this.updateCategoriesSelect(s,"budget-category")}window.app&&window.app.modals&&window.app.modals.show("add-budget-modal")}showEditBudgetModal(e){if(console.log("âœï¸ Show edit budget modal for:",e),!window.app||!window.app.budget)return;const t=window.app.budget.getBudgets().find(l=>l.id===e);if(!t){this.showAlert("Presupuesto no encontrado","error");return}const o=document.getElementById("edit-budget-name"),n=document.getElementById("edit-budget-category"),s=document.getElementById("edit-budget-amount"),a=document.getElementById("edit-budget-start-date"),i=document.getElementById("edit-budget-end-date"),r=document.getElementById("edit-budget-modal");if(o&&(o.value=t.name),s&&(s.value=t.amount),a&&(a.value=t.start_date),i&&(i.value=t.end_date),r&&(r.dataset.budgetId=t.id),window.app&&window.app.data){const l=window.app.data.getCategories();this.updateCategoriesSelect(l,"edit-budget-category"),n&&setTimeout(()=>{n.value=t.category},100)}window.app&&window.app.modals&&window.app.modals.show("edit-budget-modal")}getBudgetFormData(e){const t=document.getElementById(e);if(!t)return{};const o=new FormData(t),n={};for(let[a,i]of o.entries())(a==="ai-recommendations"||a==="aiRecommended")&&(a="ai_recommended"),a==="startDate"&&(a="start_date"),a==="endDate"&&(a="end_date"),typeof i=="string"&&(i=i.trim()),n[a]=i;const s=o.get("ai_recommended")??o.get("ai-recommendations")??o.get("aiRecommended");return n.ai_recommended=s==="on"||s==="true"||s==="1",typeof n.amount=="string"&&(n.amount=n.amount.replace(",",".")),n}displayAIBudgetInsights(e){const t=document.getElementById("budget-ai-insights");if(!t)return;if(!e||e.length===0){t.innerHTML=`
        <div class="ai-insights-empty">
          <div class="empty-icon">ğŸ¤–</div>
          <h4>No hay recomendaciones disponibles</h4>
          <p>Registra mÃ¡s gastos para obtener recomendaciones personalizadas</p>
        </div>
      `,t.classList.remove("hidden");return}console.log("ğŸ¤– Displaying AI budget insights:",e.length),t.innerHTML=`
      <div class="ai-insights-header">
        <h4>ğŸ¤– Recomendaciones Inteligentes</h4>
        <p>AnÃ¡lisis personalizado basado en tus patrones de gasto y machine learning</p>
      </div>
    `;const o=document.createElement("div");o.className="ai-insights-grid",e.forEach(n=>{const s=document.createElement("div");s.className=`ai-insight-card ${n.type||"ai_recommendation"}`,s.dataset.recommendationId=n.id,s.dataset.category=n.category,s.dataset.suggestedBudget=n.suggestedBudget,s.dataset.action=n.action;const a={ai_recommendation:"ğŸ¤–",ml_recommendation:"ğŸ§ ",pattern:'<i class="ph ph-chart-bar"></i>',prediction:"ğŸ”®",warning:"âš ï¸",opportunity:"ğŸ’¡"},i={high:"#ef4444",medium:"#f59e0b",low:"#10b981"};s.innerHTML=`
        <div class="insight-header">
          <div class="insight-title-section">
            <span class="insight-icon">${a[n.type]||"ğŸ¤–"}</span>
            <span class="insight-category">${n.category}</span>
            <span class="insight-priority" style="background-color: ${i[n.priority]||"#6b7280"}">${n.priority||"medium"}</span>
          </div>
          ${n.confidence?`<span class="confidence-score">${Math.round(n.confidence*100)}%</span>`:""}
        </div>
        
        <div class="insight-content">
          <div class="insight-action">${n.action}</div>
          <div class="insight-justification">${n.justification}</div>
          
          <div class="insight-budget-suggestion">
            <span class="budget-label">Presupuesto sugerido:</span>
            <span class="budget-amount">${this.formatCurrency(n.suggestedBudget)}</span>
          </div>
        </div>
        
        <div class="insight-actions">
          <button class="btn btn-sm btn-secondary dismiss-recommendation-btn" onclick="window.app.dismissAIRecommendation('${n.id}')">
            Descartar
          </button>
          ${n.applicable?`
            <button class="btn btn-sm btn-primary apply-recommendation-btn" onclick="window.app.applyAIRecommendation('${n.id}')">
              âœ¨ Aplicar al Presupuesto
            </button>
          `:""}
        </div>
      `,o.appendChild(s)}),t.appendChild(o),t.classList.remove("hidden")}showInsufficientDataMessage(e){const t=document.getElementById("budget-ai-insights");t&&(t.innerHTML=`
      <div class="insufficient-data-message">
        <div class="insufficient-data-header">
          <div class="insufficient-data-icon"><i class="ph ph-chart-bar"></i></div>
          <h3>Datos Insuficientes para AnÃ¡lisis IA</h3>
        </div>
        
        <div class="insufficient-data-content">
          <p class="insufficient-data-description">
            ${e.message}. Para generar recomendaciones precisas, necesitas:
          </p>
          
          <div class="data-requirements">
            <h4>ğŸ“‹ Requisitos MÃ­nimos:</h4>
            <div class="requirements-grid">
              <div class="requirement-item ${e.current.expenses>=e.requirements.minExpenses?"completed":"pending"}">
                <div class="requirement-icon">${e.current.expenses>=e.requirements.minExpenses?"âœ…":"â³"}</div>
                <div class="requirement-text">
                  <strong>Gastos registrados:</strong> ${e.current.expenses}/${e.requirements.minExpenses}
                </div>
              </div>
              
              <div class="requirement-item ${e.current.categories>=e.requirements.minCategories?"completed":"pending"}">
                <div class="requirement-icon">${e.current.categories>=e.requirements.minCategories?"âœ…":"â³"}</div>
                <div class="requirement-text">
                  <strong>CategorÃ­as diferentes:</strong> ${e.current.categories}/${e.requirements.minCategories}
                </div>
              </div>
              
              <div class="requirement-item ${e.current.days>=e.requirements.minDays?"completed":"pending"}">
                <div class="requirement-icon">${e.current.days>=e.requirements.minDays?"âœ…":"â³"}</div>
                <div class="requirement-text">
                  <strong>DÃ­as con gastos:</strong> ${e.current.days}/${e.requirements.minDays}
                </div>
              </div>
              
              <div class="requirement-item ${e.current.totalAmount>=e.requirements.minAmount?"completed":"pending"}">
                <div class="requirement-icon">${e.current.totalAmount>=e.requirements.minAmount?"âœ…":"â³"}</div>
                <div class="requirement-text">
                  <strong>Monto total:</strong> $${e.current.totalAmount.toFixed(2)}/$${e.requirements.minAmount}
                </div>
              </div>
            </div>
          </div>
          
          ${e.issues?`
            <div class="missing-requirements">
              <h4>âš ï¸ QuÃ© necesitas hacer:</h4>
              <ul class="issues-list">
                ${e.issues.map(o=>`<li>${o}</li>`).join("")}
              </ul>
            </div>
          `:""}
          
          <div class="insufficient-data-actions">
            <button class="btn btn-primary" onclick="window.app.navigation.showSection('transactions')">
              <i class="ph ph-plus" aria-hidden="true"></i>
              Registrar MÃ¡s Gastos
            </button>
            <button class="btn btn-secondary" onclick="window.app.generateBudgetInsights()">
              <span>ğŸ”„</span>
              Verificar Nuevamente
            </button>
          </div>
        </div>
      </div>
    `,t.style.display="block")}displayMLPredictions(e){const t=document.getElementById("ml-predictions-container");if(!t||!e||e.length===0)return;console.log("ğŸ§  Displaying ML predictions:",e.length),t.innerHTML=`
      <div class="ml-predictions-header">
        <h4>ğŸ§  Predicciones de Machine Learning</h4>
        <p>AnÃ¡lisis predictivo basado en tus patrones histÃ³ricos de gasto</p>
      </div>
    `;const o=document.createElement("div");o.className="ml-predictions-grid",e.forEach(n=>{const s=document.createElement("div");s.className=`ml-prediction-card trend-${n.trend}`;const a={increasing:"ğŸ“ˆ",decreasing:"ğŸ“‰",stable:"â¡ï¸",volatile:'<i class="ph ph-chart-line"></i>'},i={increasing:"#ef4444",decreasing:"#10b981",stable:"#6b7280",volatile:"#f59e0b"};s.innerHTML=`
        <div class="prediction-header">
          <div class="prediction-category">
            <span class="category-name">${n.category}</span>
            <span class="trend-indicator" style="color: ${i[n.trend]}">
              ${a[n.trend]} ${n.trend}
            </span>
          </div>
          <div class="confidence-badge">${Math.round(n.confidence*100)}% confianza</div>
        </div>
        
        <div class="prediction-content">
          <div class="predicted-amount">
            <span class="amount-label">Gasto predicho:</span>
            <span class="amount-value">${this.formatCurrency(n.predicted)}</span>
          </div>
          
          <div class="recommendation-preview">
            <div class="rec-type ${n.recommendation.type}">
              ${n.recommendation.type==="warning"?"âš ï¸":n.recommendation.type==="opportunity"?"ğŸ’¡":"âœ…"}
              ${n.recommendation.message}
            </div>
          </div>
        </div>
      `,o.appendChild(s)}),t.appendChild(o),t.classList.remove("hidden")}displaySpendingPatterns(e){const t=document.getElementById("spending-patterns-container");if(!t||!e||e.length===0)return;console.log("ğŸ“Š Displaying spending patterns:",e.length),t.innerHTML=`
      <div class="patterns-header">
        <h4><i class="ph ph-chart-bar"></i> Patrones de Gasto Detectados</h4>
        <p>Insights automÃ¡ticos sobre tu comportamiento financiero</p>
      </div>
    `;const o=document.createElement("div");o.className="patterns-grid",e.forEach(n=>{const s=document.createElement("div");s.className=`pattern-card pattern-${n.type}`;const a={day_pattern:"ğŸ“…",category_pattern:"ğŸ·ï¸",time_pattern:"â°",amount_pattern:'<i class="ph ph-coins"></i>'};s.innerHTML=`
        <div class="pattern-header">
          <span class="pattern-icon">${a[n.type]||'<i class="ph ph-chart-bar"></i>'}</span>
          <span class="pattern-title">${n.title}</span>
        </div>
        
        <div class="pattern-content">
          <div class="pattern-description">${n.description}</div>
          ${n.actionable?`
            <div class="pattern-suggestion">
              ğŸ’¡ <strong>Sugerencia:</strong> ${n.suggestion}
            </div>
          `:""}
        </div>
      `,o.appendChild(s)}),t.appendChild(o),t.classList.remove("hidden")}formatInsightData(e){if(!e||typeof e!="object")return"";let t='<div class="insight-data-items">';return Object.entries(e).forEach(([o,n])=>{typeof n=="number"&&o.includes("amount")?t+=`<div class="data-item"><strong>${o}:</strong> ${this.formatCurrency(n)}</div>`:t+=`<div class="data-item"><strong>${o}:</strong> ${n}</div>`}),t+="</div>",t}displayBudgetAlert(e){const t=document.createElement("div");t.className=`alert alert-${e.severity} budget-alert`,t.innerHTML=`
      <div class="alert-content">
        <div class="alert-title">${e.title}</div>
        <div class="alert-message">${e.message}</div>
        ${e.category?`<div class="alert-category">CategorÃ­a: ${e.category}</div>`:""}
      </div>
      <div class="alert-actions">
        <button class="btn btn-sm btn-secondary" onclick="this.parentElement.parentElement.remove()">
          Cerrar
        </button>
      </div>
    `,this.alertContainer.appendChild(t),setTimeout(()=>t.classList.add("show"),100),setTimeout(()=>{t.parentNode&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))},1e4)}updateBudgetSummary(e){const t=document.getElementById("total-budgets-count"),o=document.getElementById("active-budgets-count");t&&(t.textContent=e.totalBudgets),o&&(o.textContent=e.activeBudgets);const n=document.querySelector('[data-section="budgets"] .nav-badge');n&&(n.textContent=e.activeBudgets,n.style.display=e.activeBudgets>0?"flex":"none")}showLoading(e){const t=document.getElementById(e);t&&(t.classList.add("loading"),t.disabled=!0)}hideLoading(e){const t=document.getElementById(e);t&&(t.classList.remove("loading"),t.disabled=!1)}async loadAIBudgetInsights(){const e=document.getElementById("budget-ai-insights");e&&(e.innerHTML=`
      <div class="ai-insights-loading">
        <div class="loading-spinner"></div>
        <p>Cargando anÃ¡lisis inteligente...</p>
      </div>
    `,e.classList.remove("hidden"))}async handleLogout(){console.log("ğŸšª Handling logout...");try{window.app&&window.app.data&&await window.app.data.clearAllData(),localStorage.clear(),window.location.href="login.html"}catch(e){console.error("âŒ Error during logout:",e),this.showAlert("Error al cerrar sesiÃ³n","error")}}initDashboard(){document.addEventListener("DOMContentLoaded",()=>{this.wireDashboardButtons(),this.bindBudgetForm(),this.initExpensesChart()})}wireDashboardButtons(){var t,o,n,s,a,i,r,l,c;const e=d=>document.querySelector(d);(t=e("#qa-add-expense"))==null||t.addEventListener("click",()=>{var d,m;return(m=(d=window.app)==null?void 0:d.showAddExpenseModal)==null?void 0:m.call(d)}),(o=e("#qa-add-income"))==null||o.addEventListener("click",()=>{var d,m;return(m=(d=window.app)==null?void 0:d.showAddIncomeModal)==null?void 0:m.call(d)}),(n=e("#qa-import"))==null||n.addEventListener("click",()=>{var d,m,u;return(u=(m=(d=window.app)==null?void 0:d.modals)==null?void 0:m.show)==null?void 0:u.call(m,"import-data-modal")}),(s=e("#qa-ai-report"))==null||s.addEventListener("click",()=>{var d,m,u;return(u=(m=(d=window.app)==null?void 0:d.modals)==null?void 0:m.show)==null?void 0:u.call(m,"generate-ai-report-modal")}),(a=e("#qa-add-budget"))==null||a.addEventListener("click",()=>this.showAddBudgetModal()),(i=e("#add-expense-btn-dashboard"))==null||i.addEventListener("click",()=>{var d,m;return(m=(d=window.app)==null?void 0:d.showAddExpenseModal)==null?void 0:m.call(d)}),(r=e("#add-income-btn-dashboard"))==null||r.addEventListener("click",()=>{var d,m;return(m=(d=window.app)==null?void 0:d.showAddIncomeModal)==null?void 0:m.call(d)}),(l=e("#go-reports"))==null||l.addEventListener("click",()=>{var d,m,u;return(u=(m=(d=window.app)==null?void 0:d.navigation)==null?void 0:m.showSection)==null?void 0:u.call(m,"reports")}),(c=e("#go-transactions"))==null||c.addEventListener("click",()=>{var d,m,u;return(u=(m=(d=window.app)==null?void 0:d.navigation)==null?void 0:m.showSection)==null?void 0:u.call(m,"transactions")})}initExpensesChart(){var c,d,m;const e=document.getElementById("expenses-chart");if(!e||!window.Chart)return;const t=new Date,o=t.getFullYear(),n=t.getMonth(),s=()=>{var u,g,p;return((p=(g=(u=window.app)==null?void 0:u.data)==null?void 0:g.getExpenses)==null?void 0:p.call(g))||[]},a=(((m=(d=(c=window.app)==null?void 0:c.data)==null?void 0:d.getCurrentMonthExpenses)==null?void 0:m.call(d))||s()).filter(u=>{if(!(u!=null&&u.transaction_date))return!0;const g=this.parseDateSafe(u.transaction_date);return g.getFullYear()===o&&g.getMonth()===n}),i=new Map;for(const u of a){const g=u.category||"Otros",p=Number(u.amount)||0;i.set(g,(i.get(g)||0)+p)}const r=i.size?[...i.keys()]:["Sin datos"],l=i.size?[...i.values()]:[1];this._expensesChart&&this._expensesChart.destroy(),this._expensesChart=new Chart(e.getContext("2d"),{type:"doughnut",data:{labels:r,datasets:[{data:l,borderWidth:0}]},options:{responsive:!0,cutout:"62%",plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:u=>{const g=u.parsed||0;return`${u.label}: ${this.formatCurrency(g)}`}}}}}})}refreshExpensesChart(){this.initExpensesChart()}bindBudgetForm(){const e=document.getElementById("add-budget-form");e&&e.addEventListener("submit",async t=>{var s,a,i,r,l,c,d,m,u,g,p,h,E,w;t.preventDefault();const o=new FormData(e),n={name:(s=o.get("name"))==null?void 0:s.trim(),category:o.get("category"),amount:Number(o.get("amount")||0),start_date:o.get("start_date"),end_date:o.get("end_date"),ai_recommended:o.get("ai_recommended")==="on"};if(!n.name||!n.category||!n.amount||!n.start_date||!n.end_date){this.showAlert("Por favor, completÃ¡ todos los campos del presupuesto.","error");return}try{(i=(a=window.app)==null?void 0:a.budget)!=null&&i.addBudget?await window.app.budget.addBudget(n):(l=(r=window.app)==null?void 0:r.budget)!=null&&l.createBudget?await window.app.budget.createBudget(n):document.dispatchEvent(new CustomEvent("budget:create",{detail:n})),this.showAlert("Presupuesto creado âœ…","success"),(m=(d=(c=window.app)==null?void 0:c.modals)==null?void 0:d.hide)==null||m.call(d,"add-budget-modal"),e.reset();const y=((p=(g=(u=window.app)==null?void 0:u.budget)==null?void 0:g.getBudgets)==null?void 0:p.call(g))||[],b=((w=(E=(h=window.app)==null?void 0:h.data)==null?void 0:E.getExpenses)==null?void 0:w.call(E))||[];this.updateBudgetsList(y,b)}catch(y){console.error("Error creando presupuesto",y),this.showAlert("No se pudo crear el presupuesto.","error")}})}updateNavigationBadges(e,t,o){console.log("ğŸ·ï¸ Updating navigation badges...");const n=e.length+t.length,s=document.getElementById("pending-transactions");s&&(s.textContent=n,console.log("ğŸ·ï¸ Updated transactions badge:",n)),document.getElementById("upcoming-events")&&console.log("ğŸ·ï¸ Upcoming events badge: keeping current value"),document.getElementById("active-budgets")&&console.log("ğŸ·ï¸ Active budgets badge: keeping current value")}setupIncomeActionListeners(){document.querySelectorAll(".edit-income-btn").forEach(e=>{e.removeEventListener("click",this.handleEditIncome)}),document.querySelectorAll(".delete-income-btn").forEach(e=>{e.removeEventListener("click",this.handleDeleteIncome)}),document.querySelectorAll(".edit-income-btn").forEach(e=>{e.addEventListener("click",t=>this.handleEditIncome(t))}),document.querySelectorAll(".delete-income-btn").forEach(e=>{e.addEventListener("click",t=>this.handleDeleteIncome(t))})}handleEditIncome(e){const t=e.target.closest(".edit-income-btn"),o=t.dataset.type,n=t.dataset.id;console.log("âœï¸ Edit income:",{type:o,id:n}),o==="fixed"?this.showEditFixedIncomeModal():o==="extra"&&this.showEditExtraIncomeModal(n)}handleDeleteIncome(e){const t=e.target.closest(".delete-income-btn"),o=t.dataset.type,n=t.dataset.id;console.log("ğŸ—‘ï¸ Delete income:",{type:o,id:n}),o==="extra"?confirm("Â¿EstÃ¡s seguro de que quieres eliminar este ingreso?")&&this.deleteExtraIncome(n):o==="fixed"&&confirm("Â¿EstÃ¡s seguro de que quieres eliminar el ingreso fijo? Esto lo pondrÃ¡ en $0.")&&this.deleteFixedIncome()}async deleteExtraIncome(e){try{window.app&&window.app.data&&window.app.data.deleteExtraIncome?(await window.app.data.deleteExtraIncome(e),this.showAlert("Ingreso eliminado correctamente","success"),window.app.updateDashboard&&window.app.updateDashboard()):this.showAlert("Error: No se pudo eliminar el ingreso","error")}catch(t){console.error("Error deleting income:",t),this.showAlert("Error eliminando el ingreso","error")}}async deleteFixedIncome(){try{window.app&&window.app.data&&window.app.data.addFixedIncome?(console.log("ğŸ—‘ï¸ Deleting fixed income by setting to 0"),await window.app.data.addFixedIncome(window.app.currentMonth,0)?(this.showAlert("Ingreso fijo eliminado (puesto en $0)","success"),window.app.updateDashboard&&window.app.updateDashboard()):this.showAlert("Error: No se pudo eliminar el ingreso fijo","error")):(console.error("addFixedIncome method not found"),this.showAlert("Error: MÃ©todo addFixedIncome no disponible","error"))}catch(e){console.error("Error deleting fixed income:",e),this.showAlert("Error eliminando el ingreso fijo: "+e.message,"error")}}showEditFixedIncomeModal(){this.showAlert("Para editar el ingreso fijo, agrega un nuevo ingreso y se actualizarÃ¡ automÃ¡ticamente","info"),window.app&&window.app.showAddIncomeModal&&window.app.showAddIncomeModal()}async showEditExtraIncomeModal(e){if(console.log("âœï¸ Show edit extra income modal for:",e),!window.app||!window.app.data){this.showAlert("Error: No se pudo acceder a los datos","error");return}try{const o=(await window.app.data.getExtraIncomes(window.app.currentMonth)).find(r=>r.id===e);if(!o){this.showAlert("Ingreso no encontrado","error");return}const n=document.getElementById("edit-income-description"),s=document.getElementById("edit-income-amount"),a=document.getElementById("edit-income-category"),i=document.getElementById("edit-extra-income-modal");n&&(n.value=o.description||""),s&&(s.value=o.amount||""),a&&(a.value=o.category||"other"),i&&(i.dataset.incomeId=e),window.app&&window.app.modals&&window.app.modals.show("edit-extra-income-modal"),this.setupEditExtraIncomeForm()}catch(t){console.error("Error loading income for edit:",t),this.showAlert("Error al cargar los datos del ingreso","error")}}setupEditExtraIncomeForm(){const e=document.getElementById("edit-extra-income-form");!e||e.dataset.listenerAdded||(e.addEventListener("submit",async t=>{var i;t.preventDefault();const o=document.getElementById("edit-extra-income-modal"),n=o==null?void 0:o.dataset.incomeId;if(!n){this.showAlert("Error: ID de ingreso no encontrado","error");return}const s=new FormData(e),a={description:(i=s.get("description"))==null?void 0:i.trim(),amount:parseFloat(s.get("amount")),category:s.get("category")};if(!a.description||a.amount<=0){this.showAlert("Por favor completa todos los campos correctamente","error");return}try{await window.app.data.updateExtraIncome(n,a)?(this.showAlert("Ingreso actualizado correctamente","success"),window.app&&window.app.modals&&window.app.modals.hide("edit-extra-income-modal"),window.app.updateDashboard&&window.app.updateDashboard()):this.showAlert("Error al actualizar el ingreso","error")}catch(r){console.error("Error updating income:",r),this.showAlert("Error al actualizar el ingreso: "+r.message,"error")}}),e.dataset.listenerAdded="true")}}const j={id:"transparentBackground",beforeDraw:v=>{const e=v.canvas;e.style.backgroundColor="transparent",e.style.background="transparent";const t=v.canvas.getContext("2d");t.save(),t.globalCompositeOperation="destination-over",t.fillStyle="transparent",t.fillRect(0,0,e.width,e.height),t.restore()}};var H;if(typeof Chart<"u"){Chart.register(j),Chart.defaults.backgroundColor="transparent",Chart.defaults.plugins.legend.labels.backgroundColor="transparent";const v=(H=Chart.helpers)==null?void 0:H.getCanvas;v&&(Chart.helpers.getCanvas=function(e){const t=v.call(this,e);return t&&t.style&&(t.style.backgroundColor="transparent",t.style.background="transparent"),t})}class te{constructor(){this.expensesChart=null,this.dashboardExpensesChart=null,this.trendChart=null,this.ensurePluginRegistered()}ensurePluginRegistered(){if(typeof Chart<"u"&&Chart.register)try{Chart.register(j)}catch(e){console.log("ğŸ“Š Transparent background plugin registration:",e.message)}}updateExpensesChart(e,t){const o=document.getElementById("expenses-chart");if(!o){console.log("â„¹ï¸ Expenses chart canvas not found - not in charts view");return}this.renderChart(o,e,"expensesChart",t)}updateDashboardExpensesChart(e,t){console.log("ğŸ“Š updateDashboardExpensesChart called with data:",e);const o=document.getElementById("dashboard-expenses-chart");if(!o){console.error("âŒ Dashboard expenses chart canvas not found");return}console.log("ğŸ“Š Canvas found, calling renderChart"),this.renderChart(o,e,"dashboardExpensesChart",t)}renderChart(e,t,o,n=null){if(console.log("ğŸ“Š renderChart called:",{chartProperty:o,data:t,categories:n,visible:e.offsetParent!==null}),typeof Chart>"u"){console.error("âŒ Chart.js not loaded!");return}e.offsetParent===null&&console.log("âš ï¸ Chart canvas not visible - will render anyway");let s=t;this[o]&&this[o].destroy();const a=Object.keys(s),i=Object.values(s);if(console.log("ğŸ“Š Chart data prepared:",{labels:a,values:i}),a.length===0||i.every(l=>l===0)){console.log("ğŸ“Š No data available, showing empty state");try{const l=e.getContext("2d");l.clearRect(0,0,e.width,e.height);const c=document.body.getAttribute("data-skin")==="pro";l.fillStyle=c?"#9CA3AF":"#666",l.font="14px Arial",l.textAlign="center",l.fillText("No hay datos para mostrar",e.width/2,e.height/2)}catch(l){console.warn("Could not draw empty state on expenses chart:",l)}return}const r=this.getCategoryColors(a,n);try{const l=document.body.getAttribute("data-skin")==="pro",c=l?"#E5E7EB":"#1a202c",d=l?"rgba(55, 65, 81, 0.3)":"rgba(255, 255, 255, 0.8)";this[o]=new Chart(e,{type:"doughnut",data:{labels:a,datasets:[{data:i,backgroundColor:r,borderWidth:1,borderColor:d,hoverOffset:12,hoverBorderWidth:2,borderRadius:6,borderSkipped:!1}]},options:{responsive:!0,maintainAspectRatio:!1,devicePixelRatio:window.devicePixelRatio||1,animation:{animateRotate:!0,animateScale:!0,duration:1e3,easing:"easeOutCubic"},plugins:{transparentBackground:{enabled:!0},legend:{position:"bottom",labels:{padding:20,usePointStyle:!0,pointStyle:"circle",font:{size:window.innerWidth<768?12:13,weight:"500"},color:c,boxWidth:10,boxHeight:10}},tooltip:{backgroundColor:l?"rgba(17, 24, 39, 0.95)":"rgba(0, 0, 0, 0.8)",titleColor:"#ffffff",bodyColor:"#ffffff",borderColor:l?"#4b5563":"#374151",borderWidth:1,cornerRadius:8,padding:12,displayColors:!0,boxPadding:6,callbacks:{label:g=>{const p=g.label||"",h=g.raw||0,E=g.dataset.data.reduce((y,b)=>y+b,0),w=(h/E*100).toFixed(1);return`${p}: $${h.toLocaleString()} (${w}%)`}}}},cutout:window.innerWidth<768?"58%":"68%",interaction:{intersect:!1},elements:{arc:{borderWidth:1,borderRadius:6}}}});const m=this[o].canvas;m.style.backgroundColor="transparent",m.style.background="transparent";const u=m.parentElement;u&&u.classList.contains("chart-container")&&(u.style.background="transparent"),console.log("âœ… Chart created successfully:",o)}catch(l){console.error("âŒ Error creating chart:",l)}}updateTrendChart(e){const t=document.getElementById("trend-chart");if(!t){console.log("â„¹ï¸ Trend chart canvas not found - not in charts view");return}if(t.offsetParent===null){console.log("â„¹ï¸ Trend chart canvas not visible - skipping update");return}this.trendChart&&this.trendChart.destroy();const o=e.map(s=>s.month),n=e.map(s=>s.amount);if(o.length===0||n.every(s=>s===0)){try{const s=t.getContext("2d");s.clearRect(0,0,t.width,t.height);const a=document.body.getAttribute("data-skin")==="pro";s.fillStyle=a?"#9CA3AF":"#666",s.font="14px Arial",s.textAlign="center",s.fillText("No hay datos para mostrar",t.width/2,t.height/2)}catch(s){console.warn("Could not draw empty state on trend chart:",s)}return}if(this.trendChart=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Gastos Mensuales",data:n,borderColor:"#A7C7E7",backgroundColor:"rgba(167, 199, 231, 0.1)",borderWidth:3,fill:!0,tension:.4,pointBackgroundColor:"#C8B6FF",pointBorderColor:"#A7C7E7",pointBorderWidth:2,pointRadius:window.innerWidth<768?4:6,pointHoverRadius:window.innerWidth<768?6:8}]},options:{responsive:!0,maintainAspectRatio:!1,devicePixelRatio:window.devicePixelRatio||1,plugins:{transparentBackground:{enabled:!0},legend:{display:!1},tooltip:{callbacks:{label:s=>`Gastos: $${s.raw.toLocaleString()}`}}},scales:{x:{ticks:{font:{size:window.innerWidth<768?10:12}}},y:{beginAtZero:!0,ticks:{font:{size:window.innerWidth<768?10:12},callback:function(s){return"$"+s.toLocaleString()}}}}}}),this.trendChart&&this.trendChart.canvas){const s=this.trendChart.canvas,a=s.style;a.setProperty("background-color","transparent","important"),a.setProperty("background","transparent","important"),s.style.backgroundColor="transparent",s.style.background="transparent"}}getCategoryColors(e,t){if(window.location.hostname==="localhost"&&console.log("ğŸ¨ getCategoryColors called with:",{labels:e,categories:t==null?void 0:t.map(r=>({name:r.name,color:r.color}))}),!t)return window.location.hostname==="localhost"&&console.log("âš ï¸ No categories provided, using fallback colors"),this.generateUniqueColors(e.length);const o=[],n=new Set,s=new Set,a=this.generateUniqueColors(e.length);let i=0;return e.forEach((r,l)=>{const c=t.find(m=>m.name===r);let d;if(c&&c.color){const m=this.isColorSimilar(c.color,s);!n.has(c.color)&&!m?(d=c.color,window.location.hostname==="localhost"&&console.log(`âœ… Color for ${r}: ${c.color}`)):(d=this.getNextUniqueColor(n,a,i++),window.location.hostname==="localhost"&&console.log(`âš ï¸ Color ${c.color} already used or similar for ${r}, using ${d}`))}else d=this.getNextUniqueColor(n,a,i++),window.location.hostname==="localhost"&&console.log(`âŒ Category ${r} not found, using fallback ${d}`);o.push(d),n.add(d),s.add(this.normalizeColorForComparison(d))}),window.location.hostname==="localhost"&&(console.log("ğŸ¨ Final colors array:",o),console.log("âœ… All chart colors are unique and visually distinct")),o}isColorSimilar(e,t){const o=this.normalizeColorForComparison(e);return t.has(o)}normalizeColorForComparison(e){const t=this.hexToHsl(e);if(!t)return e;const o=Math.floor(t.h/15)*15,n=Math.floor(t.s/25)*25,s=Math.floor(t.l/25)*25;return`${o}-${n}-${s}`}getNextUniqueColor(e,t,o){let n=t[o%t.length],s=0;for(;e.has(n)&&s<t.length*2;)o++,n=t[o%t.length],s++;return e.has(n)&&(n=this.generateRandomColor()),n}generateRandomColor(){const e=Math.floor(Math.random()*360),t=60+Math.floor(Math.random()*30),o=45+Math.floor(Math.random()*20);return`hsl(${e}, ${t}%, ${o}%)`}generateUniqueColors(e){const t=["#dc2626","#ea580c","#ca8a04","#16a34a","#0891b2","#2563eb","#7c3aed","#be185d","#b91c1c","#c2410c","#a16207","#15803d","#0e7490","#1d4ed8","#6d28d9","#a21caf","#ef4444","#f97316","#eab308","#22c55e","#06b6d4","#3b82f6","#8b5cf6","#ec4899","#65a30d","#0d9488","#4338ca","#7c2d12","#166534","#0c4a6e","#581c87","#831843","#365314","#134e4a","#1e3a8a","#78350f"],o=document.body.classList.contains("darkmode")||document.documentElement.getAttribute("data-theme")==="dark",n=[],s=new Set;for(let a=0;a<e&&a<t.length;a++){const i=t[a];n.push(i),s.add(i)}for(let a=t.length;a<e;a++){let i,r=0;do i=`hsl(${(a*40+r*15)%360}, ${o?75:65}%, ${o?60:50}%)`,r++;while(s.has(i)&&r<20);s.has(i)&&(i=this.generateRandomColor()),n.push(i),s.add(i)}return n}generateMobileOptimizedVariation(e,t,o=!1){const n=this.hexToHsl(e);if(!n)return this.generateRandomColor();const s=(t*30+Math.floor(t/10)*15)%360,a=(n.h+s)%360,i=Math.max(60,Math.min(85,n.s+t%3*10));let r;return o?r=Math.max(55,Math.min(75,n.l+20)):r=Math.max(35,Math.min(55,n.l-10)),`hsl(${a}, ${i}%, ${r}%)`}generateColorVariation(e,t){const o=this.hexToHsl(e);if(o){const n=t*25%360;return`hsl(${(o.h+n)%360}, ${Math.max(50,o.s)}%, ${Math.max(40,Math.min(60,o.l))}%)`}return this.generateRandomColor()}hexToHsl(e){try{const t=parseInt(e.slice(1,3),16)/255,o=parseInt(e.slice(3,5),16)/255,n=parseInt(e.slice(5,7),16)/255,s=Math.max(t,o,n),a=Math.min(t,o,n);let i,r,l=(s+a)/2;if(s===a)i=r=0;else{const c=s-a;switch(r=l>.5?c/(2-s-a):c/(s+a),s){case t:i=(o-n)/c+(o<n?6:0);break;case o:i=(n-t)/c+2;break;case n:i=(t-o)/c+4;break}i/=6}return{h:Math.round(i*360),s:Math.round(r*100),l:Math.round(l*100)}}catch{return null}}generateColors(e){return this.generateUniqueColors(e)}destroy(){this.expensesChart&&this.expensesChart.destroy(),this.trendChart&&this.trendChart.destroy()}}class oe{constructor(){this.modals=new Map}init(){console.log("ğŸ”§ DEBUG: ModalManager init started");const e=document.querySelectorAll(".modal");console.log("ğŸ”§ DEBUG: Found modal elements:",e.length),e.forEach(t=>{console.log("ğŸ”§ DEBUG: Registering modal:",t.id,t.className),this.modals.set(t.id,t),t.classList.toggle("hidden",!t.classList.contains("active")),t.addEventListener("click",s=>{s.target===t&&this.hide(t.id)});const o=t.querySelector(".modal-close");o&&o.addEventListener("click",()=>this.hide(t.id));const n=t.querySelector(".modal-cancel");n&&n.addEventListener("click",()=>this.hide(t.id))}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.hideAll()}),console.log("ğŸ”§ DEBUG: ModalManager registered modals:",Array.from(this.modals.keys()))}hideAll(){this.modals.forEach((e,t)=>this.hide(t))}setupBudgetModalEvents(){const e=document.getElementById("budget-ai-recommendations"),t=document.getElementById("ai-recommendations-info");e&&t&&e.addEventListener("change",n=>{t.classList.toggle("hidden",!n.target.checked)});const o=(n,s)=>{const a=document.getElementById(n),i=document.getElementById(s);a&&i&&(a.addEventListener("change",()=>{i.min=a.value,i.value&&i.value<a.value&&(i.value=a.value)}),i.addEventListener("change",()=>{a.value&&i.value<a.value&&(i.value=a.value)}))};o("budget-start-date","budget-end-date"),o("edit-budget-start-date","edit-budget-end-date")}setupIncomeModalEvents(){const e=document.getElementById("income-type"),t=document.getElementById("extra-income-group");if(!e||!t)return;const o=()=>{const n=e.value==="extra";t.classList.toggle("hidden",!n)};o(),e.addEventListener("change",o)}show(e){console.log("ğŸ”§ ModalManager: Showing modal",e);const t=this.modals.get(e)||document.getElementById(e);if(!t){console.error("âŒ ModalManager: modal not found ->",e),console.log("ğŸ”§ Available modals:",Array.from(this.modals.keys()));return}console.log("âœ… Modal found:",t.id,t.className),t.parentNode!==document.body&&(document.body.appendChild(t),console.log("ğŸ”§ Modal moved to body")),t.classList.remove("closing"),t.classList.remove("hidden"),console.log("ğŸ”§ Removed hidden class"),t.offsetHeight,t.classList.add("active"),console.log("ğŸ”§ Added active class, modal classes now:",t.className),t.style.zIndex="2147483647",document.body.style.overflow="hidden";const o=t.offsetParent!==null;console.log("ğŸ‘ï¸ Modal visible?",o),console.log("ğŸ“ Modal dimensions:",t.offsetWidth,"x",t.offsetHeight);const n=t.querySelector("input, select, textarea, button");n&&setTimeout(()=>{n.focus(),console.log("ğŸ¯ Focus set to:",n.id||n.tagName)},50),document.addEventListener("keydown",s=>{if(s.key!=="Escape")return;const a=document.querySelector(".modal.active");a&&this.hide(a.id)})}hide(e){console.log("ModalManager: Hiding modal",e);const t=this.modals.get(e)||document.getElementById(e);if(!t)return;t.classList.remove("active"),t.classList.add("closing");const o=t.querySelector(".modal-content"),n=()=>{t.classList.remove("closing"),t.classList.add("hidden"),document.body.style.overflow="";const s=t.querySelector("form");s&&s.reset()};if(o){const s=a=>{a.target===o&&(o.removeEventListener("transitionend",s),n())};o.addEventListener("transitionend",s,{once:!0}),setTimeout(n,400)}else n()}}class ne{constructor(){this.reports=[]}escapeHtml(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}sanitizeReportContent(e){return typeof e!="string"?"":e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}async generateAIReport(e,t,o){try{const n=await fetch("/api/ai-reports",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({data:e,focus:t,questions:o})});if(!n.ok)return console.error("âŒ Gemini API error:",n.status,n.statusText),this.generateEnhancedFallbackReport(e,t,o);const s=await n.json();return s.fallback?(console.log("ğŸ“´ Using server fallback response"),s.report||this.generateEnhancedFallbackReport(e,t,o)):s.success&&s.report?this.formatAIReport(s.report,e,t,o):(console.warn("âš ï¸ Unexpected response format, using fallback"),this.generateEnhancedFallbackReport(e,t,o))}catch(n){return console.error("âŒ Error generating AI report:",n),this.generateEnhancedFallbackReport(e,t,o)}}buildAIPrompt(e,t,o){const n=e.totalIncome-e.totalExpenses,s=e.totalIncome>0?(n/e.totalIncome*100).toFixed(1):0,a=Object.entries(e.categories).sort(([,r],[,l])=>l-r).slice(0,5);let i=`Eres un experto asesor financiero personal. Analiza los siguientes datos financieros y genera un informe completo y personalizado en espaÃ±ol.

DATOS FINANCIEROS:
- PerÃ­odo: ${this.getPeriodText(e.period)} (${e.months} meses)
- Ingresos Totales: $${e.totalIncome.toLocaleString()}
- Gastos Totales: $${e.totalExpenses.toLocaleString()}
- Balance: $${n.toLocaleString()}
- Tasa de Ahorro: ${s}%

GASTOS POR CATEGORÃA:`;return a.forEach(([r,l])=>{const c=(l/e.totalExpenses*100).toFixed(1);i+=`
- ${r}: $${l.toLocaleString()} (${c}%)`}),i+=`

OBJETIVOS DE AHORRO: ${e.goals.length} objetivos activos`,i+=`
LÃMITES DE GASTO: ${e.spendingLimits.length} lÃ­mites configurados`,i+=`

ENFOQUE DEL ANÃLISIS: ${t}`,o&&o.trim()&&(i+=`

PREGUNTAS ESPECÃFICAS DEL USUARIO: "${o}"`),i+=`

Genera un informe financiero completo que incluya:

1. **RESUMEN EJECUTIVO**: AnÃ¡lisis general de la situaciÃ³n financiera
2. **ANÃLISIS DETALLADO**: 
   - EvaluaciÃ³n de ingresos y gastos
   - AnÃ¡lisis de patrones de gasto por categorÃ­a
   - EvaluaciÃ³n de la tasa de ahorro
3. **FORTALEZAS IDENTIFICADAS**: Aspectos positivos del manejo financiero
4. **ÃREAS DE MEJORA**: Problemas o oportunidades detectadas
5. **RECOMENDACIONES ESPECÃFICAS**: 
   - Acciones concretas para mejorar las finanzas
   - Estrategias de ahorro personalizadas
   - OptimizaciÃ³n de gastos por categorÃ­a
6. **PLAN DE ACCIÃ“N**: Pasos especÃ­ficos a seguir en los prÃ³ximos 30, 60 y 90 dÃ­as
7. **RESPUESTA A PREGUNTAS**: Si hay preguntas especÃ­ficas, respÃ³ndelas detalladamente

Usa un tono profesional pero accesible. Incluye nÃºmeros especÃ­ficos y porcentajes. SÃ© constructivo y motivador. MÃ¡ximo 1500 palabras.`,i}formatAIReport(e,t,o,n){const s=t.totalIncome-t.totalExpenses,a=t.totalIncome>0?(s/t.totalIncome*100).toFixed(1):0;return`
      <div class="report-header">
        <h3>ğŸ“Š Informe Financiero Personalizado</h3>
        <div class="report-metrics">
          <div class="metric">
            <span class="metric-label">PerÃ­odo:</span>
            <span class="metric-value">${this.getPeriodText(t.period)}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Balance:</span>
            <span class="metric-value ${s>=0?"positive":"negative"}">${this.formatCurrency(s)}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Tasa de Ahorro:</span>
            <span class="metric-value">${a}%</span>
          </div>
        </div>
      </div>
      
      <div class="ai-content">
        ${this.formatAIText(e)}
      </div>
    `}formatAIText(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^(\d+\.\s.*$)/gm,'<div class="numbered-item">$1</div>').replace(/^-\s(.*)$/gm,'<div class="bullet-item">â€¢ $1</div>').replace(/\n\n/g,"</p><p>").replace(/^/,"<p>").replace(/$/,"</p>")}generateEnhancedFallbackReport(e,t,o){console.log("ğŸ”„ Generating enhanced fallback report");const n=e.totalIncome-e.totalExpenses,s=e.totalIncome>0?(n/e.totalIncome*100).toFixed(1):0,a=Object.entries(e.categories).sort(([,r],[,l])=>l-r).slice(0,5);let i=`
      <div class="report-header">
        <h3>ğŸ“Š Informe Financiero Personalizado</h3>
        <div class="report-metrics">
          <div class="metric">
            <span class="metric-label">PerÃ­odo:</span>
            <span class="metric-value">${this.getPeriodText(e.period)}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Balance:</span>
            <span class="metric-value ${n>=0?"positive":"negative"}">${this.formatCurrency(n)}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Tasa de Ahorro:</span>
            <span class="metric-value">${s}%</span>
          </div>
        </div>
      </div>

      <h4>ğŸ’° Resumen Ejecutivo</h4>
      <p>Durante ${this.getPeriodText(e.period).toLowerCase()}, has manejado un total de <strong>${this.formatCurrency(e.totalIncome)}</strong> en ingresos y <strong>${this.formatCurrency(e.totalExpenses)}</strong> en gastos, resultando en un balance de <strong>${this.formatCurrency(n)}</strong>.</p>
      
      <p>Tu tasa de ahorro actual es del <strong>${s}%</strong>. ${this.getSavingsAnalysis(parseFloat(s))}</p>

      <h4>ğŸ“ˆ AnÃ¡lisis de Gastos por CategorÃ­a</h4>
      <div class="category-analysis">
    `;return a.forEach(([r,l],c)=>{const d=(l/e.totalExpenses*100).toFixed(1),m=this.getCategoryAnalysis(r,d);i+=`
        <div class="category-item">
          <div class="category-header">
            <span class="category-rank">#${c+1}</span>
            <span class="category-name">${this.escapeHtml(r)}</span>
            <span class="category-amount">${this.formatCurrency(l)} (${d}%)</span>
          </div>
          <div class="category-insight">${m}</div>
        </div>
      `}),i+="</div>",t==="savings"?i+=this.getSavingsRecommendations(e,s):t==="expenses"?i+=this.getExpenseRecommendations(e,a):t==="goals"?i+=this.getGoalsRecommendations(e):i+=this.getGeneralRecommendations(e,s,a),o&&o.trim()&&(i+=`
        <h4>â“ Respuesta a tus Preguntas</h4>
        <div class="question-section">
          <p><em class="user-question"></em></p>
          <p class="ai-response"></p>
        </div>
      `),i+=this.getActionPlan(e,t,s),i}getSavingsAnalysis(e){return e>=20?"Â¡Excelente! EstÃ¡s ahorrando muy bien. MantÃ©n este ritmo y considera invertir tus ahorros.":e>=10?"Buen trabajo ahorrando. Intenta aumentar gradualmente tu tasa de ahorro al 20%.":e>=0?"EstÃ¡s ahorrando algo, pero hay margen de mejora. Revisa tus gastos para encontrar oportunidades.":"âš ï¸ EstÃ¡s gastando mÃ¡s de lo que ingresas. Es prioritario revisar y reducir gastos."}getCategoryAnalysis(e,t){return{Comida:t>30?"Considera cocinar mÃ¡s en casa y planificar comidas.":"Gasto razonable en alimentaciÃ³n.",Transporte:t>20?"EvalÃºa opciones de transporte mÃ¡s econÃ³micas.":"Gasto controlado en transporte.",Ocio:t>15?"Busca alternativas de entretenimiento mÃ¡s econÃ³micas.":"Buen balance en entretenimiento.",Supermercado:t>25?"Planifica compras y usa listas para evitar gastos innecesarios.":"Compras controladas.",Servicios:t>25?"Revisa suscripciones y servicios que no uses frecuentemente.":"Servicios bajo control.",Salud:"InversiÃ³n importante en tu bienestar.",Otros:"Categoriza mejor estos gastos para mayor control."}[e]||"Revisa si estos gastos son necesarios y busca formas de optimizarlos."}getSavingsRecommendations(e,t){return`
      <h4>ğŸ’¡ Recomendaciones para Ahorrar</h4>
      <div class="recommendations">
        <div class="recommendation">
          <strong>Regla 50/30/20:</strong> Destina 50% a necesidades, 30% a deseos y 20% a ahorros.
        </div>
        <div class="recommendation">
          <strong>Automatiza tus ahorros:</strong> Configura transferencias automÃ¡ticas el dÃ­a que cobras.
        </div>
        <div class="recommendation">
          <strong>Fondo de emergencia:</strong> Acumula 3-6 meses de gastos bÃ¡sicos.
        </div>
        ${t<10?'<div class="recommendation urgent"><strong>Prioridad:</strong> Identifica gastos no esenciales que puedas eliminar.</div>':""}
      </div>
    `}getExpenseRecommendations(e,t){const o=t[0];return`
      <h4>ğŸ’³ OptimizaciÃ³n de Gastos</h4>
      <div class="recommendations">
        <div class="recommendation">
          <strong>CategorÃ­a principal:</strong> ${o[0]} representa tu mayor gasto (${this.formatCurrency(o[1])}).
        </div>
        <div class="recommendation">
          <strong>MÃ©todo 24 horas:</strong> Espera 24 horas antes de compras no planificadas.
        </div>
        <div class="recommendation">
          <strong>Revisa suscripciones:</strong> Cancela servicios que no uses regularmente.
        </div>
        <div class="recommendation">
          <strong>Compara precios:</strong> Usa apps para comparar precios antes de comprar.
        </div>
      </div>
    `}getBudgetRecommendations(e,t){return`
      <h4>ğŸ“Š OptimizaciÃ³n de Presupuesto</h4>
      <div class="recommendations">
        <div class="recommendation">
          <strong>Presupuesto base cero:</strong> Asigna cada peso a una categorÃ­a especÃ­fica.
        </div>
        <div class="recommendation">
          <strong>Revisa mensualmente:</strong> Ajusta tu presupuesto segÃºn patrones reales.
        </div>
        ${t<0?'<div class="recommendation urgent"><strong>AcciÃ³n inmediata:</strong> Reduce gastos no esenciales para equilibrar el presupuesto.</div>':""}
        <div class="recommendation">
          <strong>Usa la regla 80/20:</strong> 80% gastos planificados, 20% imprevistos.
        </div>
      </div>
    `}getGoalsRecommendations(e){return`
      <h4>ğŸ¯ Estrategia para Objetivos</h4>
      <div class="recommendations">
        <div class="recommendation">
          <strong>Objetivos SMART:</strong> EspecÃ­ficos, Medibles, Alcanzables, Relevantes, con Tiempo definido.
        </div>
        <div class="recommendation">
          <strong>Divide en metas pequeÃ±as:</strong> Celebra logros parciales para mantener motivaciÃ³n.
        </div>
        ${e.goals.length===0?'<div class="recommendation"><strong>Comienza hoy:</strong> Define al menos un objetivo de ahorro especÃ­fico.</div>':""}
        <div class="recommendation">
          <strong>Automatiza el progreso:</strong> Configura transferencias automÃ¡ticas hacia tus objetivos.
        </div>
      </div>
    `}getGeneralRecommendations(e,t,o){return`
      <h4>ğŸ’¡ Recomendaciones Generales</h4>
      <div class="recommendations">
        <div class="recommendation">
          <strong>Registra todo:</strong> MantÃ©n el hÃ¡bito de registrar todos tus gastos.
        </div>
        <div class="recommendation">
          <strong>Revisa semanalmente:</strong> Dedica 15 minutos cada semana a revisar tus finanzas.
        </div>
        <div class="recommendation">
          <strong>EdÃºcate financieramente:</strong> Lee libros o toma cursos sobre finanzas personales.
        </div>
        ${t<15?'<div class="recommendation"><strong>Aumenta ingresos:</strong> Considera fuentes adicionales de ingresos.</div>':""}
      </div>
    `}generateQuestionResponse(e,t){const o=e.toLowerCase();if(o.includes("ahorr"))return`BasÃ¡ndome en tus datos, tu tasa de ahorro actual es del ${t.totalIncome>0?((t.totalIncome-t.totalExpenses)/t.totalIncome*100).toFixed(1):0}%. Para mejorar, te recomiendo aplicar la regla 50/30/20 y automatizar tus ahorros.`;if(o.includes("gast")||o.includes("reduc")){const n=Object.entries(t.categories).sort(([,s],[,a])=>a-s)[0];return`Tu mayor gasto es en ${n[0]} con ${this.formatCurrency(n[1])}. Te sugiero revisar esta categorÃ­a y buscar alternativas mÃ¡s econÃ³micas.`}if(o.includes("ingreso")||o.includes("ganar"))return`Con ingresos de ${this.formatCurrency(t.totalIncome)}, podrÃ­as considerar fuentes adicionales como freelancing, venta de productos o inversiones que generen ingresos pasivos.`;if(o.includes("inver")){const n=t.totalIncome-t.totalExpenses;return n>0?`Con un balance positivo de ${this.formatCurrency(n)}, podrÃ­as considerar inversiones de bajo riesgo como fondos indexados o plazo fijo.`:"Primero enfÃ³cate en equilibrar tus finanzas y crear un fondo de emergencia antes de invertir."}return"BasÃ¡ndome en tu situaciÃ³n financiera actual, te recomiendo enfocarte en mantener un registro detallado de gastos, establecer objetivos claros de ahorro y revisar regularmente tu progreso."}getActionPlan(e,t,o){return`
      <h4>ğŸ“‹ Plan de AcciÃ³n</h4>
      <div class="action-plan">
        <div class="action-period">
          <h5>ğŸ“… PrÃ³ximos 30 dÃ­as</h5>
          <ul>
            <li>Revisa y categoriza todos tus gastos del mes pasado</li>
            <li>Establece un presupuesto especÃ­fico para cada categorÃ­a</li>
            <li>Configura alertas de lÃ­mites de gasto en FINZN</li>
            ${o<10?'<li class="urgent">Identifica 3 gastos no esenciales que puedas eliminar</li>':""}
          </ul>
        </div>
        
        <div class="action-period">
          <h5>ğŸ“… PrÃ³ximos 60 dÃ­as</h5>
          <ul>
            <li>Implementa el mÃ©todo de ahorro automÃ¡tico</li>
            <li>Negocia mejores tarifas en servicios recurrentes</li>
            <li>Establece al menos un objetivo de ahorro especÃ­fico</li>
            <li>EvalÃºa el progreso y ajusta el presupuesto si es necesario</li>
          </ul>
        </div>
        
        <div class="action-period">
          <h5>ğŸ“… PrÃ³ximos 90 dÃ­as</h5>
          <ul>
            <li>Revisa y optimiza tu estrategia de ahorro</li>
            <li>Considera oportunidades de ingresos adicionales</li>
            <li>EvalÃºa opciones de inversiÃ³n para tus ahorros</li>
            <li>Celebra tus logros y establece nuevas metas</li>
          </ul>
        </div>
      </div>
    `}async generatePDF(e,t){try{console.log("ğŸ“„ Generating PDF report...");const o=window.open("","_blank");if(!o)throw new Error("No se pudo abrir la ventana para generar el PDF. Verifica que no estÃ© bloqueada por el navegador.");const a=`Informe_Financiero_FINZN_${new Date().toLocaleDateString("es-ES").replace(/\//g,"-")}.pdf`,i=this.createPDFHTML(e,t);return o.document.write(i),o.document.close(),o.onload=()=>{setTimeout(()=>{o.print(),setTimeout(()=>{o.close()},1e3)},500)},!0}catch(o){return console.error("Error generating PDF:",o),this.downloadAsHTML(e,t),!1}}createPDFHTML(e,t){return`
      <!DOCTYPE html>
      <html lang="es">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Informe Financiero FINZN</title>
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
          }
          
          .pdf-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #C8B6FF;
            padding-bottom: 20px;
          }
          
          .pdf-header h1 {
            color: #C8B6FF;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
          }
          
          .pdf-header .subtitle {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 5px;
          }
          
          .pdf-header .date {
            color: #999;
            font-size: 1em;
          }
          
          .report-metrics {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
          }
          
          .metric {
            text-align: center;
          }
          
          .metric-label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
          }
          
          .metric-value {
            display: block;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
          }
          
          .metric-value.positive {
            color: #28a745;
          }
          
          .metric-value.negative {
            color: #dc3545;
          }
          
          h3, h4, h5 {
            color: #C8B6FF;
            margin: 25px 0 15px 0;
            font-weight: bold;
          }
          
          h3 {
            font-size: 1.5em;
            border-bottom: 2px solid #C8B6FF;
            padding-bottom: 5px;
          }
          
          h4 {
            font-size: 1.3em;
          }
          
          h5 {
            font-size: 1.1em;
          }
          
          p {
            margin-bottom: 15px;
            text-align: justify;
          }
          
          .category-analysis {
            margin: 20px 0;
          }
          
          .category-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            background: #f8f9fa;
          }
          
          .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-weight: bold;
          }
          
          .category-rank {
            background: #C8B6FF;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
          }
          
          .category-insight {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
          }
          
          .recommendations {
            margin: 15px 0;
          }
          
          .recommendation {
            margin-bottom: 10px;
            padding: 10px;
            background: #e8f4fd;
            border-left: 4px solid #007bff;
            border-radius: 0 5px 5px 0;
          }
          
          .recommendation.urgent {
            background: #fff3cd;
            border-left-color: #ffc107;
          }
          
          .action-plan {
            margin: 20px 0;
          }
          
          .action-period {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
          }
          
          .action-period h5 {
            margin-top: 0;
            margin-bottom: 10px;
          }
          
          .action-period ul {
            margin-left: 20px;
          }
          
          .action-period li {
            margin-bottom: 5px;
          }
          
          .action-period li.urgent {
            color: #dc3545;
            font-weight: bold;
          }
          
          .question-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #C8B6FF;
            margin: 15px 0;
          }
          
          .question-section em {
            color: #666;
            font-style: italic;
          }
          
          .numbered-item, .bullet-item {
            margin-bottom: 8px;
            padding-left: 10px;
          }
          
          strong {
            color: #333;
            font-weight: bold;
          }
          
          .ai-content {
            margin: 20px 0;
          }
          
          .pdf-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            color: #666;
            font-size: 0.9em;
          }
          
          @media print {
            body {
              margin: 0;
              padding: 15px;
            }
            
            .pdf-header h1 {
              font-size: 2em;
            }
            
            .report-metrics {
              flex-direction: column;
              gap: 10px;
            }
            
            .metric {
              display: flex;
              justify-content: space-between;
              text-align: left;
            }
            
            .category-header {
              flex-direction: column;
              align-items: flex-start;
            }
            
            .action-period {
              break-inside: avoid;
            }
          }
        </style>
      </head>
      <body>
        <div class="pdf-header">
          <h1>FINZN</h1>
          <div class="subtitle">Informe Financiero Personalizado</div>
          <div class="date">Generado el ${new Date().toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"})}</div>
        </div>
        
        ${e}
        
        <div class="pdf-footer">
          <p>Informe generado por FINZN - Tu compaÃ±ero financiero inteligente</p>
          <p>Para mÃ¡s informaciÃ³n y herramientas financieras, visita tu dashboard de FINZN</p>
        </div>
      </body>
      </html>
    `}downloadAsHTML(e,t){try{const o=this.createPDFHTML(e,t),n=new Blob([o],{type:"text/html;charset=utf-8"}),i=`Informe_Financiero_FINZN_${new Date().toLocaleDateString("es-ES").replace(/\//g,"-")}.html`,r=document.createElement("a"),l=URL.createObjectURL(n);return r.setAttribute("href",l),r.setAttribute("download",i),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l),!0}catch(o){return console.error("Error downloading HTML:",o),!1}}formatCurrency(e){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}getPeriodText(e){return{current:"Mes Actual",last3:"Ãšltimos 3 Meses",last6:"Ãšltimos 6 Meses",year:"AÃ±o Completo"}[e]||"PerÃ­odo Seleccionado"}}class se{constructor(){this.currentTheme=localStorage.getItem("finzn-theme")||"light"}init(){this.applyTheme(this.currentTheme),this.updateToggleIcon()}toggle(){this.currentTheme=this.currentTheme==="light"?"dark":"light",this.applyTheme(this.currentTheme),this.updateToggleIcon(),localStorage.setItem("finzn-theme",this.currentTheme)}applyTheme(e){document.body.classList.remove("darkmode","lightmode"),e==="dark"?document.body.classList.add("darkmode"):document.body.classList.add("lightmode"),document.documentElement.setAttribute("data-theme",e)}updateToggleIcon(){const e=document.querySelector(".theme-icon");e&&(e.innerHTML=this.currentTheme==="light"?'<i class="ph ph-moon"></i>':'<i class="ph ph-sun"></i>')}}class ae{constructor(){this.currentSection="dashboard",this.mobileMenuOpen=!1,this.isTransitioning=!1,this.pendingTab=null}init(){this.setupNavigationEvents(),this.setupMobileMenu(),this.setupTabNavigation(),this.setupHeaderMenu(),this.showSection("dashboard")}setupNavigationEvents(){const e=document.querySelectorAll(".nav-item"),t=document.querySelectorAll(".mobile-nav-item");e.forEach(o=>{o.addEventListener("click",()=>{const n=o.getAttribute("data-section");n&&(this.showSection(n),this.setActiveNavItem(o),this.closeMobileMenu())})}),t.forEach(o=>{o.addEventListener("click",n=>{n.preventDefault();const s=o.getAttribute("data-section");s&&(this.showSection(s),this.setActiveMobileNavItem(o))})})}setupMobileMenu(){const e=document.getElementById("mobile-menu-toggle"),t=document.querySelector(".nav-menu");e&&t&&(e.addEventListener("click",()=>{this.toggleMobileMenu()}),document.addEventListener("click",o=>{!o.target.closest(".sidebar-nav")&&this.mobileMenuOpen&&this.closeMobileMenu()}))}setupTabNavigation(){document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",()=>{const o=t.getAttribute("data-tab");if(this.isTransitioning){this.pendingTab={name:o,button:t};return}this.switchTab(o,t)})})}setupHeaderMenu(){var c,d;const e=document.getElementById("header-menu-toggle"),t=document.getElementById("header-menu"),o=document.getElementById("header-menu-close");document.getElementById("header-menu-settings");const n=document.getElementById("header-menu-logout"),s=document.getElementById("header-theme-switch"),a=document.getElementById("menu-user-name"),i=document.getElementById("user-name");i&&a&&(a.textContent=i.textContent||"Usuario");const r=()=>t==null?void 0:t.classList.add("open"),l=()=>t==null?void 0:t.classList.remove("open");e==null||e.addEventListener("click",r),o==null||o.addEventListener("click",l),document.addEventListener("click",m=>{if(!t)return;!(m.target.closest("#header-menu")||m.target.closest("#header-menu-toggle"))&&t.classList.contains("open")&&l()}),document.addEventListener("keydown",m=>{m.key==="Escape"&&l()}),n==null||n.addEventListener("click",()=>{var m;(m=document.getElementById("logout-btn"))==null||m.click()});try{const m=((d=(c=window.app)==null?void 0:c.theme)==null?void 0:d.currentTheme)==="dark";typeof m=="boolean"&&s&&(s.checked=m)}catch{}s==null||s.addEventListener("change",()=>{var m,u,g;(g=(u=(m=window.app)==null?void 0:m.theme)==null?void 0:u.toggle)==null||g.call(u),setTimeout(()=>{var p,h;s.checked=((h=(p=window.app)==null?void 0:p.theme)==null?void 0:h.currentTheme)==="dark"},0)})}toggleMobileMenu(){const e=document.querySelector(".nav-menu"),t=document.getElementById("mobile-menu-toggle");e&&t&&(this.mobileMenuOpen=!this.mobileMenuOpen,this.mobileMenuOpen?(e.classList.add("mobile-open"),t.innerHTML='<div class="nav-icon"><i class="ph ph-x"></i></div><span class="nav-label">Cerrar</span>'):(e.classList.remove("mobile-open"),t.innerHTML='<div class="nav-icon"><i class="ph ph-list"></i></div><span class="nav-label">MenÃº</span>'))}closeMobileMenu(){const e=document.querySelector(".nav-menu"),t=document.getElementById("mobile-menu-toggle");e&&t&&this.mobileMenuOpen&&(this.mobileMenuOpen=!1,e.classList.remove("mobile-open"),t.innerHTML='<div class="nav-icon">ğŸ“Š</div><span class="nav-label">MenÃº</span>')}async switchTab(e,t){if(this.isTransitioning)return;this.isTransitioning=!0;const o=document.querySelector(".tab-content.active"),n=document.getElementById(`${e}-tab`);if(!n||o===n){this.isTransitioning=!1;return}if(this.setActiveTab(t),o&&(o.style.opacity="0",o.style.transform="translateX(-10px)",await new Promise(s=>setTimeout(s,300)),o.classList.remove("active"),o.style.transform=""),n.style.opacity="0",n.style.transform="translateX(10px)",n.classList.add("active"),n.offsetHeight,await new Promise(s=>setTimeout(s,50)),n.style.opacity="1",n.style.transform="translateX(0)",await new Promise(s=>setTimeout(s,400)),n.style.opacity="",n.style.transform="",this.isTransitioning=!1,this.pendingTab){const s=this.pendingTab;this.pendingTab=null,this.switchTab(s.name,s.button)}}setActiveTab(e){if(!e)return;document.querySelectorAll(".tab-btn").forEach(o=>{o.classList.remove("active")}),e.classList.add("active")}updateActiveNavigation(e){document.querySelectorAll(".nav-item").forEach(o=>{o.getAttribute("data-section")===e&&this.setActiveNavItem(o)})}async showSection(e){const t=document.querySelector(".dashboard-section.active"),o=document.getElementById(`${e}-section`);o&&(window.app&&window.app.animations&&t!==o?await window.app.animations.animatePageTransition(t,o):(document.querySelectorAll(".dashboard-section").forEach(s=>{s.classList.remove("active")}),o.classList.add("active")),this.currentSection=e,this.updatePageTitle(e),e==="calendar"&&window.app&&window.app.calendar&&setTimeout(async()=>{console.log("ğŸ“… Navigation: Calendar section activated, refreshing events..."),await window.app.calendar.loadEvents(),window.app.calendar.renderCalendar()},100),window.app&&window.app.animations&&setTimeout(()=>{window.app.animations.refreshAnimations()},400))}updatePageTitle(e){const o={dashboard:"Resumen General",transactions:"Transacciones",goals:"Objetivos de Ahorro",reports:"Reportes y AnÃ¡lisis",calendar:"Calendario Financiero",budgets:"GestiÃ³n de Presupuestos"}[e]||"FINZN";document.title=`${o} - FINZN`}setActiveNavItem(e){if(!e)return;const t=document.querySelectorAll(".nav-item"),o=document.querySelectorAll(".mobile-nav-item");t.forEach(s=>{s.classList.remove("active")}),o.forEach(s=>{s.classList.remove("active")}),e.classList.add("active");const n=e.getAttribute("data-section");if(n){const s=document.querySelector(`.mobile-nav-item[data-section="${n}"]`);s&&s.classList.add("active")}}setActiveMobileNavItem(e){const t=document.querySelectorAll(".mobile-nav-item"),o=document.querySelectorAll(".nav-item");t.forEach(s=>{s.classList.remove("active")}),o.forEach(s=>{s.classList.remove("active")}),e.classList.add("active");const n=e.getAttribute("data-section");if(n){const s=document.querySelector(`.nav-item[data-section="${n}"]`);s&&s.classList.add("active")}}}class ie{async listEvents(e,t,o){try{if(!e)return console.error("CalendarService: No userId provided"),{data:null,error:{message:"Usuario no autenticado"}};console.log("CalendarService: Querying events for user:",e),console.log("CalendarService: Date range:",t,"to",o);const{data:n,error:s}=await f.from("calendar_events").select("*").eq("user_id",e).gte("date",t).lte("date",o).order("date",{ascending:!0});return s?(console.error("CalendarService: Database error loading events:",s),{data:null,error:s}):(console.log("CalendarService: Query successful, found",(n||[]).length,"events"),{data:n||[],error:null})}catch(n){return console.error("CalendarService: Exception in listEvents:",n),{data:[],error:null}}}async createEvent(e){try{if(!e.user_id)return console.error("CalendarService: No user_id provided in event data"),{data:null,error:{message:"Usuario no autenticado"}};if(!f||!f.from)return console.log("CalendarService: Supabase not configured, creating mock event"),{data:{id:"mock_"+Date.now(),...e,created_at:new Date().toISOString()},error:null};const t={user_id:e.user_id,title:e.title,type:e.type,date:e.date,time:e.time||null,amount:e.amount?parseFloat(e.amount):null,description:e.description||null,recurring:e.recurring||!1,frequency:e.frequency||null,parent_id:e.parent_id||null,google_event_id:e.google_event_id||null,google_calendar_id:e.google_calendar_id||null,sync_source:e.sync_source||"finzn",last_synced_at:e.last_synced_at||null,sync_version:e.sync_version||1};console.log("CalendarService: Creating event with data:",t);const{data:o,error:n}=await f.from("calendar_events").insert([t]).select().single();return n?(console.error("CalendarService: Database error creating event:",n),n.message&&n.message.includes("calendar_events")?(console.log("CalendarService: calendar_events table not found, creating mock event"),{data:{id:"mock_"+Date.now(),...t,created_at:new Date().toISOString()},error:null}):{data:null,error:n}):(console.log("CalendarService: Event created successfully:",o),{data:o,error:null})}catch(t){return console.error("CalendarService: Exception in createEvent:",t),{data:{id:"mock_"+Date.now(),...e,created_at:new Date().toISOString()},error:null}}}async updateEvent(e,t){try{if(!e)return{data:null,error:{message:"ID de evento requerido"}};if(!f||!f.from)return console.log("CalendarService: Supabase not configured, creating mock update"),{data:{id:e,...t,updated_at:new Date().toISOString()},error:null};const o={};t.title!==void 0&&(o.title=t.title),t.type!==void 0&&(o.type=t.type),t.date!==void 0&&(o.date=t.date),t.time!==void 0&&(o.time=t.time||null),t.amount!==void 0&&(o.amount=t.amount?parseFloat(t.amount):null),t.description!==void 0&&(o.description=t.description||null),t.recurring!==void 0&&(o.recurring=t.recurring),t.frequency!==void 0&&(o.frequency=t.frequency||null),t.google_event_id!==void 0&&(o.google_event_id=t.google_event_id),t.google_calendar_id!==void 0&&(o.google_calendar_id=t.google_calendar_id),t.sync_source!==void 0&&(o.sync_source=t.sync_source),t.last_synced_at!==void 0&&(o.last_synced_at=t.last_synced_at),t.sync_version!==void 0&&(o.sync_version=t.sync_version);const{data:n,error:s}=await f.from("calendar_events").update(o).eq("id",e).select().single();return s?(console.error("Error updating calendar event:",s),s.message&&s.message.includes("calendar_events")?(console.log("CalendarService: calendar_events table not found, creating mock update"),{data:{id:e,...o,updated_at:new Date().toISOString()},error:null}):{data:null,error:s}):{data:n,error:null}}catch(o){return console.error("Error in updateEvent:",o),{data:{id:e,...t,updated_at:new Date().toISOString()},error:null}}}async deleteEvent(e){try{if(!e)return{data:!1,error:{message:"ID de evento requerido"}};if(!f||!f.from)return console.log("CalendarService: Supabase not configured, simulating delete"),{data:!0,error:null};const{error:t}=await f.from("calendar_events").delete().eq("id",e);return t?(console.error("Error deleting calendar event:",t),t.message&&t.message.includes("calendar_events")?(console.log("CalendarService: calendar_events table not found, simulating delete"),{data:!0,error:null}):{data:!1,error:t}):{data:!0,error:null}}catch(t){return console.error("Error in deleteEvent:",t),{data:!0,error:null}}}async createRecurringEvents(e,t=12){try{if(!e.recurring||!e.frequency)return{data:[],error:null};if(!f||!f.from)return console.log("CalendarService: Supabase not configured, creating mock recurring events"),{data:[],error:null};const o=new Date(e.date),n=new Date(o);n.setMonth(n.getMonth()+t);const s=[];let a=new Date(o);for(;a<=n;){if(e.frequency==="weekly")a.setDate(a.getDate()+7);else if(e.frequency==="monthly")a.setMonth(a.getMonth()+1);else if(e.frequency==="yearly")a.setFullYear(a.getFullYear()+1);else break;if(a<=n){const l={...e,date:a.toISOString().split("T")[0],parent_id:e.id};delete l.id,s.push(l)}}if(s.length===0)return{data:[],error:null};const{data:i,error:r}=await f.from("calendar_events").insert(s).select();return r?(console.error("Error creating recurring events:",r),r.message&&r.message.includes("calendar_events")?(console.log("CalendarService: calendar_events table not found, returning empty"),{data:[],error:null}):{data:null,error:r}):{data:i||[],error:null}}catch(o){return console.error("Error in createRecurringEvents:",o),{data:[],error:null}}}}const M=new ie;class S{static safeGetValue(e,t=""){const o=document.getElementById(e);return o?o.value:t}static safeSetValue(e,t){const o=document.getElementById(e);return o?(o.value=t,!0):(console.warn(`Element with ID '${e}' not found`),!1)}static safeGetText(e,t=""){const o=document.getElementById(e);return o?o.textContent:t}static safeSetText(e,t){const o=document.getElementById(e);return o?(o.textContent=t,!0):(console.warn(`Element with ID '${e}' not found`),!1)}static safeAddEventListener(e,t,o){const n=document.getElementById(e);return n?(n.addEventListener(t,o),!0):(console.warn(`Cannot add event listener: Element with ID '${e}' not found`),!1)}static safeGetElement(e){const t=document.getElementById(e);return t||console.warn(`Element with ID '${e}' not found`),t}static elementExists(e){return!!document.getElementById(e)}static safeGetFormData(e){const t=document.getElementById(e);if(!t)return console.warn(`Form with ID '${e}' not found`),{};const o=new FormData(t),n={};for(let[s,a]of o.entries())n[s]=a;return n}static cacheElements(e){const t={};return e.forEach(o=>{const n=document.getElementById(o);n?t[o]=n:console.warn(`Cannot cache: Element with ID '${o}' not found`)}),t}static onReady(e){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}}class re{constructor(e){this.calendar=e,this.syncQueue=new Map,this.preventSyncLoop=!1}async deleteEventWithSync(e){console.log("ğŸ—‘ï¸ Starting delete with sync for event:",e),console.log("ğŸ” DEBUG: Current events in calendar:",this.calendar.events.length),console.log("ğŸ” DEBUG: Google integration status:",this.calendar.googleCalendarIntegration),console.log("ğŸ” DEBUG: Access token available:",!!this.calendar.accessToken);try{const t=this.calendar.events.find(o=>o.id===e);if(console.log("ğŸ” DEBUG: Found event:",t?{id:t.id,title:t.title,google_event_id:t.google_event_id,sync_source:t.sync_source}:"EVENT NOT FOUND"),!t)throw new Error("Event not found in local calendar.events array");return t.google_event_id&&this.calendar.googleCalendarIntegration?(console.log("ğŸ” DEBUG: Attempting to delete from Google Calendar with ID:",t.google_event_id),await this.deleteFromGoogleCalendar(t.google_event_id)):(console.log("ğŸ” DEBUG: Skipping Google deletion - missing google_event_id or integration disabled"),console.log("ğŸ” DEBUG: google_event_id:",t.google_event_id),console.log("ğŸ” DEBUG: googleCalendarIntegration:",this.calendar.googleCalendarIntegration)),await this.calendar.deleteEvent(e),console.log("âœ… Event deleted successfully from both systems"),!0}catch(t){throw console.error("âŒ Error in deleteEventWithSync:",t),t}}async deleteFromGoogleCalendar(e){var t;if(!this.calendar.accessToken||!((t=window.gapi)!=null&&t.client)){console.log("â­ï¸ Skipping Google deletion - no access token or API");return}try{window.gapi.client.setToken({access_token:this.calendar.accessToken}),await window.gapi.client.calendar.events.delete({calendarId:"primary",eventId:e}),console.log("âœ… Event deleted from Google Calendar:",e)}catch(o){console.error("âŒ Error deleting from Google Calendar:",o)}}async addEventWithSync(e){console.log("â• Adding event with sync:",e.title);const t={...e,sync_source:e.sync_source||"finzn",sync_version:1,last_synced_at:new Date().toISOString()};return e.google_event_id&&(t.sync_source="google"),await this.calendar.addEvent(t)}findDuplicateEvent(e,t){return t.find(o=>{var c,d;if(e.google_event_id&&o.google_event_id)return e.google_event_id===o.google_event_id;if(e.google_event_id&&o.google_event_id===e.google_event_id)return console.log("ğŸ”„ Found existing event with same Google ID:",e.google_event_id),!0;const n=((c=o.title)==null?void 0:c.trim())===((d=e.title)==null?void 0:d.trim()),s=o.date===e.date,a=this.areTimesSimilar(o.time,e.time),i=this.areDescriptionsSimilar(o.description,e.description),r=!o.type||!e.type||o.type===e.type,l=n&&s&&a&&i&&r;return l&&console.log("ğŸ”„ Found duplicate by content:",{title:o.title,date:o.date,existingId:o.id,newGoogleId:e.google_event_id}),l})}areTimesSimilar(e,t){if(!e&&!t)return!0;if(!e||!t){const n=e||t;return!n||n==="00:00"||n.trim()===""}if(e===t)return!0;const o=n=>n?n.replace(/:\d{2}$/,"").trim():"";return o(e)===o(t)}areDescriptionsSimilar(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;const o=this.cleanDescriptionForComparison(e),n=this.cleanDescriptionForComparison(t);return o===n}cleanDescriptionForComparison(e){return e?e.replace(/Importado de Google Calendar/g,"").replace(/Exported to Google Calendar/g,"").replace(/\s+/g," ").trim():""}async enhancedImportFromGoogle(){var e,t,o;if(!(!this.calendar.googleCalendarIntegration||this.preventSyncLoop)){console.log("ğŸ“¥ Starting enhanced Google import...");try{this.preventSyncLoop=!0;const n=await this.getGoogleCalendarEvents();let s=0;const a=new Date;for(const i of n)try{const r=new Date(((e=i.start)==null?void 0:e.date)||((t=i.start)==null?void 0:t.dateTime));if(Math.abs((r-a)/(1e3*60*60*24))>90)continue;const c=this.convertGoogleToFinznEvent(i);if(!c)continue;if(this.calendar.events.find(g=>g.google_event_id===i.id)){console.log("â­ï¸ Skipping - already imported:",i.summary);continue}const m=this.calendar.getEventsForDate(new Date(c.date)),u=this.findDuplicateEvent(c,m);if(u){u.google_event_id||(await this.updateEventWithGoogleId(u.id,i.id),console.log("ğŸ”— Linked existing event to Google:",u.title));continue}await this.addEventWithSync({...c,google_event_id:i.id,sync_source:"google"}),s++,console.log("âœ… Imported:",i.summary)}catch(r){console.error("âŒ Error importing individual event:",r)}s>0&&(this.calendar.renderCalendar(),this.calendar.updateUpcomingEventsCount(),(o=window.app)!=null&&o.ui&&window.app.ui.showAlert(`âœ… ${s} eventos importados desde Google Calendar`,"success",3e3)),console.log(`ğŸ“¥ Import completed: ${s} new events`)}catch(n){console.error("âŒ Error in enhancedImportFromGoogle:",n)}finally{this.preventSyncLoop=!1}}}async getGoogleCalendarEvents(){var e;if(!this.calendar.accessToken||!((e=window.gapi)!=null&&e.client))return[];try{window.gapi.client.setToken({access_token:this.calendar.accessToken});const t=new Date,o=new Date(t.getTime()-30*24*60*60*1e3).toISOString(),n=new Date(t.getTime()+60*24*60*60*1e3).toISOString();return(await window.gapi.client.calendar.events.list({calendarId:"primary",timeMin:o,timeMax:n,maxResults:100,singleEvents:!0,orderBy:"startTime",showDeleted:!1})).result.items||[]}catch(t){return console.error("âŒ Error fetching Google Calendar events:",t),[]}}convertGoogleToFinznEvent(e){return this.calendar.convertGoogleToFinznEvent(e)}determineEventType(e){var s,a;const t=((s=e.summary)==null?void 0:s.toLowerCase())||"",o=((a=e.description)==null?void 0:a.toLowerCase())||"",n=`${t} ${o}`;return n.includes("pago")||n.includes("tarjeta")||n.includes("cuota")?"payment":n.includes("cobro")||n.includes("ingreso")||n.includes("sueldo")?"income":n.includes("cierre")||n.includes("vencimiento")?"deadline":(n.includes("recordatorio")||n.includes("reminder"),"reminder")}async updateEventWithGoogleId(e,t){var o,n;try{const s=(n=(o=window.app)==null?void 0:o.data)==null?void 0:n.calendarService;if(!s)return;const a={google_event_id:t,sync_source:"bidirectional",last_synced_at:new Date().toISOString()};await s.updateEvent(e,a);const i=this.calendar.events.findIndex(r=>r.id===e);i!==-1&&Object.assign(this.calendar.events[i],a)}catch(s){console.error("âŒ Error updating event with Google ID:",s)}}startSaferAutoSync(){this.stopAutoSync();const e=5*60*1e3;console.log("ğŸ”„ Starting safer auto-sync (every 5 minutes)"),this.calendar.autoSyncPollingInterval=setInterval(async()=>{try{!this.preventSyncLoop&&this.calendar.googleCalendarIntegration&&await this.enhancedImportFromGoogle()}catch(t){console.error("âŒ Auto-sync error:",t)}},e)}stopAutoSync(){this.calendar.autoSyncPollingInterval&&(clearInterval(this.calendar.autoSyncPollingInterval),this.calendar.autoSyncPollingInterval=null,console.log("ğŸ›‘ Auto-sync stopped"))}}const $={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1};class le{constructor(){this.currentDate=new Date,this.currentView="month",this.events=[],this.selectedDate=null,this.googleCalendarIntegration=!1,this.tokenClient=null,this.accessToken=null,this.tokenError=null,this.storageKey="finzn-google-calendar-sync",this.autoSyncEnabled=!1,this.autoSyncPollingInterval=null,this.lastSyncTime=null,this.autoSyncFrequency=3e4,this.lastEventCount=0,this.isAutoSyncing=!1,this.syncFix=new re(this)}init(){console.log("ğŸ“… Initializing Calendar Manager..."),console.log("ğŸ“… DEBUG: Calendar init started"),this.setupEventListeners(),console.log("ğŸ“… DEBUG: Event listeners setup completed"),this.renderCalendar(),console.log("ğŸ“… DEBUG: Calendar rendered"),this.loadEvents(),console.log("ğŸ“… DEBUG: Events loading initiated"),this.loadSyncState(),this.updateSyncButtonState(),this.setupVisibilityChangeListener(),console.log("ğŸ“… DEBUG: Sync button state updated")}setupEventListeners(){console.log("ğŸ“… DEBUG: Setting up event listeners...");const e=document.getElementById("prev-month"),t=document.getElementById("next-month");console.log("ğŸ“… DEBUG: Navigation buttons found:",{prevBtn:!!e,nextBtn:!!t}),e&&e.addEventListener("click",()=>this.previousMonth()),t&&t.addEventListener("click",()=>this.nextMonth());const o=document.querySelectorAll(".view-btn");console.log("ğŸ“… DEBUG: View buttons found:",o.length),o.forEach(g=>{g.addEventListener("click",p=>{const h=p.target.getAttribute("data-view");this.switchView(h)})});const n=document.getElementById("add-event-btn");console.log("ğŸ“… DEBUG: Add event button found:",!!n),n&&(console.log("ğŸ“… DEBUG: Add event button element:",n),console.log("ğŸ“… DEBUG: Add event button parent:",n.parentElement)),n&&(n.addEventListener("click",()=>this.showAddEventModal()),console.log("ğŸ“… DEBUG: Add event button listener attached"));const s=document.getElementById("add-event-for-day");s&&s.addEventListener("click",()=>this.showAddEventModalForSelectedDate());const a=document.getElementById("delete-all-day-events");a&&a.addEventListener("click",()=>this.confirmDeleteAllDayEvents());const i=document.getElementById("sync-google-calendar-btn");i&&i.addEventListener("click",()=>{this.googleCalendarIntegration?this.showGoogleSyncOptions():this.syncWithGoogleCalendar()});const r=document.getElementById("add-event-form");console.log("ğŸ“… DEBUG: Add event form found:",!!r),r&&(r.addEventListener("submit",g=>this.handleAddEvent(g)),console.log("ğŸ“… DEBUG: Add event form listener attached"));const l=document.getElementById("edit-event-form");l&&l.addEventListener("submit",g=>this.handleEditEvent(g));const c=document.getElementById("event-recurring"),d=document.getElementById("recurring-options");c&&d&&c.addEventListener("change",g=>{g.target.checked?d.classList.remove("hidden"):d.classList.add("hidden")});const m=document.getElementById("delete-event-btn");m&&m.addEventListener("click",()=>this.handleDeleteEvent());const u=document.getElementById("edit-event-from-details");u&&u.addEventListener("click",()=>this.editEventFromDetails()),console.log("ğŸ“… DEBUG: Event listeners setup completed")}updateSyncButtonState(){const e=document.getElementById("sync-google-calendar-btn");e&&(this.googleCalendarIntegration?(e.classList.add("connected"),e.innerHTML=`
        <i class="ph ph-check-circle" aria-hidden="true"></i> Sincronizado con Google
      `,e.title="Conectado con Google Calendar - Haz clic para ver opciones"):(e.classList.remove("connected"),e.innerHTML=`
        <i class="ph ph-arrows-clockwise" aria-hidden="true"></i> Sincronizar Google
      `,e.title="Sincronizar con Google Calendar"))}saveSyncState(){try{const e=this.getCurrentUserId();if(!e)return;const t={userId:e,isConnected:this.googleCalendarIntegration,autoSyncEnabled:this.autoSyncEnabled,connectedAt:this.googleCalendarIntegration?Date.now():null,version:"1.1"};localStorage.setItem(this.storageKey,JSON.stringify(t)),console.log("ğŸ“… DEBUG: Sync state saved to localStorage:",t)}catch(e){console.error("ğŸ“… ERROR: Failed to save sync state:",e)}}loadSyncState(){try{const e=this.getCurrentUserId();if(!e){console.log("ğŸ“… DEBUG: No user logged in, skipping sync state load");return}const t=localStorage.getItem(this.storageKey);if(!t){console.log("ğŸ“… DEBUG: No saved sync state found");return}const o=JSON.parse(t);if(o.userId!==e){console.log("ğŸ“… DEBUG: Saved sync state is for different user, clearing"),this.clearSyncState();return}if(o.connectedAt){const n=Date.now()-2592e6;if(o.connectedAt<n){console.log("ğŸ“… DEBUG: Sync state expired, clearing"),this.clearSyncState();return}}if(this.googleCalendarIntegration=o.isConnected||!1,this.autoSyncEnabled=o.autoSyncEnabled!==void 0?o.autoSyncEnabled:!1,this.googleCalendarIntegration){const n=$,s="VITE_GOOGLE_CLIENT_ID",a="VITE_GOOGLE_API_KEY",i=n[s],r=n[a];!i||!r?(console.log("ğŸ“… DEBUG: No credentials found, restoring demo mode"),this.accessToken="demo_token_restored_"+Date.now()):(console.log("ğŸ“… DEBUG: Credentials found, real Google integration will be initialized when needed"),this.accessToken=null)}console.log("ğŸ“… DEBUG: Sync state loaded from localStorage:",{isConnected:this.googleCalendarIntegration,mode:this.accessToken&&this.accessToken.startsWith("demo_token_")?"demo":"real",connectedAt:o.connectedAt?new Date(o.connectedAt).toLocaleString():"never"})}catch(e){console.error("ğŸ“… ERROR: Failed to load sync state:",e),this.clearSyncState()}}clearSyncState(){try{localStorage.removeItem(this.storageKey),this.googleCalendarIntegration=!1,console.log("ğŸ“… DEBUG: Sync state cleared")}catch(e){console.error("ğŸ“… ERROR: Failed to clear sync state:",e)}}renderCalendar(){const e=document.getElementById("calendar-grid"),t=document.getElementById("current-month-year");if(!e||!t)return;const o=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];t.textContent=`${o[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`,this.currentView==="month"?this.renderMonthView(e):this.currentView==="week"?this.renderWeekView(e):this.currentView==="agenda"&&this.renderAgendaView()}renderMonthView(e){e.innerHTML="",e.className="calendar-grid month-view",["Dom","Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b"].forEach(s=>{const a=document.createElement("div");a.className="calendar-day-header",a.textContent=s,e.appendChild(a)});const o=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),1);new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()+1,0);const n=new Date(o);n.setDate(n.getDate()-o.getDay());for(let s=0;s<42;s++){const a=new Date(n);a.setDate(n.getDate()+s);const i=this.createDayCell(a);e.appendChild(i)}}createDayCell(e){const t=document.createElement("div");t.className="calendar-day";const o=e.getMonth()===this.currentDate.getMonth(),n=this.isToday(e),s=this.getEventsForDate(e);o||t.classList.add("other-month"),n&&t.classList.add("today");const a=document.createElement("div");if(a.className="day-number",a.textContent=e.getDate(),t.appendChild(a),s.length>0){const i=document.createElement("div");if(i.className="day-events",s.slice(0,3).forEach(r=>{const l=document.createElement("div");l.className=`day-event ${r.type}`,l.textContent=r.title,l.addEventListener("click",c=>{c.stopPropagation(),this.showEventDetails(r.id)}),i.appendChild(l)}),s.length>3){const r=document.createElement("div");r.className="more-events",r.textContent=`+${s.length-3} mÃ¡s`,i.appendChild(r)}t.appendChild(i)}return t.addEventListener("click",()=>{console.log("ğŸ“… DEBUG: Calendar cell clicked, date:",e),this.selectedDate=e,s.length>0?this.showDayEventsModal(e,s):this.showAddEventModal(e)}),t}renderAgendaView(){const e=document.getElementById("calendar-grid"),t=document.getElementById("calendar-agenda");e&&e.classList.add("hidden"),t&&(t.classList.remove("hidden"),this.updateAgendaEvents())}updateAgendaEvents(){const e=document.getElementById("agenda-events");if(!e)return;e.innerHTML="";const t=this.events.filter(o=>{const n=new Date(o.date);return n.getMonth()===this.currentDate.getMonth()&&n.getFullYear()===this.currentDate.getFullYear()});if(t.sort((o,n)=>new Date(o.date)-new Date(n.date)),t.length===0){e.innerHTML=`
        <div class="empty-state">
          <div class="empty-icon">ğŸ“…</div>
          <h3>No hay eventos este mes</h3>
          <p>Agrega eventos financieros para mantener un control de tus fechas importantes</p>
        </div>
      `;return}t.forEach(o=>{const n=document.createElement("div");n.className=`agenda-event ${o.type}`;const a=new Date(o.date).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i=document.createElement("div");i.className="agenda-event-date",i.textContent=a;const r=document.createElement("div");r.className="agenda-event-details";const l=document.createElement("div");l.className="agenda-event-title",l.innerHTML=this.getEventTypeIcon(o.type)+" ";const c=document.createTextNode(o.title);l.appendChild(c);const d=document.createElement("div");if(d.className="agenda-event-description",d.textContent=o.description||"",r.appendChild(l),r.appendChild(d),o.amount){const p=document.createElement("div");p.className="agenda-event-amount",p.textContent=this.formatCurrency(o.amount),r.appendChild(p)}const m=document.createElement("div");m.className="agenda-event-actions";const u=document.createElement("button");u.className="btn btn-sm btn-secondary",u.textContent="Ver",u.addEventListener("click",()=>window.app.calendar.showEventDetails(o.id));const g=document.createElement("button");g.className="btn btn-sm btn-primary",g.textContent="Editar",g.addEventListener("click",()=>window.app.calendar.editEvent(o.id)),m.appendChild(u),m.appendChild(g),n.appendChild(i),n.appendChild(r),n.appendChild(m),e.appendChild(n)})}switchView(e){this.currentView=e,document.querySelectorAll(".view-btn").forEach(n=>{n.classList.remove("active")}),document.querySelector(`[data-view="${e}"]`).classList.add("active");const t=document.getElementById("calendar-grid"),o=document.getElementById("calendar-agenda");e==="agenda"?(t&&t.classList.add("hidden"),o&&o.classList.remove("hidden"),this.updateAgendaEvents()):(t&&t.classList.remove("hidden"),o&&o.classList.add("hidden"),this.renderCalendar())}previousMonth(){this.currentDate.setMonth(this.currentDate.getMonth()-1),this.renderCalendar(),this.loadEvents()}nextMonth(){this.currentDate.setMonth(this.currentDate.getMonth()+1),this.renderCalendar(),this.loadEvents()}showAddEventModal(e=null){console.log("ğŸ“… DEBUG: showAddEventModal called with date:",e);const t=document.getElementById("add-event-modal");console.log("ğŸ“… DEBUG: Modal element found:",!!t),t&&(console.log("ğŸ“… DEBUG: Modal element:",t),console.log("ğŸ“… DEBUG: Modal classes:",t.className));const o=document.getElementById("add-event-date");console.log("ğŸ“… DEBUG: Date input found:",!!o),e&&o&&(o.value=e.toISOString().split("T")[0],console.log("ğŸ“… DEBUG: Date set to:",o.value)),console.log("ğŸ“… DEBUG: window.app exists:",!!window.app),console.log("ğŸ“… DEBUG: window.app.modals exists:",!!(window.app&&window.app.modals)),window.app&&window.app.modals&&(console.log("ğŸ“… DEBUG: Calling window.app.modals.show"),window.app.modals.show("add-event-modal"),console.log("ğŸ“… DEBUG: Modal show called"))}async handleAddEvent(e){e.preventDefault(),console.log("ğŸ“… DEBUG: handleAddEvent called");const t=new FormData(e.target),o={title:t.get("title"),type:t.get("type"),date:t.get("date"),time:t.get("time"),amount:t.get("amount")?parseFloat(t.get("amount")):null,description:t.get("description"),recurring:t.get("recurring")==="on",frequency:t.get("frequency"),notification:t.get("notification")==="on"};if(console.log("ğŸ“… DEBUG: Event data to create:",o),!o.title||!o.type||!o.date){window.app&&window.app.ui&&window.app.ui.showAlert("Por favor completa todos los campos requeridos","error");return}try{await this.addEvent(o),e.target.reset(),window.app&&window.app.modals&&window.app.modals.hide("add-event-modal"),window.app&&window.app.ui&&window.app.ui.showAlert("Evento agregado exitosamente","success"),await this.loadEvents(),this.updateUpcomingEventsCount()}catch(n){console.error("Error adding event:",n),window.app&&window.app.ui&&window.app.ui.showAlert("Error al agregar el evento: "+(n.message||"Error desconocido"),"error")}}async addEvent(e){console.log("ğŸ“… DEBUG: addEvent called with:",e);const t=this.getCurrentUserId();if(console.log("ğŸ“… DEBUG: Current user ID:",t),!t){const n=new Error("Usuario no autenticado");throw console.error("ğŸ“… ERROR: No authenticated user"),window.app&&window.app.ui&&window.app.ui.showAlert("Usuario no autenticado","error"),n}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)){const n=new Error("ID de usuario invÃ¡lido");throw console.error("ğŸ“… ERROR: Invalid UUID format for user ID:",t),window.app&&window.app.ui&&window.app.ui.showAlert("ID de usuario invÃ¡lido","error"),n}try{const n={user_id:t,title:e.title,type:e.type,date:e.date,time:e.time,amount:e.amount,description:e.description,recurring:e.recurring||!1,frequency:e.frequency};console.log("ğŸ“… DEBUG: Calling calendarService.createEvent with:",n);const{data:s,error:a}=await M.createEvent(n);if(console.log("ğŸ“… DEBUG: calendarService.createEvent response:",{data:s,error:a}),a){console.error("ğŸ“… ERROR: Creating calendar event:",a);const i=a.message||"Error desconocido al crear el evento";throw window.app&&window.app.ui&&window.app.ui.showAlert("Error al crear el evento: "+i,"error"),new Error(i)}if(!s)throw console.error("ğŸ“… ERROR: No data returned from createEvent"),new Error("No se pudo crear el evento - sin datos de respuesta");return this.events.unshift(s),console.log("ğŸ“… DEBUG: Event added to local array. Total events:",this.events.length),console.log("ğŸ“… DEBUG: Local events array:",this.events.map(i=>({id:i.id,title:i.title,date:i.date}))),s.recurring&&s.frequency&&(console.log("ğŸ“… DEBUG: Creating recurring events..."),await this.createRecurringEventsInDB(s)),console.log("ğŸ“… DEBUG: Reloading events after creation to verify persistence..."),await this.loadEvents(),console.log("ğŸ“… DEBUG: Refreshing calendar display..."),this.renderCalendar(),s}catch(n){console.error("ğŸ“… ERROR: Exception in addEvent:",n);const s=n.message||"Error desconocido";throw new Error(s)}}async createRecurringEventsInDB(e){try{const{data:t,error:o}=await M.createRecurringEvents(e);if(o){console.error("Error creating recurring events:",o);return}t&&t.length>0&&this.events.push(...t)}catch(t){console.error("Error in createRecurringEventsInDB:",t)}}createRecurringEvents(e){console.log("ğŸ“… Using database-based recurring events")}async updateEvent(e,t){if(!this.getCurrentUserId())throw window.app&&window.app.ui&&window.app.ui.showAlert("Usuario no autenticado","error"),new Error("Usuario no autenticado");try{const{data:n,error:s}=await M.updateEvent(e,t);if(s)throw console.error("Error updating calendar event:",s),window.app&&window.app.ui&&window.app.ui.showAlert("Error al actualizar el evento","error"),s;const a=this.events.findIndex(i=>i.id===e);return a!==-1&&(this.events[a]=n),n}catch(n){throw console.error("Error in updateEvent:",n),window.app&&window.app.ui&&window.app.ui.showAlert("Error al actualizar el evento","error"),n}}async deleteEvent(e){if(!this.getCurrentUserId())throw window.app&&window.app.ui&&window.app.ui.showAlert("Usuario no autenticado","error"),new Error("Usuario no autenticado");try{const{data:o,error:n}=await M.deleteEvent(e);if(n)throw console.error("Error deleting calendar event:",n),window.app&&window.app.ui&&window.app.ui.showAlert("Error al eliminar el evento","error"),n;return this.events=this.events.filter(s=>s.id!==e),!0}catch(o){throw console.error("Error in deleteEvent:",o),window.app&&window.app.ui&&window.app.ui.showAlert("Error al eliminar el evento","error"),o}}async addEventLegacy(e){const t=this.getCurrentUserId();if(!t)throw new Error("Usuario no autenticado");const o={id:this.generateId(),user_id:t,title:e.title,type:e.type,date:e.date,time:e.time,amount:e.amount,description:e.description,recurring:e.recurring,frequency:e.frequency,created_at:new Date().toISOString()};return this.events.push(o),o.recurring&&o.frequency&&this.createRecurringEvents(o),o}showEventDetails(e){console.log("ğŸ“… DEBUG: showEventDetails called with ID:",e);const t=this.events.find(i=>i.id===e);if(!t){console.error("ğŸ“… ERROR: Event not found with ID:",e),console.log("ğŸ“… DEBUG: Available events:",this.events.map(i=>({id:i.id,title:i.title}))),window.app&&window.app.ui&&window.app.ui.showAlert("Evento no encontrado","error");return}console.log("ğŸ“… DEBUG: Found event:",t);const o=document.getElementById("event-details-modal"),n=document.getElementById("event-details-content"),s=document.getElementById("event-details-title");if(s&&(s.textContent=t.title),n){const r=new Date(t.date).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});n.innerHTML="";const l=document.createElement("div");l.className="event-detail-item";const c=document.createElement("strong");c.textContent="Tipo: ";const d=document.createElement("span");d.innerHTML=this.getEventTypeIcon(t.type);const m=document.createTextNode(" "+this.getEventTypeName(t.type));l.appendChild(c),l.appendChild(d),l.appendChild(m),n.appendChild(l);const u=document.createElement("div");u.className="event-detail-item";const g=document.createElement("strong");g.textContent="Fecha: ";const p=document.createTextNode(r);if(u.appendChild(g),u.appendChild(p),n.appendChild(u),t.time){const h=document.createElement("div");h.className="event-detail-item";const E=document.createElement("strong");E.textContent="Hora: ";const w=document.createTextNode(t.time);h.appendChild(E),h.appendChild(w),n.appendChild(h)}if(t.amount){const h=document.createElement("div");h.className="event-detail-item";const E=document.createElement("strong");E.textContent="Monto: ";const w=document.createTextNode(this.formatCurrency(t.amount));h.appendChild(E),h.appendChild(w),n.appendChild(h)}if(t.description){const h=document.createElement("div");h.className="event-detail-item",h.innerHTML='<strong>DescripciÃ³n:</strong> <span class="event-description-text"></span>',n.appendChild(h)}if(t.recurring){const h=document.createElement("div");h.className="event-detail-item";const E=document.createElement("strong");E.textContent="Recurrencia: ";const w=document.createTextNode(this.getFrequencyName(t.frequency));h.appendChild(E),h.appendChild(w),n.appendChild(h)}if(t.description){const h=n.querySelector(".event-description-text");h&&(h.textContent=t.description)}}o&&(o.dataset.eventId=e);const a=document.getElementById("day-events-modal");a&&!a.classList.contains("hidden")&&window.app&&window.app.modals&&window.app.modals.hide("day-events-modal"),window.app&&window.app.modals&&setTimeout(()=>{window.app.modals.show("event-details-modal")},100)}editEvent(e){console.log("ğŸ“… DEBUG: editEvent called with ID:",e);const t=this.events.find(n=>n.id===e);if(!t){console.error("ğŸ“… ERROR: Event not found for editing:",e),window.app&&window.app.ui&&window.app.ui.showAlert("Evento no encontrado","error");return}console.log("ğŸ“… DEBUG: Found event for editing:",t),S.safeSetValue("edit-event-title",t.title),S.safeSetValue("edit-event-type",t.type),S.safeSetValue("edit-event-date",t.date),S.safeSetValue("edit-event-time",t.time||""),S.safeSetValue("edit-event-amount",t.amount||""),S.safeSetValue("edit-event-description",t.description||"");const o=S.safeGetElement("edit-event-modal");o&&(o.dataset.eventId=e),window.app&&window.app.modals&&window.app.modals.show("edit-event-modal")}editEventFromDetails(){const e=document.getElementById("event-details-modal"),t=e==null?void 0:e.dataset.eventId;t&&(window.app&&window.app.modals&&window.app.modals.hide("event-details-modal"),this.editEvent(t))}async handleEditEvent(e){e.preventDefault();const t=document.getElementById("edit-event-modal"),o=t==null?void 0:t.dataset.eventId;if(!o)return;const n=new FormData(e.target),s={title:n.get("title"),type:n.get("type"),date:n.get("date"),time:n.get("time"),amount:n.get("amount")?parseFloat(n.get("amount")):null,description:n.get("description")};try{await this.updateEvent(o,s),window.app&&window.app.modals&&window.app.modals.hide("edit-event-modal"),window.app&&window.app.ui&&window.app.ui.showAlert("Evento actualizado exitosamente","success"),this.renderCalendar()}catch(a){console.error("Error updating event:",a),window.app&&window.app.ui&&window.app.ui.showAlert("Error al actualizar el evento","error")}}async handleDeleteEvent(){const e=document.getElementById("edit-event-modal"),t=e==null?void 0:e.dataset.eventId;if(t&&confirm("Â¿EstÃ¡s seguro de que quieres eliminar este evento?"))try{await this.syncFix.deleteEventWithSync(t),window.app&&window.app.modals&&window.app.modals.hide("edit-event-modal"),window.app&&window.app.ui&&window.app.ui.showAlert("Evento eliminado exitosamente","success"),this.renderCalendar(),this.updateUpcomingEventsCount()}catch(o){console.error("Error deleting event:",o),window.app&&window.app.ui&&window.app.ui.showAlert("Error al eliminar el evento","error")}}async loadEvents(){const e=this.getCurrentUserId();if(!e){console.log("ğŸ“… No user authenticated, skipping event loading"),this.events=[],this.updateUpcomingEventsCount();return}if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)){console.warn("ğŸ“… Invalid UUID format for user ID:",e),this.events=[],this.updateUpcomingEventsCount();return}try{console.log("ğŸ“… Loading calendar events from Supabase..."),console.log("ğŸ“… DEBUG: User ID:",e);const o=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),1),n=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()+1,0),s=new Date(o);s.setMonth(s.getMonth()-1);const a=new Date(n);a.setMonth(a.getMonth()+1);const i=s.toISOString().split("T")[0],r=a.toISOString().split("T")[0];console.log("ğŸ“… DEBUG: Loading events from",i,"to",r);const{data:l,error:c}=await M.listEvents(e,i,r);if(c){console.error("ğŸ“… ERROR: Loading calendar events:",c),window.app&&window.app.ui&&window.app.ui.showAlert("Error al cargar eventos del calendario: "+(c.message||"Error desconocido"),"error");return}if(this.events=l||[],console.log("ğŸ“… SUCCESS: Calendar events loaded:",this.events.length,"items"),console.log("ğŸ“… DEBUG: Events data:",this.events),this.events.length>0){console.log("ğŸ“… DEBUG: First few events loaded:",this.events.slice(0,3).map(m=>({id:m.id,title:m.title,date:m.date,user_id:m.user_id,google_event_id:m.google_event_id,sync_source:m.sync_source})));const d=this.events.filter(m=>m.google_event_id);console.log("ğŸ“… DEBUG: Events with Google IDs:",d.length,"out of",this.events.length)}else console.log("ğŸ“… DEBUG: No events found for user in database");this.renderCalendar(),this.updateUpcomingEventsCount()}catch(o){console.error("ğŸ“… ERROR: Exception in loadEvents:",o),window.app&&window.app.ui&&window.app.ui.showAlert("Error al cargar eventos del calendario: "+(o.message||"Error desconocido"),"error")}}updateUpcomingEventsCount(){const e=document.getElementById("upcoming-events");if(!e)return;const t=new Date,o=new Date;o.setDate(t.getDate()+7);const n=this.events.filter(i=>{const r=new Date(i.date);return r>=t&&r<=o}),s=parseInt(e.textContent)||0,a=n.length;s!==a&&(e.classList.add("updated"),setTimeout(()=>{e.classList.remove("updated")},500)),e.textContent=a,e.style.display=a>0?"flex":"none"}getEventsForDate(e){const t=e.toISOString().split("T")[0],o=this.events.filter(n=>n.date===t);return o.length>0&&console.log(`ğŸ“… DEBUG: Found ${o.length} events for date ${t}:`,o.map(n=>n.title)),o}isToday(e){const t=new Date;return e.toDateString()===t.toDateString()}async syncWithGoogleCalendar(){const e=$,t="VITE_GOOGLE_CLIENT_ID",o="VITE_GOOGLE_API_KEY",n=e[t],s=e[o];if(console.log("ğŸ” Google Calendar Configuration Check:"),console.log("ğŸ“‹ Environment variables available:",Object.keys(e).filter(l=>l.includes("GOOGLE"))),console.log("ğŸ”‘ Client ID configured:",!!n),console.log("ğŸ—ï¸ API Key configured:",!!s),!n||!s){console.log("âš ï¸ Google Calendar not configured"),console.log("ğŸ’¡ To configure Google Calendar:"),console.log("   1. Get credentials from Google Cloud Console"),console.log("   2. Set VITE_GOOGLE_CLIENT_ID in .env file"),console.log("   3. Set VITE_GOOGLE_API_KEY in .env file"),window.app&&window.app.ui&&window.app.ui.showAlert(`
            <div style="text-align: left;">
              <strong>Google Calendar no estÃ¡ configurado</strong><br><br>
              Para habilitar la sincronizaciÃ³n necesitas:<br>
              1. Credenciales de Google Cloud Console<br>
              2. Variables VITE_GOOGLE_CLIENT_ID y VITE_GOOGLE_API_KEY<br><br>
              <small>Consulta la documentaciÃ³n para mÃ¡s detalles</small>
            </div>
          `,"warning",8e3);return}const a=window.location.host;if(!["localhost","127.0.0.1","finzn.netlify.app"].some(l=>a.includes(l))){console.log("âš ï¸ Current domain not authorized for Google Calendar"),window.app&&window.app.ui&&window.app.ui.showAlert("Google Calendar solo estÃ¡ disponible en el dominio autorizado.","warning");return}try{window.app&&window.app.ui&&window.app.ui.showAlert("Conectando con Google Calendar...","info"),await this.initGoogleAPI(n,s),this.showGoogleSyncOptions()}catch(l){console.error("Error connecting to Google Calendar:",l);let c="Error al conectar con Google Calendar";l.error==="popup_blocked_by_browser"?c="El navegador bloqueÃ³ la ventana emergente. Permite ventanas emergentes para este sitio.":l.error==="access_denied"?c="Acceso denegado. Verifica que tengas permisos para Google Calendar.":l.error==="idpiframe_initialization_failed"?c="Dominio no autorizado. Agrega este dominio en Google Cloud Console > Credenciales > OAuth 2.0":l.details&&l.details.includes("API key")?c="Error con la API key de Google. Verifica la configuraciÃ³n.":l.details&&l.details.includes("Client ID")&&(c="Error con el Client ID de Google. Verifica la configuraciÃ³n."),window.app&&window.app.ui&&window.app.ui.showAlert(c,"error")}}async initGoogleAPI(e,t){return new Promise((o,n)=>{var a;console.log("ğŸš€ Initializing Google Calendar API..."),console.log("ğŸ”‘ Using Client ID:",e?`${e.substring(0,20)}...`:"undefined"),console.log("ğŸ—ï¸ Using API Key:",t?`${t.substring(0,10)}...`:"undefined");const s=[];if((a=window.google)!=null&&a.accounts)console.log("âœ… Google Identity Services already available");else{console.log("ğŸ“¥ Loading Google Identity Services...");const i=document.createElement("script");i.src="https://accounts.google.com/gsi/client",i.onload=()=>{var r,l;console.log("âœ… Google Identity Services loaded successfully"),console.log("ğŸ” GIS available methods:",Object.keys(((l=(r=window.google)==null?void 0:r.accounts)==null?void 0:l.oauth2)||{}))},i.onerror=r=>{console.error("âŒ Failed to load Google Identity Services:",r),n(new Error("Failed to load Google Identity Services"))},document.head.appendChild(i),s.push(new Promise((r,l)=>{i.onload=r,i.onerror=l}))}if(window.gapi)console.log("âœ… Google API Client already available");else{console.log("ğŸ“¥ Loading Google API Client...");const i=document.createElement("script");i.src="https://apis.google.com/js/api.js",i.onload=()=>{console.log("âœ… Google API Client loaded successfully"),console.log("ğŸ” GAPI available methods:",Object.keys(window.gapi||{}))},i.onerror=r=>{console.error("âŒ Failed to load Google API Client:",r),n(new Error("Failed to load Google API Client"))},document.head.appendChild(i),s.push(new Promise((r,l)=>{i.onload=r,i.onerror=l}))}Promise.all(s).then(()=>{console.log("ğŸ“š Loading Google API Client modules..."),window.gapi.load("client",()=>{console.log("ğŸ”§ Initializing Google API Client..."),window.gapi.client.init({apiKey:t,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]}).then(()=>{console.log("âœ… Google API Client initialized"),console.log("ğŸ” Available API methods:",Object.keys(window.gapi.client||{})),console.log("ğŸ”§ Setting up OAuth2 token client...");try{this.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:e,scope:"https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar",callback:i=>{if(console.log("ğŸ“§ Token callback received:",i),i.error!==void 0){console.error("âŒ Token request error:",i),this.tokenError=i;return}console.log("âœ… Google Calendar API token received"),this.accessToken=i.access_token,window.gapi.client.setToken({access_token:i.access_token})}}),console.log("âœ… Google Calendar API initialized with GIS successfully"),o()}catch(i){console.error("âŒ Error setting up token client:",i),n(i)}}).catch(i=>{console.error("âŒ Google API client initialization error:",i),i.details&&console.error("ğŸ” Error details:",i.details),n(i)})})}).catch(i=>{console.error("âŒ Failed to load Google API scripts:",i),n(i)})})}showGoogleSyncOptions(){this.setupGoogleSyncModalListeners(),window.app&&window.app.modals&&window.app.modals.show("google-sync-modal")}setupGoogleSyncModalListeners(){const e=document.getElementById("connect-google-btn");e&&(e.removeEventListener("click",this.handleConnectGoogle),this.googleCalendarIntegration?(e.innerHTML=`
          <i class="ph ph-x-circle"></i>
          <div class="btn-content">
            <span>Desconectar Google</span>
            <small>Desactivar sincronizaciÃ³n con Google Calendar</small>
          </div>
        `,e.className="btn btn-danger sync-action-btn",this.handleConnectGoogle=()=>this.disconnectGoogle()):(e.innerHTML=`
          <i class="ph ph-key"></i>
          <div class="btn-content">
            <span>Conectar con Google</span>
            <small>Autorizar acceso a tu calendario</small>
          </div>
        `,e.className="btn btn-primary sync-action-btn",this.handleConnectGoogle=()=>this.authenticateGoogle()),e.addEventListener("click",this.handleConnectGoogle));const t=document.getElementById("import-google-btn");t&&(t.removeEventListener("click",this.handleImportGoogle),this.handleImportGoogle=()=>this.importFromGoogle(),t.addEventListener("click",this.handleImportGoogle));const o=document.getElementById("export-google-btn");o&&(o.removeEventListener("click",this.handleExportGoogle),this.handleExportGoogle=()=>this.exportToGoogle(),o.addEventListener("click",this.handleExportGoogle));const n=document.getElementById("auto-sync-toggle");n&&(n.addEventListener("change",s=>this.handleAutoSyncToggle(s.target.checked)),this.updateAutoSyncToggleState())}async authenticateGoogle(){try{if(!this.tokenClient){console.log("ğŸ”§ Token client not found, checking configuration...");const e=$,t="VITE_GOOGLE_CLIENT_ID",o="VITE_GOOGLE_API_KEY",n=e[t],s=e[o];if((!n||!s)&&(console.log("âš ï¸ No Google credentials found, checking if user wants demo mode..."),!!1))throw new Error("Google credentials not configured");if(console.log("ğŸ”§ Initializing Google API with real credentials..."),await this.initGoogleAPI(n,s),!this.tokenClient)throw new Error("Failed to initialize token client")}return this.accessToken=null,this.tokenError=null,this.tokenClient.requestAccessToken(),new Promise((e,t)=>{const o=()=>{this.accessToken?(console.log("âœ… Google authentication successful"),window.app&&window.app.ui&&window.app.ui.showAlert("Â¡Conectado con Google Calendar exitosamente!","success"),this.googleCalendarIntegration=!0,this.saveSyncState(),this.updateSyncButtonState(),window.app&&window.app.modals&&window.app.modals.hide("google-sync-modal"),e()):this.tokenError?t(this.tokenError):setTimeout(o,100)};o(),setTimeout(()=>{!this.accessToken&&!this.tokenError&&t(new Error("Authentication timeout"))},3e4)})}catch(e){throw console.error("Google authentication error:",e),window.app&&window.app.ui&&window.app.ui.showAlert("Error al autenticar con Google","error"),e}}async disconnectGoogle(){try{if(console.log("ğŸ”Œ Disconnecting from Google Calendar..."),window.google&&window.google.accounts&&window.google.accounts.oauth2)try{this.accessToken&&window.google.accounts.oauth2.revoke(this.accessToken)}catch(e){console.warn("Could not revoke token:",e)}this.googleCalendarIntegration=!1,this.accessToken=null,this.tokenError=null,this.tokenClient=null,this.clearSyncState(),this.updateSyncButtonState(),window.app&&window.app.modals&&window.app.modals.hide("google-sync-modal"),window.app&&window.app.ui&&window.app.ui.showAlert("Desconectado de Google Calendar exitosamente","success"),console.log("âœ… Successfully disconnected from Google Calendar")}catch(e){console.error("Error disconnecting from Google Calendar:",e),window.app&&window.app.ui&&window.app.ui.showAlert("Error al desconectar de Google Calendar","error")}}async importFromGoogle(){return this.googleCalendarIntegration||await this.authenticateGoogle(),this.accessToken&&this.accessToken.startsWith("demo_token_")?this.demoImportFromGoogle():this.syncFix.enhancedImportFromGoogle()}async legacyImportFromGoogle(){try{if(this.accessToken||(console.log("ğŸ“¥ No access token found, re-authenticating..."),await this.authenticateGoogle()),!this.accessToken||!window.gapi||!window.gapi.client)throw new Error("Google API not properly initialized or no access token");this.accessToken&&window.gapi.client.setToken({access_token:this.accessToken}),console.log("ğŸ“¥ Starting import from Google Calendar...");const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+3,0),n=await window.gapi.client.calendar.events.list({calendarId:"primary",timeMin:t.toISOString(),timeMax:o.toISOString(),maxResults:100,singleEvents:!0,orderBy:"startTime"});console.log("ğŸ“¥ Google Calendar API response:",n);const s=n.result.items||[];console.log(`ğŸ“¥ Found ${s.length} events in Google Calendar`);let a=0,i=0;for(const l of s){console.log("ğŸ“¥ Processing Google event:",l.summary);const c=this.convertGoogleToFinznEvent(l);if(c)try{this.getEventsForDate(new Date(c.date)).find(u=>u.title===c.title&&u.date===c.date&&u.description&&u.description.includes("Importado de Google Calendar"))?(i++,console.log(`â­ï¸ Skipped duplicate: ${c.title}`)):(await this.addEvent(c),a++,console.log(`âœ… Imported: ${c.title}`))}catch(d){console.error("Error importing individual event:",d)}}const r=i>0?`${a} eventos importados, ${i} omitidos (duplicados)`:`${a} eventos importados de Google Calendar`;window.app&&window.app.ui&&window.app.ui.showAlert(r,"success"),window.app&&window.app.modals&&window.app.modals.hide("google-sync-modal"),await this.loadEvents(),this.renderCalendar(),this.updateUpcomingEventsCount()}catch(e){console.error("Error importing from Google Calendar:",e);let t="Error al importar eventos";e.message.includes("not properly initialized")?t="Google Calendar no estÃ¡ configurado correctamente. Intenta reconectarte.":e.status===401?(t="SesiÃ³n expirada. Intenta reconectarte con Google.",this.googleCalendarIntegration=!1,this.clearSyncState(),this.updateSyncButtonState()):e.status===403&&(t="Sin permisos para acceder a Google Calendar. Verifica los permisos."),window.app&&window.app.ui&&window.app.ui.showAlert(t,"error")}}async exportToGoogle(){if(this.googleCalendarIntegration||await this.authenticateGoogle(),this.accessToken&&this.accessToken.startsWith("demo_token_"))return this.demoExportToGoogle();try{if(this.accessToken||(console.log("ğŸ“¤ No access token found, re-authenticating..."),await this.authenticateGoogle()),!this.accessToken||!window.gapi||!window.gapi.client)throw new Error("Google API not properly initialized or no access token");this.accessToken&&window.gapi.client.setToken({access_token:this.accessToken}),console.log("ğŸ“¤ Starting export to Google Calendar..."),console.log(`ğŸ“¤ Found ${this.events.length} local events to potentially export`);let e=0,t=0;for(const n of this.events)try{if(n.description&&n.description.includes("Importado de Google Calendar")){t++,console.log(`â­ï¸ Skipped Google-imported event: ${n.title}`);continue}console.log("ğŸ“¤ Processing local event:",n.title);const s=this.convertFinznToGoogleEvent(n),a=await window.gapi.client.calendar.events.insert({calendarId:"primary",resource:s});console.log(`âœ… Exported: ${n.title}`,a),e++}catch(s){console.error("Error exporting individual event:",s)}const o=t>0?`${e} eventos exportados, ${t} omitidos (importados de Google)`:`${e} eventos exportados a Google Calendar`;window.app&&window.app.ui&&window.app.ui.showAlert(o,"success"),window.app&&window.app.modals&&window.app.modals.hide("google-sync-modal")}catch(e){console.error("Error exporting to Google Calendar:",e);let t="Error al exportar eventos";e.message.includes("not properly initialized")?t="Google Calendar no estÃ¡ configurado correctamente. Intenta reconectarte.":e.status===401?(t="SesiÃ³n expirada. Intenta reconectarte con Google.",this.googleCalendarIntegration=!1,this.clearSyncState(),this.updateSyncButtonState()):e.status===403&&(t="Sin permisos para escribir en Google Calendar. Verifica los permisos."),window.app&&window.app.ui&&window.app.ui.showAlert(t,"error")}}convertGoogleToFinznEvent(e){var i,r,l,c;if(!e.summary)return console.log("âš ï¸ Skipping Google event without summary:",e),null;const t=((i=e.start)==null?void 0:i.dateTime)||((r=e.start)==null?void 0:r.date);if(!t)return console.log("âš ï¸ Skipping Google event without start date:",e),null;const o=new Date(t),n=e.summary.replace(/ğŸ’°\s?/,""),s=e.description||"",a=s.includes("Exportado desde FINZN")?s:`${s}

Importado de Google Calendar`.trim();return console.log("ğŸ“¥ Converting Google event:",{original:e.summary,cleaned:n,date:o.toISOString().split("T")[0],hasTime:!!((l=e.start)!=null&&l.dateTime)}),{title:n,type:this.detectEventType(n,a),date:o.toISOString().split("T")[0],time:(c=e.start)!=null&&c.dateTime?o.toTimeString().split(" ")[0].slice(0,5):null,description:a,amount:null,recurring:!1,frequency:null,google_event_id:e.id,sync_source:"google"}}convertFinznToGoogleEvent(e){const t=e.time?`${e.date}T${e.time}:00`:e.date,o=e.time?`${e.date}T${this.addHour(e.time)}:00`:e.date;return{summary:`ğŸ’° ${e.title}`,description:`${e.description||""}

Exportado desde FINZN`,start:e.time?{dateTime:t,timeZone:"America/Argentina/Buenos_Aires"}:{date:e.date},end:e.time?{dateTime:o,timeZone:"America/Argentina/Buenos_Aires"}:{date:e.date}}}detectEventType(e="",t=""){const o=(e+" "+t).toLowerCase();return o.includes("pago")||o.includes("cuota")||o.includes("factura")||o.includes("bill")?"payment":o.includes("cobro")||o.includes("ingreso")||o.includes("sueldo")||o.includes("salary")?"income":o.includes("tarjeta")||o.includes("cierre")||o.includes("credit card")||o.includes("card")?"card-close":o.includes("vencimiento")||o.includes("deadline")||o.includes("due")||o.includes("plazo")?"deadline":"reminder"}addHour(e){const[t,o]=e.split(":").map(Number);return`${((t+1)%24).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}async testGoogleIntegration(){console.log("ğŸ§ª Starting Google Calendar demo mode...");try{this.googleCalendarIntegration=!0,this.accessToken="demo_token_"+Date.now(),this.saveSyncState(),this.updateSyncButtonState(),window.app&&window.app.ui&&window.app.ui.showAlert("ğŸ§ª Modo demo activado - Google Calendar simulado","success"),this.showGoogleSyncOptions()}catch(e){console.error("Error in demo mode:",e),window.app&&window.app.ui&&window.app.ui.showAlert("Error en modo demo","error")}}async demoImportFromGoogle(){console.log("ğŸ§ª Demo: Importing from Google Calendar...");try{const e=[{title:"Pago de Tarjeta de CrÃ©dito",type:"payment",date:new Date().toISOString().split("T")[0],time:"10:00",description:"Evento demo importado de Google Calendar",amount:null,recurring:!1,frequency:null},{title:"ReuniÃ³n de Trabajo",type:"reminder",date:new Date(Date.now()+864e5).toISOString().split("T")[0],time:"14:30",description:"Evento demo importado de Google Calendar",amount:null,recurring:!1,frequency:null},{title:"Vencimiento Servicios",type:"deadline",date:new Date(Date.now()+1728e5).toISOString().split("T")[0],time:null,description:"Evento demo importado de Google Calendar",amount:null,recurring:!1,frequency:null}];let t=0;for(const o of e)try{this.getEventsForDate(new Date(o.date)).find(a=>a.title===o.title&&a.date===o.date)||(await this.addEvent(o),t++)}catch(n){console.error("Error adding demo event:",n)}window.app&&window.app.ui&&window.app.ui.showAlert(`ğŸ§ª Demo: ${t} eventos importados simulados`,"success"),window.app&&window.app.modals&&window.app.modals.hide("google-sync-modal"),await this.loadEvents(),this.renderCalendar(),this.updateUpcomingEventsCount()}catch(e){console.error("Error in demo import:",e),window.app&&window.app.ui&&window.app.ui.showAlert("Error en importaciÃ³n demo","error")}}async demoExportToGoogle(){console.log("ğŸ§ª Demo: Exporting to Google Calendar...");try{const e=this.events.filter(t=>!t.description||!t.description.includes("Evento demo importado de Google Calendar"));window.app&&window.app.ui&&window.app.ui.showAlert(`ğŸ§ª Demo: ${e.length} eventos exportados simulados`,"success"),window.app&&window.app.modals&&window.app.modals.hide("google-sync-modal")}catch(e){console.error("Error in demo export:",e),window.app&&window.app.ui&&window.app.ui.showAlert("Error en exportaciÃ³n demo","error")}}async autoExportEventToGoogle(e){if(!(!this.googleCalendarIntegration||!e))try{if(console.log("ğŸ”„ Auto-exporting event to Google Calendar:",e.title),e.description&&(e.description.includes("Importado de Google Calendar")||e.description.includes("Evento demo importado de Google Calendar"))){console.log("â­ï¸ Skipping auto-export of Google-imported event");return}if(this.accessToken&&this.accessToken.startsWith("demo_token_")){console.log("ğŸ§ª Demo mode: Simulating auto-export to Google Calendar"),window.app&&window.app.ui&&window.app.ui.showAlert(`ğŸ”„ Auto-sincronizado: "${e.title}" enviado a Google Calendar`,"info",3e3);return}try{if(!this.accessToken){console.log("â­ï¸ No access token for auto-sync, skipping");return}if(!window.gapi||!window.gapi.client){console.log("â­ï¸ Google API not loaded for auto-sync, skipping");return}window.gapi.client.setToken({access_token:this.accessToken});const t=this.convertFinznToGoogleEvent(e),o=await window.gapi.client.calendar.events.insert({calendarId:"primary",resource:t});console.log("âœ… Auto-exported event to Google Calendar:",o),window.app&&window.app.ui&&window.app.ui.showAlert(`ğŸ”„ Auto-sincronizado: "${e.title}" enviado a Google Calendar`,"success",3e3)}catch(t){console.error("âŒ Error in auto-export:",t)}}catch(t){console.error("âŒ Error in autoExportEventToGoogle:",t)}}startAutoSync(){console.log("âš ï¸ Auto-sync is disabled. Use manual sync only.")}stopAutoSync(){this.syncFix.stopAutoSync()}async autoImportFromGoogle(){if(!(!this.googleCalendarIntegration||!this.autoSyncEnabled||this.isAutoSyncing)){this.isAutoSyncing=!0;try{if(this.accessToken&&this.accessToken.startsWith("demo_token_")){Math.random()<.05&&console.log("ğŸ§‘â€ğŸ’» Demo mode: Simulating Google Calendar change detection"),this.isAutoSyncing=!1;return}if(!this.accessToken||!window.gapi||!window.gapi.client){this.isAutoSyncing=!1;return}const e=new Date,t=this.lastSyncTime?new Date(Math.max(new Date(this.lastSyncTime).getTime()-5*60*1e3,e.getTime()-7*24*60*60*1e3)).toISOString():new Date(e.getTime()-24*60*60*1e3).toISOString(),o=new Date(e.getTime()+30*24*60*60*1e3).toISOString();window.gapi.client.setToken({access_token:this.accessToken});const s=(await window.gapi.client.calendar.events.list({calendarId:"primary",timeMin:t,timeMax:o,maxResults:50,singleEvents:!0,orderBy:"updated",showDeleted:!0})).result.items||[];let a=0,i=!1;const r=s.filter(l=>l.status!=="cancelled").length;this.lastEventCount!==0&&r!==this.lastEventCount&&(i=!0,console.log(`ğŸ” Change detected: Event count changed from ${this.lastEventCount} to ${r}`)),this.lastEventCount=r;for(const l of s){if(l.status==="cancelled")continue;const c=this.convertGoogleToFinznEvent(l);if(c&&!this.getEventsForDate(new Date(c.date)).find(u=>{const g=u.title===c.title,p=u.date===c.date,h=!u.time&&!c.time||u.time===c.time,E=u.description&&u.description.includes("Importado de Google Calendar");return g&&p&&h&&E}))try{const u=this.autoSyncEnabled;this.autoSyncEnabled=!1,await this.addEvent(c),a++,i=!0,this.autoSyncEnabled=u}catch(u){console.error("âŒ Error importing individual event:",u)}}this.lastSyncTime=new Date().toISOString(),a>0?(console.log(`âœ… Auto-imported ${a} new events from Google Calendar`),window.app&&window.app.ui&&window.app.ui.showAlert(`ğŸ”„ ${a} eventos nuevos sincronizados desde Google Calendar`,"success",3e3),this.renderCalendar(),this.updateUpcomingEventsCount()):i&&console.log("ğŸ” Changes detected in Google Calendar but no new events to import")}catch(e){console.error("âŒ Error in auto-import:",e)}finally{this.isAutoSyncing=!1}}}getCurrentUserId(){if(console.log("ğŸ“… DEBUG: Getting current user ID..."),console.log("ğŸ“… DEBUG: window.app exists:",!!window.app),console.log("ğŸ“… DEBUG: window.app.auth exists:",!!(window.app&&window.app.auth)),!window.app||!window.app.auth)return console.warn("ğŸ“… WARNING: window.app.auth not available, using fallback"),localStorage.getItem("finzn_user_id")||null;try{const e=window.app.auth.getCurrentUserId();return console.log("ğŸ“… DEBUG: Retrieved user ID:",e),e||null}catch(e){return console.error("ğŸ“… ERROR: Failed to get user ID:",e),null}}generateId(){return"event_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}getEventTypeIcon(e){return{payment:"ğŸ’³",income:"ğŸ’°","card-close":"ğŸ¦",reminder:"â°",deadline:"ğŸ“…"}[e]||"ğŸ“…"}getEventTypeName(e){return{payment:"Pago de Cuota",income:"Cobro","card-close":"Cierre de Tarjeta",reminder:"Recordatorio",deadline:"Vencimiento"}[e]||"Evento"}getFrequencyName(e){return{weekly:"Semanal",monthly:"Mensual",yearly:"Anual"}[e]||"Una vez"}formatCurrency(e){return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}showDayEventsModal(e,t){console.log("ğŸ“… DEBUG: showDayEventsModal called",{date:e,events:t});const o=document.getElementById("day-events-modal"),n=document.getElementById("day-events-date"),s=document.getElementById("day-events-list");if(!o||!n||!s){console.error("ğŸ“… ERROR: Day events modal elements not found");return}const a=e.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"});n.textContent=a.charAt(0).toUpperCase()+a.slice(1),this.populateDayEventsList(s,t),this.updateDeleteAllButtonVisibility(t.length>0),window.app&&window.app.modals&&window.app.modals.show("day-events-modal")}populateDayEventsList(e,t){if(e.innerHTML="",t.length===0){e.innerHTML=`
        <div class="day-events-empty">
          <div class="empty-icon">ğŸ“…</div>
          <h3>No hay eventos para este dÃ­a</h3>
          <p>Haz clic en "Agregar Evento" para crear uno nuevo</p>
        </div>
      `;return}t.forEach(o=>{const n=document.createElement("div");n.className=`day-event-item ${o.type}`,n.innerHTML=`
        <div class="day-event-details">
          <div class="day-event-title">${this.escapeHtml(o.title)}</div>
          <div class="day-event-meta">
            <span class="day-event-type">
              ${this.getEventTypeIcon(o.type)} ${this.getEventTypeName(o.type)}
            </span>
            ${o.time?`<span>ğŸ• ${this.escapeHtml(o.time)}</span>`:""}
            ${o.amount?`<span class="day-event-amount">${this.formatCurrency(o.amount)}</span>`:""}
          </div>
          ${o.description?`<div class="day-event-description">${this.escapeHtml(o.description)}</div>`:""}
        </div>
        <div class="day-event-actions">
          <button class="btn btn-sm btn-secondary view-event-btn" data-event-id="${o.id}">
            <i class="ph ph-eye"></i> Ver
          </button>
          <button class="btn btn-sm btn-primary edit-event-btn" data-event-id="${o.id}">
            <i class="ph ph-pencil"></i> Editar
          </button>
          <button class="btn btn-sm btn-danger delete-event-btn" data-event-id="${o.id}">
            <i class="ph ph-trash"></i>
          </button>
        </div>
      `,e.appendChild(n);const s=n.querySelector(".view-event-btn"),a=n.querySelector(".edit-event-btn"),i=n.querySelector(".delete-event-btn");s&&s.addEventListener("click",r=>{r.stopPropagation(),console.log("ğŸ“… DEBUG: View button clicked for event:",o.id),this.showEventDetails(o.id)}),a&&a.addEventListener("click",r=>{r.stopPropagation(),console.log("ğŸ“… DEBUG: Edit button clicked for event:",o.id),window.app&&window.app.modals&&window.app.modals.hide("day-events-modal"),setTimeout(()=>{this.editEvent(o.id)},100)}),i&&i.addEventListener("click",r=>{r.stopPropagation(),console.log("ğŸ“… DEBUG: Delete button clicked for event:",o.id),this.confirmDeleteEvent(o.id)})})}showAddEventModalForSelectedDate(){console.log("ğŸ“… DEBUG: showAddEventModalForSelectedDate called"),window.app&&window.app.modals&&window.app.modals.hide("day-events-modal"),setTimeout(()=>{this.showAddEventModal(this.selectedDate)},100)}confirmDeleteEvent(e){confirm("Â¿EstÃ¡s seguro de que quieres eliminar este evento?")&&this.deleteEventFromDay(e)}confirmDeleteAllDayEvents(){if(!this.selectedDate){window.app&&window.app.ui&&window.app.ui.showAlert("No hay fecha seleccionada","error");return}const e=this.getEventsForDate(this.selectedDate);if(e.length===0){window.app&&window.app.ui&&window.app.ui.showAlert("No hay eventos para eliminar en este dÃ­a","info");return}const t=this.selectedDate.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),o=e.length,n=`Â¿EstÃ¡s seguro de que quieres eliminar TODOS los ${o} evento${o>1?"s":""} del ${t}?

Esta acciÃ³n no se puede deshacer.`;confirm(n)&&this.deleteAllEventsForDay(e)}async deleteAllEventsForDay(e){if(!e||e.length===0)return;let t=0,o=0;const n=e.length;window.app&&window.app.ui&&window.app.ui.showAlert(`Eliminando ${n} eventos...`,"info",2e3);for(const s of e)try{await this.syncFix.deleteEventWithSync(s.id),t++}catch(a){console.error("Error deleting event:",s.id,a),o++}if(t>0){this.renderCalendar(),this.updateUpcomingEventsCount();let s=`${t} evento${t>1?"s":""} eliminado${t>1?"s":""} exitosamente`;o>0&&(s+=`. ${o} evento${o>1?"s":""} no pudo${o>1?"n":""} ser eliminado${o>1?"s":""}.`),window.app&&window.app.ui&&window.app.ui.showAlert(s,o>0?"warning":"success"),window.app&&window.app.modals&&window.app.modals.hide("day-events-modal")}else window.app&&window.app.ui&&window.app.ui.showAlert("No se pudo eliminar ningÃºn evento","error")}updateDeleteAllButtonVisibility(e){const t=document.getElementById("delete-all-day-events");t&&(e?(t.style.display="inline-flex",t.style.opacity="1"):(t.style.display="none",t.style.opacity="0"))}async deleteEventFromDay(e){try{await this.syncFix.deleteEventWithSync(e),window.app&&window.app.ui&&window.app.ui.showAlert("Evento eliminado exitosamente","success"),this.renderCalendar(),this.updateUpcomingEventsCount();const t=document.getElementById("day-events-modal");if(t&&!t.classList.contains("hidden")){const o=this.getEventsForDate(this.selectedDate),n=document.getElementById("day-events-list");this.populateDayEventsList(n,o),this.updateDeleteAllButtonVisibility(o.length>0),o.length===0&&window.app.modals.hide("day-events-modal")}}catch(t){console.error("Error deleting event:",t),window.app&&window.app.ui&&window.app.ui.showAlert("Error al eliminar el evento","error")}}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}animateButtonClick(e){e.style.transform="scale(0.95)",e.style.transition="transform 0.1s ease",setTimeout(()=>{e.style.transform=""},100)}animateElementEntrance(e,t="fadeInUp",o=0){e.style.opacity="0",e.style.animation=`${t} 0.5s ease-out forwards`,e.style.animationDelay=`${o}s`}animateCalendarRefresh(){const e=document.getElementById("calendar-grid");e&&(e.style.opacity="0",e.style.transform="translateY(10px)",e.style.transition="all 0.3s ease",setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},50))}renderCalendarWithAnimation(){const e=document.getElementById("calendar-grid");e&&e.classList.add("calendar-loading"),this.renderCalendar(),setTimeout(()=>{e&&e.classList.remove("calendar-loading")},300)}setupVisibilityChangeListener(){console.log("ğŸ‘ï¸ Auto-sync disabled - sync manually when needed")}updateAutoSyncToggleState(){const e=document.getElementById("auto-sync-toggle");e&&(e.checked=this.autoSyncEnabled)}handleAutoSyncToggle(e){var t;if(console.log("ğŸ”„ Auto-sync toggle changed:",e),e){(t=window.app)!=null&&t.ui&&window.app.ui.showAlert("La sincronizaciÃ³n automÃ¡tica estÃ¡ deshabilitada. Usa el botÃ³n de sincronizaciÃ³n manual.","info");const o=document.getElementById("auto-sync-toggle");o&&(o.checked=!1);return}this.autoSyncEnabled=!1,this.saveSyncState()}}class ce{constructor(){this.budgets=[],this.currentMonth=this.getCurrentMonth()}getCurrentMonth(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`}getCurrentUserId(){var e,t;return((t=(e=window.app)==null?void 0:e.auth)==null?void 0:t.getCurrentUserId())||null}async loadBudgets(){const e=this.getCurrentUserId();if(!e)return[];try{console.log("ğŸ’° Loading budgets for user:",e);const{supabase:t}=await L(async()=>{const{supabase:s}=await Promise.resolve().then(()=>B);return{supabase:s}},void 0,import.meta.url),{data:o,error:n}=await t.from("budgets").select("*").eq("user_id",e).in("status",["active","paused"]).order("created_at",{ascending:!1});return n?n.code==="42P01"||n.message&&n.message.includes('relation "public.budgets" does not exist')?(console.error('âŒ Budget Error: Tabla "budgets" no encontrada en Supabase. Verifica que las migraciones se hayan ejecutado correctamente.'),console.warn('âš ï¸ Tabla "budgets" no encontrada en Supabase. CrÃ©ala manualmente en tu dashboard.'),[]):(console.error("âŒ Budget Error: Error al cargar presupuestos desde Supabase:",{code:n.code,message:n.message,details:n.details,hint:n.hint,userId:e}),console.error("Error loading budgets:",n),[]):(this.budgets=o||[],console.log("ğŸ’° Budgets loaded:",this.budgets.length,"items"),this.budgets.length===0&&console.log("â„¹ï¸ Budget Info: No se encontraron presupuestos para el usuario. Esto es normal para usuarios nuevos."),this.budgets)}catch(t){return console.error("âŒ Budget Error: ExcepciÃ³n al cargar presupuestos:",{error:t.message,stack:t.stack,userId:e}),console.error("Error in loadBudgets:",t),[]}}async addBudget(e){const t=this.getCurrentUserId();if(!t)return!1;try{console.log("ğŸ’° Adding budget:",e);const{supabase:o}=await L(async()=>{const{supabase:i}=await Promise.resolve().then(()=>B);return{supabase:i}},void 0,import.meta.url),n={user_id:t,name:e.name,category:e.category,amount:parseFloat(e.amount),start_date:e.start_date,end_date:e.end_date,status:"active",ai_recommended:e.ai_recommended||!1},{data:s,error:a}=await o.from("budgets").insert([n]).select();return a?a.code==="42P01"||a.message&&a.message.includes('relation "public.budgets" does not exist')?(console.error('âŒ Budget Error: No se puede agregar presupuesto - tabla "budgets" no existe. Ejecuta las migraciones de Supabase.'),console.warn('âš ï¸ Tabla "budgets" no encontrada. No se puede agregar presupuesto.'),!1):(console.error("âŒ Budget Error: Fallo al insertar presupuesto en Supabase:",{code:a.code,message:a.message,details:a.details,budgetData:n,userId:t}),console.error("Error adding budget:",a),!1):!s||s.length===0?(console.error("âŒ Budget Error: Supabase no devolviÃ³ datos despuÃ©s de insertar el presupuesto"),!1):(console.log("âœ… Budget added successfully:",s[0]),this.budgets.unshift(s[0]),!0)}catch(o){return console.error("âŒ Budget Error: ExcepciÃ³n al agregar presupuesto:",{error:o.message,stack:o.stack,budgetData:e,userId:t}),console.error("Error in addBudget:",o),!1}}async updateBudget(e,t){const o=this.getCurrentUserId();if(!o)return!1;try{console.log("ğŸ’° Updating budget:",e,t);const{supabase:n}=await L(async()=>{const{supabase:r}=await Promise.resolve().then(()=>B);return{supabase:r}},void 0,import.meta.url),{data:s,error:a}=await n.from("budgets").update(t).eq("id",e).eq("user_id",o).select();if(a)return a.code==="42P01"||a.message&&a.message.includes('relation "public.budgets" does not exist')?(console.error('âŒ Budget Error: No se puede actualizar presupuesto - tabla "budgets" no existe.'),console.warn('âš ï¸ Tabla "budgets" no encontrada. No se puede actualizar presupuesto.'),!1):(console.error("âŒ Budget Error: Fallo al actualizar presupuesto en Supabase:",{code:a.code,message:a.message,details:a.details,budgetId:e,updates:t,userId:o}),console.error("Error updating budget:",a),!1);if(!s||s.length===0)return console.error("âŒ Budget Error: No se encontrÃ³ el presupuesto para actualizar o no se devolvieron datos"),!1;const i=this.budgets.findIndex(r=>r.id===e);return i!==-1?this.budgets[i]={...this.budgets[i],...s[0]}:console.warn("âš ï¸ Budget Warning: Presupuesto actualizado en Supabase pero no encontrado en datos locales"),console.log("âœ… Budget updated successfully"),!0}catch(n){return console.error("âŒ Budget Error: ExcepciÃ³n al actualizar presupuesto:",{error:n.message,stack:n.stack,budgetId:e,updates:t,userId:o}),console.error("Error in updateBudget:",n),!1}}async deleteBudget(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{supabase:o}=await L(async()=>{const{supabase:a}=await Promise.resolve().then(()=>B);return{supabase:a}},void 0,import.meta.url),{error:n}=await o.from("budgets").delete().eq("id",e).eq("user_id",t);if(n)return n.code==="42P01"||n.message&&n.message.includes('relation "public.budgets" does not exist')?(console.error('âŒ Budget Error: No se puede eliminar presupuesto - tabla "budgets" no existe.'),console.warn('âš ï¸ Tabla "budgets" no encontrada. No se puede eliminar presupuesto.'),!1):(console.error("âŒ Budget Error: Fallo al eliminar presupuesto de Supabase:",{code:n.code,message:n.message,details:n.details,budgetId:e,userId:t}),console.error("Error deleting budget:",n),!1);const s=this.budgets.length;return this.budgets=this.budgets.filter(a=>a.id!==e),this.budgets.length===s&&console.warn("âš ï¸ Budget Warning: Presupuesto eliminado de Supabase pero no se encontrÃ³ en datos locales"),console.log("âœ… Budget deleted successfully"),!0}catch(o){return console.error("âŒ Budget Error: ExcepciÃ³n al eliminar presupuesto:",{error:o.message,stack:o.stack,budgetId:e,userId:t}),console.error("Error in deleteBudget:",o),!1}}calculateBudgetProgress(e,t){if(!e||!t)return e||console.warn("âš ï¸ Budget Warning: calculateBudgetProgress llamado sin presupuesto vÃ¡lido"),t||console.warn("âš ï¸ Budget Warning: calculateBudgetProgress llamado sin datos de gastos"),{spent:0,remaining:0,percentage:0,status:"safe"};const o=t.filter(r=>{const l=new Date(r.transaction_date),c=new Date(e.start_date),d=new Date(e.end_date);return r.category===e.category&&l>=c&&l<=d}),n=o.reduce((r,l)=>r+parseFloat(l.amount),0),s=e.amount-n,a=n/e.amount*100;let i="safe";return a>=100?i="exceeded":a>=80?i="warning":a>=60&&(i="caution"),{spent:n,remaining:s,percentage:Math.min(a,100),status:i,expenseCount:o.length}}getBudgetsWithProgress(e=[]){return this.budgets.map(t=>({...t,progress:this.calculateBudgetProgress(t,e)}))}getActiveBudgets(){const e=new Date;return this.budgets.filter(t=>{const o=new Date(t.end_date);return t.status==="active"&&o>=e})}getBudgetsByCategory(e){return this.budgets.filter(t=>t.category===e)}hasBudgetForCategory(e){return this.getActiveBudgets().some(o=>o.category===e)}getBudgetAlerts(e=[]){const t=[];return this.getBudgetsWithProgress(e).forEach(n=>{const{progress:s}=n;s.status==="exceeded"?t.push({type:"danger",budgetId:n.id,category:n.category,message:`Has superado el presupuesto de ${n.category}`,spent:s.spent,limit:n.amount,percentage:s.percentage}):s.status==="warning"&&t.push({type:"warning",budgetId:n.id,category:n.category,message:`Te acercas al lÃ­mite del presupuesto de ${n.category}`,spent:s.spent,limit:n.amount,percentage:s.percentage})}),t}getBudgetSummary(e=[]){const t=this.getBudgetsWithProgress(e),o=t.length,n=t.reduce((r,l)=>r+l.amount,0),s=t.reduce((r,l)=>r+l.progress.spent,0),a=n-s,i={safe:0,caution:0,warning:0,exceeded:0};return t.forEach(r=>{i[r.progress.status]++}),{totalBudgets:o,totalBudgetAmount:n,totalSpent:s,totalRemaining:a,overallPercentage:n>0?s/n*100:0,statusCounts:i,activeBudgets:this.getActiveBudgets().length}}getBudgetsForAI(){return this.budgets.map(e=>({id:e.id,name:e.name,category:e.category,amount:e.amount,start_date:e.start_date,end_date:e.end_date,status:e.status,ai_recommended:e.ai_recommended}))}getBudgets(){return this.budgets}}class de{constructor(){this.currentProfile=null}async init(){console.log("ğŸ‘¤ Initializing User Profile Manager..."),await this.loadUserProfile(),this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("edit-profile-btn");e&&e.addEventListener("click",()=>this.showEditProfileModal());const t=document.getElementById("complete-profile-form");t&&t.addEventListener("submit",n=>this.handleCompleteProfile(n));const o=document.getElementById("edit-profile-form");o&&o.addEventListener("submit",n=>this.handleEditProfile(n))}async loadUserProfile(){const e=this.getCurrentUserId();if(!e)return null;try{const{supabase:t}=await L(async()=>{const{supabase:s}=await Promise.resolve().then(()=>B);return{supabase:s}},void 0,import.meta.url);await this.ensureUserProfilesTableExists();const{data:o,error:n}=await t.from("user_profiles").select("*").eq("user_id",e).single();return n?n.code==="PGRST116"?(console.log("ğŸ‘¤ No profile found for user, will need to create one"),this.currentProfile=null,null):(console.error("Error loading user profile:",n),n.message&&n.message.includes('relation "public.user_profiles" does not exist')&&(console.error("âŒ La tabla user_profiles no existe en Supabase. Por favor, ejecuta las migraciones o crÃ©ala manualmente."),window.app&&window.app.ui&&window.app.ui.showAlert("Error: Tabla de perfiles no encontrada. Contacta al administrador.","error")),null):(this.currentProfile=o,this.updateHeaderDisplay(),this.currentProfile)}catch(t){return console.error("Error in loadUserProfile:",t),null}}async createUserProfile(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{supabase:o}=await L(async()=>{const{supabase:i}=await Promise.resolve().then(()=>B);return{supabase:i}},void 0,import.meta.url);await this.ensureUserProfilesTableExists();const n={user_id:t,display_name:`${e.first_name} ${e.last_name}`.trim(),first_name:e.first_name,last_name:e.last_name},{data:s,error:a}=await o.from("user_profiles").insert([n]).select().single();return a?(console.error("Error creating user profile:",a),a.code==="23505"?(console.log("ğŸ‘¤ Profile exists, trying to update instead"),await this.updateUserProfile(e)):!1):(this.currentProfile=s,this.updateHeaderDisplay(),!0)}catch(o){return console.error("Error in createUserProfile:",o),!1}}async updateUserProfile(e){const t=this.getCurrentUserId();if(!t)return!1;try{const{supabase:o}=await L(async()=>{const{supabase:i}=await Promise.resolve().then(()=>B);return{supabase:i}},void 0,import.meta.url);await this.ensureUserProfilesTableExists();const n={display_name:`${e.first_name} ${e.last_name}`.trim(),first_name:e.first_name,last_name:e.last_name,updated_at:new Date().toISOString()},{data:s,error:a}=await o.from("user_profiles").update(n).eq("user_id",t).select().single();return a?(console.error("Error updating user profile:",a),a.code==="PGRST116"?(console.log("ğŸ‘¤ No profile to update, creating new one"),await this.createUserProfile(e)):!1):(this.currentProfile=s,this.updateHeaderDisplay(),!0)}catch(o){return console.error("Error in updateUserProfile:",o),!1}}async ensureUserProfilesTableExists(){try{const{supabase:e}=await L(async()=>{const{supabase:o}=await Promise.resolve().then(()=>B);return{supabase:o}},void 0,import.meta.url),{error:t}=await e.from("user_profiles").select("id").limit(1);if(t&&t.message&&t.message.includes('relation "public.user_profiles" does not exist')){console.log("ğŸ“ Creating user_profiles table via SQL...");const o=`
          CREATE TABLE IF NOT EXISTS user_profiles (
            id uuid PRIMARY KEY DEFAULT gen_random_uuid(), 
            user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
            display_name text NOT NULL DEFAULT '',
            first_name text DEFAULT '',
            last_name text DEFAULT '',
            phone text,
            avatar_url text,
            bio text,
            preferences jsonb DEFAULT '{}',
            created_at timestamptz DEFAULT now(),
            updated_at timestamptz DEFAULT now()
          );
          
          ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
          
          DROP POLICY IF EXISTS "Users can view their own profile" ON user_profiles;
          CREATE POLICY "Users can view their own profile"
            ON user_profiles
            FOR SELECT
            TO authenticated
            USING (auth.uid() = user_id);
          
          DROP POLICY IF EXISTS "Users can insert their own profile" ON user_profiles;
          CREATE POLICY "Users can insert their own profile"
            ON user_profiles
            FOR INSERT
            TO authenticated
            WITH CHECK (auth.uid() = user_id);
          
          DROP POLICY IF EXISTS "Users can update their own profile" ON user_profiles;
          CREATE POLICY "Users can update their own profile"
            ON user_profiles
            FOR UPDATE
            TO authenticated
            USING (auth.uid() = user_id)
            WITH CHECK (auth.uid() = user_id);
          
          DROP POLICY IF EXISTS "Users can delete their own profile" ON user_profiles;
          CREATE POLICY "Users can delete their own profile"
            ON user_profiles
            FOR DELETE
            TO authenticated
            USING (auth.uid() = user_id);
          
          CREATE INDEX IF NOT EXISTS idx_user_profiles_user_id ON user_profiles(user_id);
        `,{error:n}=await e.rpc("exec_sql",{sql:o});n?console.warn("âš ï¸ Could not create user_profiles table automatically. Please create it manually in Supabase."):console.log("âœ… User profiles table created successfully")}}catch{console.log("â„¹ï¸ Table check completed, proceeding...")}}showCompleteProfileModal(){console.log("ğŸ‘¤ Showing complete profile modal");const e=document.getElementById("complete-profile-form");e&&e.reset(),window.app&&window.app.modals&&window.app.modals.show("complete-profile-modal")}showEditProfileModal(){if(console.log("ğŸ‘¤ Showing edit profile modal"),this.currentProfile){const e=document.getElementById("edit-first-name"),t=document.getElementById("edit-last-name");e&&(e.value=this.currentProfile.first_name||""),t&&(t.value=this.currentProfile.last_name||"")}window.app&&window.app.modals&&window.app.modals.show("edit-profile-modal")}async handleCompleteProfile(e){var n,s;e.preventDefault(),console.log("ğŸ‘¤ Handling complete profile...");const t=new FormData(e.target),o={first_name:((n=t.get("first_name"))==null?void 0:n.trim())||"",last_name:((s=t.get("last_name"))==null?void 0:s.trim())||""};if(!o.first_name||!o.last_name){window.app&&window.app.ui&&window.app.ui.showAlert("Por favor completa tu nombre y apellido","error");return}try{await this.createUserProfile(o)?(window.app&&window.app.modals&&window.app.modals.hide("complete-profile-modal"),window.app&&window.app.ui&&window.app.ui.showAlert("Â¡Perfil completado exitosamente!","success")):window.app&&window.app.ui&&window.app.ui.showAlert("Error al completar el perfil","error")}catch(a){console.error("Error completing profile:",a),window.app&&window.app.ui&&window.app.ui.showAlert("Error al completar el perfil","error")}}async handleEditProfile(e){var n,s;e.preventDefault(),console.log("ğŸ‘¤ Handling edit profile...");const t=new FormData(e.target),o={first_name:((n=t.get("first_name"))==null?void 0:n.trim())||"",last_name:((s=t.get("last_name"))==null?void 0:s.trim())||""};if(!o.first_name||!o.last_name){window.app&&window.app.ui&&window.app.ui.showAlert("Por favor completa tu nombre y apellido","error");return}try{await this.updateUserProfile(o)?(window.app&&window.app.modals&&window.app.modals.hide("edit-profile-modal"),window.app&&window.app.ui&&window.app.ui.showAlert("Perfil actualizado exitosamente","success")):window.app&&window.app.ui&&window.app.ui.showAlert("Error al actualizar el perfil","error")}catch(a){console.error("Error editing profile:",a),window.app&&window.app.ui&&window.app.ui.showAlert("Error al actualizar el perfil","error")}}updateHeaderDisplay(){const e=document.getElementById("user-name");if(!e)return;let t="Â¡Bienvenido!";this.currentProfile&&this.currentProfile.first_name&&this.currentProfile.last_name?t=`ğŸ‘¤ ${this.currentProfile.first_name} ${this.currentProfile.last_name}`:this.currentProfile&&this.currentProfile.display_name?t=`ğŸ‘¤ ${this.currentProfile.display_name}`:t="ğŸ‘¤ Usuario sin nombre",e.textContent=t}getDisplayName(){return this.currentProfile&&this.currentProfile.first_name&&this.currentProfile.last_name?`${this.currentProfile.first_name} ${this.currentProfile.last_name}`:this.currentProfile&&this.currentProfile.display_name?this.currentProfile.display_name:"Usuario sin nombre"}getCurrentUserId(){var t,o;return((o=(t=window.app)==null?void 0:t.auth)==null?void 0:o.getCurrentUserId())||null}hasCompleteProfile(){return this.currentProfile&&this.currentProfile.first_name&&this.currentProfile.last_name}getCurrentProfile(){return this.currentProfile}}class ue{constructor(){this.modal=null,this.currentSection="profile",this.userProfile=null,this.auth=null,this.isInitialized=!1}async init(e,t,o=null){this.isInitialized||(this.userProfile=e,this.auth=t,this.themeManager=o,this.setupEventListeners(),this.updateUserInitials(),setTimeout(()=>{this.updateUserInitials()},2e3),this.isInitialized=!0,window.location.hostname==="localhost"&&(console.log("ğŸ‘¤ User Profile Button initialized"),console.log("ğŸ‘¤ ModalManager available:",!!(window.app&&window.app.modals))))}setupEventListeners(){const e=document.getElementById("user-profile-btn");window.location.hostname==="localhost"&&console.log("ğŸ‘¤ Profile button found:",e),e?(e.addEventListener("click",()=>{window.location.hostname==="localhost"&&console.log("ğŸ‘¤ Profile button clicked"),this.openModal()}),window.location.hostname==="localhost"&&console.log("ğŸ‘¤ Profile button event listener attached")):console.error("âŒ Profile button not found!"),this.setupModalClose(),this.setupNavigation(),this.setupThemeToggle(),this.setupActionButtons(),this.setupLogout()}setupModalClose(){document.addEventListener("click",e=>{e.target.closest(".modal-close")&&e.target.closest("#user-profile-modal")&&this.closeModal(),e.target.id==="user-profile-modal"&&this.closeModal()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isModalOpen()&&this.closeModal()})}setupNavigation(){document.addEventListener("click",e=>{const t=e.target.closest(".profile-nav-item");t&&t.dataset.section&&this.switchSection(t.dataset.section)})}setupThemeToggle(){const e=document.getElementById("profile-theme-toggle");e&&(this.syncThemeToggle(),e.addEventListener("change",t=>{if(this.themeManager)this.themeManager.toggle(),setTimeout(()=>this.syncThemeToggle(),100);else{const o=t.target.checked?"dark":"light";this.changeTheme(o)}}),window.addEventListener("themeChanged",()=>{this.syncThemeToggle()}))}syncThemeToggle(){const e=document.getElementById("profile-theme-toggle");if(e){const t=document.documentElement.getAttribute("data-theme")==="dark"||document.body.classList.contains("darkmode");e.checked=t}}setupActionButtons(){const e=document.getElementById("edit-profile-from-modal");e&&e.addEventListener("click",()=>{this.closeModal(),window.app&&window.app.modals&&window.app.modals.show("edit-profile-modal")});const t=document.getElementById("manage-categories-from-modal");t&&t.addEventListener("click",()=>{this.closeModal(),window.app&&window.app.modals&&window.app.modals.show("manage-categories-modal")}),this.setupDataActions()}setupDataActions(){const e=document.getElementById("export-data-from-modal"),t=document.getElementById("import-data-from-modal"),o=document.getElementById("backup-data-from-modal");e&&e.addEventListener("click",()=>{this.closeModal();const n=document.getElementById("export-data-btn");n&&n.click()}),t&&t.addEventListener("click",()=>{this.closeModal();const n=document.getElementById("import-data-btn");n&&n.click()}),o&&o.addEventListener("click",()=>{this.closeModal();const n=document.getElementById("backup-data-btn");n&&n.click()})}setupLogout(){const e=document.getElementById("profile-logout-btn");e&&e.addEventListener("click",async()=>{try{this.closeModal(),this.auth&&await this.auth.logout()}catch(t){console.error("Logout error:",t)}})}openModal(){const e=window.location.hostname==="localhost";e&&console.log("ğŸ‘¤ Opening profile modal...");const t=(o=3)=>window.app&&window.app.modals?(this.updateModalContent(),this.switchSection("profile"),window.app.modals.show("user-profile-modal"),e&&console.log("ğŸ‘¤ Modal opened via ModalManager"),!0):o>0?(e&&console.log("ğŸ‘¤ ModalManager not ready, retrying...",o),setTimeout(()=>t(o-1),100),!1):this.openModalManually();return t()}openModalManually(){const e=window.location.hostname==="localhost";return this.modal=document.getElementById("user-profile-modal"),e&&console.log("ğŸ‘¤ Modal element found:",this.modal),this.modal?(e&&console.log("ğŸ‘¤ Modal classes before:",this.modal.className),this.updateModalContent(),this.modal.classList.remove("hidden"),this.modal.classList.remove("closing"),this.modal.style.display="flex",this.modal.style.visibility="visible",this.modal.style.opacity="1",this.modal.classList.add("active"),e&&console.log("ğŸ‘¤ Modal classes after:",this.modal.className),this.switchSection("profile"),document.body.style.overflow="hidden",e&&console.log("ğŸ‘¤ Modal opened manually"),!0):(console.error("âŒ Modal element not found!"),!1)}closeModal(){window.app&&window.app.modals?(window.app.modals.hide("user-profile-modal"),console.log("ğŸ‘¤ Modal closed via ModalManager")):this.modal&&(this.modal.classList.remove("active"),this.modal.classList.add("hidden"),document.body.style.overflow="",this.modal=null,console.log("ğŸ‘¤ Modal closed manually"))}isModalOpen(){const e=document.getElementById("user-profile-modal");return e&&e.classList.contains("active")}switchSection(e){document.querySelectorAll(".profile-nav-item[data-section]").forEach(n=>{n.classList.toggle("active",n.dataset.section===e)}),document.querySelectorAll(".profile-section").forEach(n=>{const s=n.id.replace("-content-section","");n.classList.toggle("active",s===e)}),this.currentSection=e}updateUserInitials(){try{if(console.log("ğŸ‘¤ Updating user initials..."),!this.userProfile){console.log("ğŸ‘¤ No userProfile available");return}const e=this.userProfile.getCurrentProfile();console.log("ğŸ‘¤ Current profile:",e);let t="U";if(e&&e.first_name&&e.last_name)t=`${e.first_name.charAt(0)}${e.last_name.charAt(0)}`.toUpperCase(),console.log("ğŸ‘¤ Using first_name + last_name:",t);else if(e&&e.display_name){const s=e.display_name.split(" ");s.length>=2?t=`${s[0].charAt(0)}${s[s.length-1].charAt(0)}`.toUpperCase():t=e.display_name.charAt(0).toUpperCase(),console.log("ğŸ‘¤ Using display_name:",t)}else if(e&&e.email)t=e.email.charAt(0).toUpperCase(),console.log("ğŸ‘¤ Using email fallback:",t);else{const s=this.auth?this.auth.getCurrentUser():null;s&&s.email?(t=s.email.charAt(0).toUpperCase(),console.log("ğŸ‘¤ Using auth email:",t)):console.log("ğŸ‘¤ No profile data available, using default")}const o=document.getElementById("user-initials");console.log("ğŸ‘¤ Button initials element:",o),o&&(o.textContent=t,console.log("ğŸ‘¤ Button initials updated to:",t));const n=document.getElementById("profile-modal-initials");n&&(n.textContent=t),console.log("ğŸ‘¤ User initials updated:",t)}catch(e){console.error("âŒ Error updating user initials:",e)}}updateModalContent(){if(this.userProfile)try{const e=this.userProfile.currentProfile,t=document.getElementById("profile-modal-name"),o=document.getElementById("profile-modal-email"),n=document.getElementById("profile-display-first-name"),s=document.getElementById("profile-display-last-name"),a=document.getElementById("profile-display-email");if(e){const i=e.display_name||`${e.first_name||""} ${e.last_name||""}`.trim()||"Usuario";t&&(t.textContent=i),o&&(o.textContent=e.email||"email@ejemplo.com"),n&&(n.textContent=e.first_name||"-"),s&&(s.textContent=e.last_name||"-"),a&&(a.textContent=e.email||"-")}this.syncThemeToggle()}catch(e){console.error("Error updating modal content:",e)}}changeTheme(e){try{document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e),window.dispatchEvent(new CustomEvent("themeChanged",{detail:{theme:e}})),console.log("ğŸ¨ Theme changed to:",e)}catch(t){console.error("Error changing theme:",t)}}refresh(){this.updateUserInitials(),this.isModalOpen()&&this.updateModalContent()}onProfileUpdate(){this.refresh()}}class me{constructor(){this.animatedElements=new Set,this.observers=[],this.animationQueue=[],this.isAnimating=!1,this.isTransitioning=!1,this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.activeAnimations=new Map}init(){console.log("ğŸ¬ Initializing Animation Manager..."),window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{this.prefersReducedMotion=e.matches,console.log("ğŸ¬ Reduced motion preference changed:",this.prefersReducedMotion)}),this.setupIntersectionObserver(),this.animateInitialElements(),this.setupMutationObserver(),this.setupEventListeners(),this.preloadAnimations()}setupIntersectionObserver(){if(!window.IntersectionObserver)return;const e=new IntersectionObserver(o=>{o.forEach(n=>{n.isIntersecting&&(this.animateElement(n.target),e.unobserve(n.target))})},{threshold:.1,rootMargin:"50px"});this.observers.push(e),document.querySelectorAll(`
      .card:not(.animated),
      .dashboard-card:not(.animated),
      .metric-card:not(.animated),
      .summary-card:not(.animated),
      .table-row:not(.animated),
      .expense-item:not(.animated),
      .transaction-item:not(.animated),
      .chart-container:not(.animated)
    `).forEach(o=>e.observe(o))}setupMutationObserver(){const e=new MutationObserver(t=>{t.forEach(o=>{o.addedNodes.forEach(n=>{n.nodeType===Node.ELEMENT_NODE&&this.animateNewElement(n)})})});e.observe(document.body,{childList:!0,subtree:!0}),this.observers.push(e)}animateInitialElements(){this.animateDashboardCards(),this.animateNavigation(),this.animateSectionHeaders(),this.animateForms(),this.animateNumbers()}animateDashboardCards(){document.querySelectorAll(".card, .dashboard-card, .metric-card, .summary-card, .new-unified-card").forEach((t,o)=>{this.animatedElements.has(t)||(t.style.setProperty("--card-delay",o),t.classList.add("animated"),this.animatedElements.add(t),this.addHoverEffects(t))})}animateNavigation(){document.querySelectorAll(".nav-item, .sidebar-item").forEach((o,n)=>{this.animatedElements.has(o)||(o.style.setProperty("--nav-delay",n),o.classList.add("animated"),this.animatedElements.add(o))}),document.querySelectorAll(".user-profile, .notification-bell, .search-box").forEach((o,n)=>{this.animatedElements.has(o)||(o.style.setProperty("--header-delay",n),o.classList.add("animated"),this.animatedElements.add(o))})}animateSectionHeaders(){document.querySelectorAll(".section-header, .section-title, h1, h2, h3").forEach((t,o)=>{this.animatedElements.has(t)||(t.classList.add("animated"),this.animatedElements.add(t))})}animateForms(){document.querySelectorAll(".form-group, .input-group").forEach((o,n)=>{this.animatedElements.has(o)||(o.style.setProperty("--form-delay",n),o.classList.add("animated"),this.animatedElements.add(o))}),document.querySelectorAll("input, select, textarea").forEach(o=>{this.addInputAnimations(o)})}animateNumbers(){document.querySelectorAll(".metric-number, .balance-amount, .total-amount").forEach((t,o)=>{if(this.animatedElements.has(t))return;t.style.setProperty("--number-delay",o);const n=t.textContent,s=parseFloat(n.replace(/[^\d.-]/g,""));isNaN(s)||this.animateCountUp(t,0,s,1e3),this.animatedElements.add(t)})}animateNewElement(e){[".card",".dashboard-card",".metric-card",".summary-card",".table-row",".expense-item",".transaction-item",".form-group",".input-group",".modal",".alert"].forEach(o=>{e.matches&&e.matches(o)&&this.animateElement(e),e.querySelectorAll(o).forEach(s=>this.animateElement(s))})}animateElement(e){if(this.animatedElements.has(e))return;let t="animate-slide-up";e.classList.contains("card")||e.classList.contains("dashboard-card")?t="animate-slide-up":e.classList.contains("table-row")||e.classList.contains("expense-item")?t="animate-slide-left":e.classList.contains("modal")?t="animate-scale-in":e.classList.contains("alert")&&(t="animate-bounce-in"),e.classList.add(t),e.classList.add("animated"),this.animatedElements.add(e)}addHoverEffects(e){this.prefersReducedMotion||(e.style.backfaceVisibility="hidden",e.style.perspective="1000px")}addInputAnimations(e){e.style.backfaceVisibility="hidden"}animateCountUp(e,t,o,n=1200,s={}){var u;if(!e)return;const a=t==null||isNaN(t)?0:parseFloat(t),i=o==null||isNaN(o)?0:parseFloat(o);if(this.prefersReducedMotion){const g=this.formatCurrency(i,s);e.textContent=g,(u=window.app)!=null&&u.visibilityToggle&&e.id&&window.app.visibilityToggle.updateValue(e.id,g);return}const r=performance.now();e.textContent;const l=i<0,c=Math.abs(i),d=Math.abs(a),m=g=>{var b;const p=g-r,h=Math.min(p/n,1),E=h<.5?2*h*h:-1+(4-2*h)*h,w=d+(c-d)*E,y=l?-w:w;if(e.textContent=this.formatCurrency(y,s),h<1)requestAnimationFrame(m);else{const A=this.formatCurrency(i,s);e.textContent=A,(b=window.app)!=null&&b.visibilityToggle&&e.id&&window.app.visibilityToggle.updateValue(e.id,A)}};requestAnimationFrame(m)}formatCurrency(e,t={}){const{currency:o="$",decimals:n=0,showCurrency:s=!0}=t;(e==null||isNaN(e))&&(e=0);const a=typeof e=="number"?e:parseFloat(e)||0,i=Math.abs(a).toLocaleString("es-AR",{minimumFractionDigits:n,maximumFractionDigits:n}),r=s?o:"";return`${a<0?"-":""}${r}${i}`}setupEventListeners(){document.addEventListener("click",e=>{e.target.matches(".btn, button")&&this.animateButtonClick(e.target)}),document.addEventListener("submit",e=>{const t=e.target.querySelector('[type="submit"], .btn-primary');t&&this.animateButtonLoading(t)}),document.addEventListener("click",e=>{e.target.matches(".nav-item, .sidebar-item")&&this.animateNavClick(e.target)})}animateButtonPress(e){if(!e||this.prefersReducedMotion)return;const t=e.style.transform;e.style.transition="transform 150ms cubic-bezier(0.4, 0, 0.2, 1)",e.style.transform="scale(0.95)",setTimeout(()=>{e.style.transform=t,setTimeout(()=>{e.style.transition=""},150)},150)}animateButtonClick(e){this.animateButtonPress(e),this.prefersReducedMotion||this.createRippleEffect(e)}createRippleEffect(e){const t=document.createElement("span"),o=e.getBoundingClientRect(),n=Math.max(o.width,o.height);t.style.width=t.style.height=n+"px",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%) scale(0)",t.style.borderRadius="50%",t.style.background="rgba(255, 255, 255, 0.3)",t.style.position="absolute",t.style.pointerEvents="none",t.style.animation="ripple 0.6s ease-out",e.style.position="relative",e.style.overflow="hidden",e.appendChild(t),setTimeout(()=>{t.remove()},600)}animateButtonLoading(e){e.classList.add("loading"),e.disabled=!0,setTimeout(()=>{e.classList.remove("loading"),e.disabled=!1},2e3)}animateNavClick(e){document.querySelectorAll(".nav-item, .sidebar-item").forEach(t=>{t.classList.remove("active")}),e.classList.add("active")}preloadAnimations(){if(this.prefersReducedMotion)return;const e=document.createElement("div");e.style.cssText=`
      position: fixed;
      top: -1000px;
      left: -1000px;
      width: 1px;
      height: 1px;
      opacity: 0;
      transform: translateX(0);
      transition: all 0.3s ease-out;
      will-change: transform, opacity;
    `,document.body.appendChild(e),requestAnimationFrame(()=>{e.style.transform="translateX(1px)",setTimeout(()=>{document.body.removeChild(e)},350)})}async animatePageTransition(e,t){if(!this.isTransitioning){this.isTransitioning=!0;try{if(this.prefersReducedMotion){this.instantTransition(e,t);return}e&&(e.classList.remove("active"),await new Promise(o=>setTimeout(o,600))),t&&(t.classList.add("active"),await new Promise(o=>setTimeout(o,650)),setTimeout(()=>{t.id==="dashboard-section"?this.orchestrateDashboardAnimations():this.animateActiveSection()},100))}finally{this.isTransitioning=!1}}}instantTransition(e,t){e&&e.classList.remove("active"),t&&t.classList.add("active")}animateModalIn(e,t){return e?new Promise(o=>{const n=this.prefersReducedMotion?0:300;e.style.cssText=`
        opacity: 0;
        transform: scale(0.95) translateY(20px);
        transition: all ${n}ms cubic-bezier(0.4, 0, 0.2, 1);
      `,t&&(t.style.cssText=`
          opacity: 0;
          backdrop-filter: blur(0px);
          transition: all ${n}ms cubic-bezier(0.4, 0, 0.2, 1);
        `),requestAnimationFrame(()=>{e.style.opacity="1",e.style.transform="scale(1) translateY(0)",t&&(t.style.opacity="1",t.style.backdropFilter="blur(8px)"),setTimeout(o,n)})}):Promise.resolve()}animateModalOut(e,t){return e?new Promise(o=>{const n=this.prefersReducedMotion?0:250;e.style.transition=`all ${n}ms cubic-bezier(0.4, 0, 0.2, 1)`,e.style.opacity="0",e.style.transform="scale(0.95) translateY(-20px)",t&&(t.style.transition=`all ${n}ms cubic-bezier(0.4, 0, 0.2, 1)`,t.style.opacity="0",t.style.backdropFilter="blur(0px)"),setTimeout(o,n)}):Promise.resolve()}enhanceCardHovers(){document.querySelectorAll(".expense-card, .goal-card, .budget-card, .card, .dashboard-card, .new-unified-card").forEach(t=>{this.activeAnimations.has(t)||(t.style.backfaceVisibility="hidden",t.style.perspective="1000px",this.activeAnimations.set(t,{processed:!0}))})}animateFinancialData(e={}){if(this.prefersReducedMotion)return Promise.resolve();const t=[],o=200;if(e.balance!==void 0){const n=document.getElementById("balance-amount-new");n&&t.push(this.animateDataEntry(n,e.balance,{type:"balance",duration:1800,delay:0,showCurrency:!0,decimals:0}))}if(e.income!==void 0){const n=document.getElementById("income-summary");n&&t.push(this.animateDataEntry(n,e.income,{type:"income",duration:1500,delay:o,showCurrency:!0,decimals:0}))}if(e.expenses!==void 0){const n=document.getElementById("monthly-expenses-summary");n&&t.push(this.animateDataEntry(n,e.expenses,{type:"expenses",duration:1500,delay:o*2,showCurrency:!0,decimals:0}))}if(e.installmentsCount!==void 0){const n=document.getElementById("installments-count");n&&t.push(this.animateDataEntry(n,e.installmentsCount,{type:"count",duration:1e3,delay:o*3,showCurrency:!1}))}return Promise.all(t)}animateDataEntry(e,t,o={}){return new Promise(n=>{var r;if(!e||this.prefersReducedMotion){if(e){const l=this.formatCurrency(t,o);e.textContent=l,(r=window.app)!=null&&r.visibilityToggle&&e.id&&window.app.visibilityToggle.updateValue(e.id,l)}n();return}const{type:s="default",duration:a=1e3,delay:i=0}=o;e.style.willChange="transform, opacity",e.style.opacity="0",e.style.transform="translateY(15px)",e.style.transition=`
        opacity 400ms cubic-bezier(0.25, 0.1, 0.25, 1),
        transform 400ms cubic-bezier(0.25, 0.1, 0.25, 1)
      `.replace(/\s+/g," ").trim(),setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)",e.addEventListener("transitionend",()=>{e.style.willChange="auto"},{once:!0}),setTimeout(()=>{this.animateCountUp(e,0,t,a,o),setTimeout(n,a+100)},200)},i)})}animateListItems(e,t=".list-item"){if(!e||this.prefersReducedMotion)return;e.querySelectorAll(t).forEach((n,s)=>{n.style.opacity="0",n.style.transform="translateY(20px)",n.style.transition="all 300ms cubic-bezier(0.4, 0, 0.2, 1)",n.style.transitionDelay=`${s*50}ms`,requestAnimationFrame(()=>{n.style.opacity="1",n.style.transform="translateY(0)"})})}showLoadingAnimation(e,t="Cargando..."){if(!e)return;const o=`
      <div class="loading-animation">
        <div class="loading-spinner"></div>
        <span class="loading-text">${t}</span>
      </div>
    `;if(e.innerHTML=o,!this.prefersReducedMotion){const n=e.querySelector(".loading-spinner");n&&(n.style.animation="spin 1s linear infinite")}}showFeedbackAnimation(e,t="success",o=""){if(!e)return;const n={success:"âœ…",error:"âŒ",warning:"âš ï¸",info:"â„¹ï¸"},s={success:"#22c55e",error:"#ef4444",warning:"#f59e0b",info:"#3b82f6"};e.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      background: ${s[t]}20;
      border: 1px solid ${s[t]}40;
      color: ${s[t]};
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(10px);
      opacity: 0;
    `,e.innerHTML=`
      <span style="font-size: 16px;">${n[t]}</span>
      <span>${o}</span>
    `,requestAnimationFrame(()=>{e.style.transform="translateY(0)",e.style.opacity="1"})}refreshAnimations(){this.prefersReducedMotion||this.isTransitioning||setTimeout(()=>{if(this.isTransitioning)return;this.enhanceCardHovers();const e=document.querySelector(".dashboard-section.active");if(!e)return;e.querySelectorAll(".expenses-list, .goals-list, .budgets-list").forEach(o=>{o.querySelectorAll('[data-new="true"]').forEach(s=>{s.closest(".dashboard-section.active")&&(s.style.opacity="0",s.style.transform="translateY(20px)",s.style.transition="all 300ms cubic-bezier(0.4, 0, 0.2, 1)",requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform="translateY(0)",s.removeAttribute("data-new")}))})}),this.animateActiveSection()},350)}orchestrateDashboardAnimations(){this.prefersReducedMotion||this.animateDashboardCards()}animateActiveSection(){const e=document.querySelector(".dashboard-section.active");if(!e)return;e.querySelectorAll(".card, .dashboard-card, .metric-card, .summary-card").forEach(o=>{this.animatedElements.delete(o),o.classList.remove("animated")}),this.animateDashboardCards()}animateChartsInSection(e){if(!e||this.prefersReducedMotion)return;e.querySelectorAll(".chart-container, .chart-card").forEach((o,n)=>{if(this.animatedElements.has(o))return;o.style.willChange="transform, opacity",o.style.opacity="0",o.style.transform="scale(0.95) translateY(30px)";const s=n*150+300;setTimeout(()=>{o.style.transition=`
          opacity 600ms cubic-bezier(0.25, 0.1, 0.25, 1),
          transform 600ms cubic-bezier(0.25, 0.1, 0.25, 1)
        `.replace(/\s+/g," ").trim(),o.style.opacity="1",o.style.transform="scale(1) translateY(0)",o.addEventListener("transitionend",()=>{o.style.willChange="auto"},{once:!0})},s),this.animatedElements.add(o)})}animateTransactionsInSection(e){if(!e||this.prefersReducedMotion)return;e.querySelectorAll(".recent-transactions-list, .expenses-list, .income-list").forEach(o=>{o.querySelectorAll(".transaction-item, .expense-item, .income-item, .recent-transaction-item").forEach((s,a)=>{if(this.animatedElements.has(s))return;s.style.willChange="transform, opacity",s.style.opacity="0",s.style.transform="translateX(-20px)";const i=a*60+500;setTimeout(()=>{s.style.transition=`
            opacity 400ms cubic-bezier(0.25, 0.1, 0.25, 1),
            transform 400ms cubic-bezier(0.25, 0.1, 0.25, 1)
          `.replace(/\s+/g," ").trim(),s.style.opacity="1",s.style.transform="translateX(0)",s.addEventListener("transitionend",()=>{s.style.willChange="auto"},{once:!0})},i),this.animatedElements.add(s)})})}cleanup(){this.activeAnimations.forEach((e,t)=>{e.handleMouseEnter&&t.removeEventListener("mouseenter",e.handleMouseEnter),e.handleMouseLeave&&t.removeEventListener("mouseleave",e.handleMouseLeave)}),this.activeAnimations.clear(),this.animationQueue.length=0}destroy(){this.cleanup(),this.observers.forEach(e=>e.disconnect()),this.observers=[],this.animatedElements.clear()}get animationsEnabled(){return!this.prefersReducedMotion}addCustomAnimation(e,t="fadeIn",o=0){e.style.animationDelay=`${o}s`,e.classList.add(`animate-${t}`),this.animatedElements.add(e)}}class ge{constructor(e){this.svgElement=e,this.states=["open","half-open","almost-closed","closed"],this.currentStateIndex=0,this.isAnimating=!1,this.updateState()}animateClosing(){if(this.isAnimating)return;this.isAnimating=!0,this.currentStateIndex=0,this.updateState();const e=[300,300,300];e.forEach((t,o)=>{setTimeout(()=>{this.currentStateIndex=o+1,this.updateState(),o===e.length-1&&(this.isAnimating=!1)},t*(o+1))})}animateOpening(){if(this.isAnimating)return;this.isAnimating=!0,this.currentStateIndex=3,this.updateState();const e=[300,300,300];e.forEach((t,o)=>{setTimeout(()=>{this.currentStateIndex=3-(o+1),this.updateState(),o===e.length-1&&(this.isAnimating=!1)},t*(o+1))})}getCurrentState(){return this.states[this.currentStateIndex]}updateState(){const e=this.getCurrentState();this.svgElement.setAttribute("data-state",e)}setState(e){if(this.isAnimating)return;const t=this.states.indexOf(e);t!==-1&&(this.currentStateIndex=t,this.updateState())}reset(){this.isAnimating||(this.currentStateIndex=0,this.updateState())}getIsAnimating(){return this.isAnimating}}class pe{constructor(){this.isVisible=!0,this.elements=[{id:"balance-amount-new",originalValue:""},{id:"income-summary",originalValue:""},{id:"monthly-expenses-summary",originalValue:""}],this.hiddenPlaceholder="â€¢â€¢â€¢â€¢â€¢â€¢",this.storageKey="finzn-values-visibility",this.animatedEye=null}init(){console.log("ğŸ‘ï¸ Initializing Visibility Toggle...");const e=document.getElementById("animated-eye-icon");e&&(this.animatedEye=new ge(e)),this.loadState(),this.setupEventListeners(),this.applyVisibilityState()}setupEventListeners(){const e=document.getElementById("toggle-visibility-btn");e&&e.addEventListener("click",()=>{this.animatedEye&&(this.isVisible?this.animatedEye.animateClosing():this.animatedEye.animateOpening()),this.toggleVisibility()})}loadState(){try{const e=localStorage.getItem(this.storageKey);e!==null&&(this.isVisible=JSON.parse(e))}catch(e){console.log("ğŸ‘ï¸ Could not load visibility state:",e),this.isVisible=!0}}saveState(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.isVisible))}catch(e){console.log("ğŸ‘ï¸ Could not save visibility state:",e)}}toggleVisibility(){this.isVisible=!this.isVisible,this.saveState(),this.applyVisibilityState(),console.log(`ğŸ‘ï¸ Visibility toggled: ${this.isVisible?"visible":"hidden"}`)}applyVisibilityState(){this.updateToggleIcon(),this.setEyeStateInstant(),this.elements.forEach(e=>{const t=document.getElementById(e.id);t&&(this.isVisible?(e.originalValue&&(t.textContent=e.originalValue),t.setAttribute("data-visible","true")):(e.originalValue||(e.originalValue=t.textContent),t.textContent=this.hiddenPlaceholder,t.setAttribute("data-visible","false")))})}setEyeStateInstant(){this.animatedEye&&(this.isVisible?this.animatedEye.setState("open"):this.animatedEye.setState("closed"))}updateToggleIcon(){const e=document.getElementById("toggle-visibility-btn");e&&(this.isVisible?e.title="Ocultar valores":e.title="Mostrar valores")}updateValue(e,t){const o=this.elements.find(n=>n.id===e);if(o&&(o.originalValue=t,this.isVisible)){const n=document.getElementById(e);n&&(n.textContent=t)}}refreshValues(){this.isVisible&&this.elements.forEach(e=>{const t=document.getElementById(e.id);t&&t.getAttribute("data-visible")!=="false"&&(e.originalValue=t.textContent)})}areValuesVisible(){return this.isVisible}}class he{constructor(){this.loadingElement=null,this.isShowing=!1}show(){if(this.isShowing)return;this.loadingElement=document.createElement("div"),this.loadingElement.className="loading-screen",this.loadingElement.id="loading-screen";const e=document.createElement("img");e.className="loading-logo",e.src="/isotipo.png",e.alt="FINZN Loading",e.loading="eager",e.onerror=()=>{console.warn("Loading logo not found, using fallback"),e.style.display="none";const t=document.createElement("div");t.innerHTML='<div style="font-size: 2rem; color: var(--primary-color); font-weight: bold;">FINZN</div>',t.className="loading-logo",this.loadingElement.appendChild(t)},this.loadingElement.appendChild(e),document.body.appendChild(this.loadingElement),this.isShowing=!0}hide(){!this.isShowing||!this.loadingElement||(this.loadingElement.classList.add("fade-out"),setTimeout(()=>{this.loadingElement&&this.loadingElement.parentNode&&this.loadingElement.parentNode.removeChild(this.loadingElement),this.loadingElement=null,this.isShowing=!1},500))}isVisible(){return this.isShowing}forceHide(){this.loadingElement&&(this.loadingElement.parentNode&&this.loadingElement.parentNode.removeChild(this.loadingElement),this.loadingElement=null,this.isShowing=!1)}}const z=new he;class Y{constructor(){this.testResults=[],this.isDev=window.location.hostname==="localhost"}async runAllTests(){return console.log("ğŸ§ª Starting Mobile Testing Suite..."),await this.testUserProfileButton(),await this.testModals(),await this.testNavigation(),await this.testForms(),await this.testResponsive(),await this.testPerformance(),this.generateReport(),this.testResults}async testUserProfileButton(){var t,o,n;const e={name:"User Profile Button",status:"pending",issues:[]};try{const s=document.getElementById("user-profile-btn");if(!s){e.issues.push("âŒ Profile button not found in DOM"),e.status="failed",this.testResults.push(e);return}const a=window.getComputedStyle(s);(a.display==="none"||a.visibility==="hidden")&&e.issues.push("âŒ Profile button is not visible");const i=s.closest(".user-profile-button-container");i?window.getComputedStyle(i).display==="none"&&e.issues.push("âŒ Profile button container is hidden"):e.issues.push("âŒ Profile button container not found");const r=s.getBoundingClientRect();(r.width<44||r.height<44)&&e.issues.push(`âš ï¸ Touch target too small: ${r.width}x${r.height}px (min 44x44)`);const l=document.getElementById("user-initials");(!l||!l.textContent.trim())&&e.issues.push("âŒ User initials not displaying");let c=!1;const d=(o=(t=window.app)==null?void 0:t.userProfileButton)==null?void 0:o.openModal;(n=window.app)!=null&&n.userProfileButton?(window.app.userProfileButton.openModal=()=>{c=!0,d&&d.call(window.app.userProfileButton)},s.click(),setTimeout(()=>{c||e.issues.push("âŒ Button click did not trigger modal opening"),d&&(window.app.userProfileButton.openModal=d)},100)):e.issues.push("âŒ UserProfileButton module not initialized"),e.status=e.issues.length===0?"passed":"warning"}catch(s){e.status="failed",e.issues.push(`âŒ Error: ${s.message}`)}this.testResults.push(e)}async testModals(){var t;const e={name:"Modal System",status:"pending",issues:[]};try{const o=document.getElementById("user-profile-modal");if(!o){e.issues.push("âŒ Profile modal not found in DOM"),e.status="failed",this.testResults.push(e);return}o.querySelector(".user-profile-modal-content")||e.issues.push("âŒ Modal content structure missing"),o.querySelector(".user-profile-modal-header")||e.issues.push("âŒ Modal header missing"),o.querySelector(".profile-navigation")||e.issues.push("âŒ Modal navigation missing");const i=o.querySelectorAll(".profile-nav-item");["profile","settings","theme"].forEach(m=>{Array.from(i).some(g=>g.dataset.section===m)||e.issues.push(`âŒ Navigation item '${m}' missing`)}),(t=window.app)!=null&&t.modals||e.issues.push("âŒ Modal manager not available");const l=document.getElementById("profile-content-section"),c=document.getElementById("settings-content-section"),d=document.getElementById("theme-content-section");l||e.issues.push("âŒ Profile section missing"),c||e.issues.push("âŒ Settings section missing"),d||e.issues.push("âŒ Theme section missing"),e.status=e.issues.length===0?"passed":"warning"}catch(o){e.status="failed",e.issues.push(`âŒ Error: ${o.message}`)}this.testResults.push(e)}async testNavigation(){var t;const e={name:"Navigation System",status:"pending",issues:[]};try{document.querySelector(".sidebar-nav")||e.issues.push("âŒ Sidebar navigation not found"),document.querySelector(".mobile-nav")||e.issues.push("âŒ Mobile navigation not found");const s=document.querySelectorAll(".nav-item[data-section]"),a=document.querySelectorAll(".mobile-nav-item[data-section]");s.length===0&&e.issues.push("âŒ No navigation items found"),a.length===0&&e.issues.push("âŒ No mobile navigation items found"),(t=window.app)!=null&&t.navigation||e.issues.push("âŒ Navigation manager not available"),a.forEach((i,r)=>{const l=i.getBoundingClientRect();l.height>0&&l.height<44&&e.issues.push(`âš ï¸ Mobile nav item ${r} touch target too small: ${l.height}px`)}),e.status=e.issues.length===0?"passed":"warning"}catch(o){e.status="failed",e.issues.push(`âŒ Error: ${o.message}`)}this.testResults.push(e)}async testForms(){const e={name:"Forms and Inputs",status:"pending",issues:[]};try{document.querySelectorAll("input, select, textarea").forEach((n,s)=>{const a=window.getComputedStyle(n),i=parseFloat(a.fontSize);i<16&&e.issues.push(`âš ï¸ Input ${s} font-size too small (${i}px), may cause zoom on iOS`);const r=n.getBoundingClientRect();r.height>0&&r.height<44&&e.issues.push(`âš ï¸ Input ${s} touch target too small: ${r.height}px`)}),document.querySelectorAll(".modal-form").length===0&&e.issues.push("âš ï¸ No modal forms found for testing"),e.status=e.issues.length===0?"passed":"warning"}catch(t){e.status="failed",e.issues.push(`âŒ Error: ${t.message}`)}this.testResults.push(e)}async testResponsive(){const e={name:"Responsive Design",status:"pending",issues:[]};try{const t=[320,375,414,768,1024,1200],o=window.innerWidth;t.forEach(i=>{const r=document.documentElement,l=getComputedStyle(r).getPropertyValue("--mobile-spacing-md");i<=768&&!l&&e.issues.push(`âš ï¸ Mobile CSS variables not loaded for ${i}px`)}),Array.from(document.styleSheets).find(i=>i.href&&i.href.includes("mobile-optimized.css"))||e.issues.push("âŒ mobile-optimized.css not loaded");const a=document.querySelector(".user-profile-btn");if(a&&window.matchMedia("(max-width: 768px)").matches){const r=window.getComputedStyle(a),l=parseFloat(r.width),c=parseFloat(r.height);(l<44||c<44)&&e.issues.push(`âš ï¸ Profile button not mobile optimized: ${l}x${c}px`)}e.status=e.issues.length===0?"passed":"warning"}catch(t){e.status="failed",e.issues.push(`âŒ Error: ${t.message}`)}this.testResults.push(e)}async testPerformance(){const e={name:"Performance",status:"pending",issues:[]};try{if(!window.performance){e.issues.push("âš ï¸ Performance API not available"),e.status="warning",this.testResults.push(e);return}const o=performance.getEntriesByType("paint").find(a=>a.name==="first-contentful-paint");o&&o.startTime>3e3&&e.issues.push(`âš ï¸ First Contentful Paint slow: ${o.startTime.toFixed(0)}ms`),document.querySelectorAll("img").forEach((a,i)=>{(a.naturalWidth>1920||a.naturalHeight>1080)&&e.issues.push(`âš ï¸ Image ${i} potentially too large: ${a.naturalWidth}x${a.naturalHeight}`)});const s=Array.from(document.styleSheets).length;s>10&&e.issues.push(`âš ï¸ Many CSS files loaded: ${s} (consider bundling)`),e.status=e.issues.length===0?"passed":"warning"}catch(t){e.status="failed",e.issues.push(`âŒ Error: ${t.message}`)}this.testResults.push(e)}generateReport(){console.log(`
ğŸ§ª MOBILE TESTING REPORT`),console.log(`========================
`);const e=this.testResults.filter(s=>s.status==="passed").length,t=this.testResults.filter(s=>s.status==="warning").length,o=this.testResults.filter(s=>s.status==="failed").length;console.log(`âœ… Passed: ${e}`),console.log(`âš ï¸  Warnings: ${t}`),console.log(`âŒ Failed: ${o}
`),this.testResults.forEach(s=>{const a=s.status==="passed"?"âœ…":s.status==="warning"?"âš ï¸":"âŒ";console.log(`${a} ${s.name}`),s.issues.length>0&&s.issues.forEach(i=>{console.log(`   ${i}`)}),console.log("")});const n=((e+t*.5)/this.testResults.length*100).toFixed(0);console.log(`ğŸ“Š Overall Mobile Optimization Score: ${n}%`),n>=90?console.log("ğŸ‰ Excellent mobile optimization!"):n>=75?console.log("ğŸ‘ Good mobile optimization with some improvements needed."):n>=60?console.log("âš ï¸ Mobile optimization needs attention."):console.log("ğŸš¨ Critical mobile optimization issues found.")}}window.location.hostname==="localhost"&&window.location.search.includes("test=mobile")&&window.addEventListener("load",async()=>{setTimeout(async()=>{await new Y().runAllTests()},2e3)});console.log("FINZN App - Starting initialization");class fe{constructor(){console.log("Constructing FINZN App"),this.auth=new Q,this.data=new X,this.ui=new ee,this.charts=new te,this.modals=new oe,this.reports=new ne,this.theme=new se,this.navigation=new ae,this.calendar=new le,this.budget=new ce,this.userProfile=new de,this.userProfileButton=new ue,this.animations=new me,this.visibilityToggle=new pe,this.currentMonth=this.getCurrentMonth(),this.currentExpenseId=null,console.log("ğŸ”§ All modules initialized"),this.init()}async init(){console.log("ğŸš€ Initializing FINZN App..."),z.show();try{this.theme.init(),this.navigation.init(),this.modals.init(),this.setupModalEvents(),this.animations.init(),this.userProfile.init(),this.visibilityToggle.init(),this.setupMonthSelector(),await this.auth.initializeAuth();const e=this.auth.getCurrentUser();console.log("Current user:",e),e?(this.showApp(),await this.loadUserData(),await this.userProfileButton.init(this.userProfile,this.auth,this.theme),await this.checkProfileCompletion(),this.calendar.init(),this.updateDashboard(),this.hideLoadingScreen()):(this.showAuth(),this.calendar.init(),this.hideLoadingScreen()),this.setupEventListeners(),console.log("âœ… FINZN App initialized successfully"),window.location.hostname==="localhost"&&window.location.search.includes("test=mobile")&&setTimeout(async()=>{await new Y().runAllTests()},3e3)}catch(e){console.error("âŒ Error initializing app:",e),this.showAuth(),this.setupEventListeners(),this.hideLoadingScreen()}}async checkProfileCompletion(){setTimeout(async()=>{console.log("ğŸ‘¤ Checking profile completion..."),await this.userProfile.loadUserProfile();const e=this.userProfile.hasCompleteProfile();console.log("ğŸ‘¤ Has complete profile:",e),this.userProfile.hasCompleteProfile()?(console.log("ğŸ‘¤ Profile is complete, updating header"),this.userProfile.updateHeaderDisplay()):(console.log("ğŸ‘¤ User needs to complete profile"),this.userProfile.showCompleteProfileModal())},1e3)}setupEventListeners(){console.log("ğŸ”— Setting up event listeners...");try{this.setupAuthEvents(),this.setupDashboardEvents();const e=document.getElementById("go-reports");e&&e.addEventListener("click",()=>{window.app&&window.app.navigation&&window.app.navigation.showSection("reports")});const t=document.getElementById("theme-toggle");t&&t.addEventListener("click",()=>{this.theme.toggle()});const o=document.getElementById("month-select");o&&o.addEventListener("change",a=>{this.currentMonth=a.target.value,this.updateDashboard()});const n=document.getElementById("goals-list");n&&n.addEventListener("click",a=>{const i=a.target.closest("button[data-action]");if(!i)return;a.preventDefault();const r=i.getAttribute("data-action"),l=i.getAttribute("data-goal-id"),c=i.getAttribute("data-goal-name");switch(r){case"create-goal":this.showAddGoalModal();break;case"add-money":l&&this.addToGoal(l);break;case"edit-goal":l&&this.editGoal(l);break;case"delete-goal":l&&c&&this.deleteGoal(l,c);break;default:console.warn("Unknown goal action:",r)}});const s=document.getElementById("budgets-list");s&&s.addEventListener("click",a=>{const i=a.target.closest("button[data-action]");if(!i)return;a.preventDefault();const r=i.getAttribute("data-action"),l=i.getAttribute("data-budget-id"),c=i.getAttribute("data-budget-name");switch(r){case"create-budget":this.showAddBudgetModal();break;case"edit-budget":l&&this.showEditBudgetModal(l);break;case"delete-budget":l&&c&&this.deleteBudget(l,c);break;default:console.warn("Unknown budget action:",r)}}),console.log("âœ… All event listeners set up successfully")}catch(e){console.error("âŒ Error setting up event listeners:",e)}}setupAuthEvents(){const e=document.getElementById("login-form"),t=document.getElementById("register-form"),o=document.getElementById("show-register"),n=document.getElementById("show-login"),s=document.getElementById("logout-btn"),a=document.getElementById("generate-test-email");e&&e.addEventListener("submit",i=>this.handleLogin(i)),t&&t.addEventListener("submit",i=>this.handleRegister(i)),o&&o.addEventListener("click",()=>this.showRegister()),n&&n.addEventListener("click",()=>this.showLogin()),s&&s.addEventListener("click",()=>this.handleLogout()),a&&a.addEventListener("click",()=>{const i=this.auth.generateTestEmail(),r=document.getElementById("register-user");r&&(r.value=i,this.ui.showAlert("Email de prueba generado","info"))})}setupDashboardEvents(){if(this._dashboardEventsBound)return;this._dashboardEventsBound=!0;const e=document.getElementById("add-expense-btn-dashboard");e?(console.log("âœ… Add expense button found and event listener added"),e.addEventListener("click",()=>{console.log("ğŸ”§ Add expense button clicked!"),this.showAddExpenseModal()})):console.warn("âš ï¸ Add expense button not found!");const t=document.getElementById("add-expense-btn-transactions");t&&t.addEventListener("click",()=>this.showAddExpenseModal());const o=document.getElementById("add-income-btn-dashboard");o?(console.log("âœ… Add income button found and event listener added"),o.addEventListener("click",()=>{console.log("ğŸ”§ Add income button clicked!"),this.showAddIncomeModal()})):console.warn("âš ï¸ Add income button not found!");const n=document.getElementById("add-income-btn-transactions");n&&n.addEventListener("click",()=>this.showAddIncomeModal());const s=document.getElementById("incomes-indicator");s&&s.addEventListener("click",()=>this.showViewIncomesModal());const a=document.getElementById("installments-btn");a&&a.addEventListener("click",()=>this.showInstallmentsModal());const i=document.getElementById("add-goal-btn");i&&i.addEventListener("click",()=>this.showAddGoalModal());const r=document.getElementById("add-spending-limit-btn-transactions");r&&r.addEventListener("click",()=>this.showAddSpendingLimitModal());const l=document.getElementById("manage-categories-btn");l&&l.addEventListener("click",()=>this.showManageCategoriesModal());const c=document.getElementById("export-data-btn");c&&c.addEventListener("click",()=>this.handleExportData());const d=document.getElementById("import-data-btn");d&&d.addEventListener("click",()=>this.showImportDataModal());const m=document.getElementById("backup-data-btn");m&&m.addEventListener("click",()=>this.handleBackupData());const u=document.getElementById("add-budget-btn");u&&u.addEventListener("click",()=>this.showAddBudgetModal());const g=document.getElementById("add-expense-form");g&&g.addEventListener("submit",I=>this.handleAddExpense(I));const p=document.getElementById("add-income-form");p&&p.addEventListener("submit",I=>this.handleAddIncome(I));const h=document.getElementById("add-goal-form");h&&h.addEventListener("submit",I=>this.handleAddGoal(I));const E=document.getElementById("edit-goal-form");E&&E.addEventListener("submit",I=>this.handleEditGoal(I));const w=document.getElementById("add-money-form");w&&w.addEventListener("submit",I=>this.handleAddMoney(I));const y=document.getElementById("add-spending-limit-form");y&&y.addEventListener("submit",I=>this.handleAddSpendingLimit(I));const b=document.getElementById("add-category-form");b&&b.addEventListener("submit",I=>this.handleAddCategory(I));const A=document.getElementById("process-import-btn");A&&A.addEventListener("click",()=>this.handleImportData());const D=document.getElementById("expenses-list");D&&D.addEventListener("click",I=>{const C=I.target.closest("button");if(C){if(C.classList.contains("js-expense-edit")){const x=C.dataset.id;x&&this.showEditExpenseModal(x)}if(C.classList.contains("js-expense-delete")){const x=C.dataset.id,W=C.dataset.description||"este gasto";x&&this.showDeleteConfirmation(x,W)}}});const _=document.getElementById("qa-add-expense");_&&_.addEventListener("click",()=>this.showAddExpenseModal());const k=document.getElementById("qa-add-income");k&&k.addEventListener("click",()=>this.showAddIncomeModal());const F=document.getElementById("qa-import");F&&F.addEventListener("click",()=>this.showImportDataModal());const G=document.getElementById("qa-add-budget");G&&G.addEventListener("click",()=>this.showAddBudgetModal());const P=document.getElementById("go-transactions");P&&P.addEventListener("click",()=>{this.navigation.showSection("transactions")});const N=document.getElementById("add-budget-form");N&&N.addEventListener("submit",I=>this.handleAddBudget(I));const U=document.getElementById("edit-budget-form");U&&U.addEventListener("submit",I=>this.handleEditBudget(I));const R=document.getElementById("edit-limit-form");R&&R.addEventListener("submit",I=>this.handleEditLimitSubmit(I));const O=document.getElementById("category-limits-display");O&&O.addEventListener("click",I=>{const C=I.target.closest("button");if(C){if(C.classList.contains("js-limit-edit")){const x=C.dataset.id;x&&this.showEditLimitModal(x)}if(C.classList.contains("js-limit-delete")){const x=C.dataset.id;x&&this.deleteSpendingLimit(x)}}});const q=document.getElementById("spending-limits-summary");q&&q.addEventListener("click",I=>{const C=I.target.closest("button");if(C){if(C.classList.contains("js-limit-edit")){const x=C.dataset.id;x&&this.showEditLimitModal(x)}if(C.classList.contains("js-limit-delete")){const x=C.dataset.id;x&&this.deleteSpendingLimit(x)}}})}setupModalEvents(){const e=document.getElementById("expense-installments"),t=document.getElementById("installments-group");e&&t&&e.addEventListener("change",s=>{s.target.checked?t.classList.remove("hidden"):t.classList.add("hidden")});const o=document.getElementById("income-type"),n=document.getElementById("extra-income-group");o&&n&&o.addEventListener("change",s=>{s.target.value==="extra"?n.classList.remove("hidden"):n.classList.add("hidden")}),document.addEventListener("click",s=>{if(s.target.closest(".delete-category-btn")){const i=s.target.closest(".delete-category-btn").getAttribute("data-category-id");i&&this.deleteCategory(i)}})}setupMonthSelector(){const e=document.getElementById("month-select");if(!e)return;const t=[],o=new Date;for(let n=0;n<12;n++){const s=new Date(o.getFullYear(),o.getMonth()-n,1),a=`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,"0")}`,i=s.toLocaleDateString("es-ES",{month:"long",year:"numeric"});t.push({key:a,name:i})}e.innerHTML="",t.forEach(n=>{const s=document.createElement("option");s.value=n.key,s.textContent=n.name,n.key===this.currentMonth&&(s.selected=!0),e.appendChild(s)})}showAddIncomeModal(){if(console.log("ğŸ’° Show add income modal - START"),!this.modals){console.error("âŒ ModalManager not available!");return}if(!document.getElementById("add-income-modal")){console.error("âŒ add-income-modal element not found in DOM!");return}console.log("âœ… Income modal element found, calling modals.show()");const t=new Date().toISOString().split("T")[0],o=document.getElementById("income-date");o?(o.value=t,console.log("âœ… Income date set to:",t)):console.warn("âš ï¸ Income date input not found"),this.modals.show("add-income-modal")}async handleLogin(e){e.preventDefault(),console.log("ğŸ” Handling login...");const t=S.safeGetValue("login-user"),o=S.safeGetValue("login-pass");if(!t||!o){this.ui.showAlert("Por favor completa todos los campos","error");return}try{await this.auth.login(t,o)?(this.showApp(),await this.loadUserData(),this.calendar&&await this.calendar.loadEvents(),this.updateDashboard(),this.ui.showAlert("Â¡Bienvenido de vuelta!","success")):this.ui.showAlert("Credenciales incorrectas","error")}catch(n){console.error("Login error:",n),this.ui.showAlert("Error al iniciar sesiÃ³n","error")}}async handleRegister(e){e.preventDefault(),console.log("ğŸ“ Handling registration...");const t=document.getElementById("register-error");t&&(t.textContent="");const o=S.safeGetValue("register-user"),n=S.safeGetValue("register-pass");if(!o||!n){this.ui.showAlert("Por favor completa todos los campos","error");return}if(n.length<6){this.ui.showAlert("La contraseÃ±a debe tener al menos 6 caracteres","error");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)){this.ui.showAlert("Por favor ingresa un email vÃ¡lido","error");return}try{const a=await this.auth.register(o,n);a&&a.success?(this.showLogin(),this.ui.showAlert("Â¡Cuenta creada exitosamente! Ahora puedes iniciar sesiÃ³n.","success")):this.ui.showAlert("Error al crear la cuenta. Intenta con otro email.","error")}catch(a){console.error("Register error:",a),t&&(t.textContent=a.message||"Error al registrar usuario"),this.ui.showAlert(a.message||"Error al registrar usuario","error")}}handleLogout(){confirm("Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?")&&(this.ui.showAlert("Cerrando sesiÃ³n...","info"),setTimeout(()=>{this.auth.logout()},1e3))}showAuth(){console.log("ğŸ‘¤ Showing auth screen"),document.getElementById("login-container").classList.remove("hidden"),document.getElementById("register-container").classList.add("hidden"),document.getElementById("app").classList.add("hidden")}showApp(){console.log("ğŸ  Showing main app"),document.getElementById("login-container").classList.add("hidden"),document.getElementById("register-container").classList.add("hidden"),document.getElementById("app").classList.remove("hidden");const e=document.querySelector(".user-profile-button-container");e&&(e.style.display="block")}showLogin(){console.log("ğŸ” Showing login form"),document.getElementById("register-container").classList.add("hidden"),document.getElementById("login-container").classList.remove("hidden"),document.getElementById("app").classList.add("hidden");const e=document.querySelector(".user-profile-button-container");e&&(e.style.display="none")}showRegister(){console.log("ğŸ“ Showing register form"),document.getElementById("login-container").classList.add("hidden"),document.getElementById("register-container").classList.remove("hidden")}async loadUserData(){console.log("ğŸ“Š Loading user data...");try{if(!this.auth.getCurrentUser()){console.log("âš ï¸ No authenticated user, skipping data load");return}await this.data.loadUserData();const t=this.data.getCategories();this.ui.updateCategoriesSelect(t,"expense-category"),this.ui.updateCategoriesSelect(t,"limit-category"),this.userProfileButton&&this.userProfileButton.refresh(),console.log("âœ… User data loaded successfully")}catch(e){console.error("âŒ Error loading user data:",e),this.ui.showAlert("Error al cargar los datos. Verifica tu conexiÃ³n.","error")}}async updateDashboard(){console.log("ğŸ”„ Updating dashboard for month:",this.currentMonth);try{console.log("ğŸ“Š Loading expenses...");const e=await this.data.loadExpenses(this.currentMonth);console.log("ğŸ’° Loading income...");const t=await this.data.loadIncome(this.currentMonth);console.log("ğŸ’µ Loading extra incomes...");const o=await this.data.loadExtraIncomes(this.currentMonth);console.log("ğŸ“Š Data loaded:",{expenses:e.length,income:t,extraIncomes:o.length});const n=this.data.calculateBalance(this.currentMonth);console.log("ğŸ’° Balance calculated:",n);const s=t&&typeof t.fixed=="number"?t.fixed:0,a=(o==null?void 0:o.reduce((p,h)=>p+(h.amount||0),0))||0,i=s+a,r=e.reduce((p,h)=>p+(h.amount||0),0),l=e.filter(p=>p.total_installments>1).length,c={balance:(n==null?void 0:n.available)||0,income:i,expenses:r,installmentsCount:l};console.log("ğŸ¬ Animation data prepared:",c),this.animations.animateFinancialData(c),this.ui.updateBalance(n),this.ui.updateExpensesList(e,this),this.ui.updateRecentTransactions(e,t,o),this.ui.updateIncomeDetails(t,o),this.ui.updateIncomeList(o,t),this.ui.updateInstallmentsList(e),this.ui.updateNavigationBadges(e,o,t);const d=this.data.getGoals();this.ui.updateGoalsList(d);const m=this.data.getSpendingLimits();this.ui.updateSpendingLimitsList(m,e),this.data.checkSpendingLimits(this.currentMonth).forEach(p=>{this.ui.showAlert(p.message,p.type)}),setTimeout(()=>{try{const p=this.data.getExpensesByCategory(this.currentMonth),h=this.data.getCategories();console.log("ğŸ“Š Updating charts with expenses data:",p),document.querySelectorAll(".chart-container").forEach((w,y)=>{w&&(w.style.opacity="0",w.style.transform="scale(0.95)",setTimeout(()=>{w.style.transition="all 500ms cubic-bezier(0.4, 0, 0.2, 1)",w.style.opacity="1",w.style.transform="scale(1)"},y*200+300))}),setTimeout(()=>{this.charts.updateExpensesChart(p,h),this.charts.updateDashboardExpensesChart(p,h),this.data.getTrendData().then(w=>{this.charts.updateTrendChart(w)})},400)}catch(p){console.error("âŒ Charts error:",p)}},800);const g=await this.budget.loadBudgets();this.ui.updateBudgetsList(g,e),e.length>10&&setTimeout(()=>{this.aiBudget.trainModel().catch(p=>{console.log("AI model training skipped:",p.message)})},1e3);try{const p=[...e].sort((y,b)=>new Date(b.transaction_date||b.created_at)-new Date(y.transaction_date||y.created_at)).slice(0,5),h=document.getElementById("recent-transactions");h&&(h.innerHTML=p.map(y=>{const b=(y.transaction_date||y.created_at||"").slice(0,10),A=this.ui.formatCurrency(y.amount),D=y.description||"Gasto";return`
        <li class="tx-item">
          <div class="tx-meta"><span>${b}</span>Â·<span>${D}</span></div>
          <div class="tx-amount">-${A}</div>
        </li>`}).join("")||'<li class="tx-item"><div>Sin movimientos recientes</div></li>');const E=[];e.forEach(y=>{const b=y.total_installments||y.totalInstallments||1,A=y.installment||1;if(b>1&&A<b){const D=new Date(y.transaction_date||y.created_at||new Date);D.setMonth(D.getMonth()+1);const _=D.toISOString().slice(0,10);E.push({description:y.description||"Compra en cuotas",nextDate:_,nextN:A+1,total:b,amount:y.amount})}});const w=document.getElementById("upcoming-list");w&&(w.innerHTML=E.slice(0,5).map(y=>`
      <li class="upcoming-item">
        <div><strong>${y.description}</strong><br>
          <small>Cuota ${y.nextN}/${y.total} Â· ${y.nextDate}</small>
        </div>
        <div class="tx-amount">${this.ui.formatCurrency(y.amount)}</div>
      </li>
    `).join("")||'<li class="upcoming-item"><div>No hay pagos prÃ³ximos</div></li>')}catch(p){console.log("Widgets skipped:",p)}this.animations&&setTimeout(()=>{this.animations.refreshAnimations()},100),console.log("âœ… Dashboard updated successfully")}catch(e){console.error("âŒ Error updating dashboard:",e),this.ui.showAlert("Error al cargar los datos. Intenta refrescar la pÃ¡gina.","error")}}showAddExpenseModal(){if(console.log("ğŸ’³ Show add expense modal - START"),!this.modals){console.error("âŒ ModalManager not available!");return}if(!document.getElementById("add-expense-modal")){console.error("âŒ add-expense-modal element not found in DOM!");return}console.log("âœ… Modal element found, calling modals.show()");const t=new Date().toISOString().split("T")[0],o=document.getElementById("expense-date");o?(o.value=t,console.log("âœ… Date set to:",t)):console.warn("âš ï¸ Expense date input not found"),this.modals.show("add-expense-modal");const n=document.getElementById("expense-installments"),s=document.getElementById("installments-group"),a=document.getElementById("expense-installments-count"),i=document.getElementById("expense-installments-interest");s&&(s.classList.add("hidden"),a&&(a.value=""),i&&(i.value="")),n&&s&&(n.onchange=r=>{s.classList.toggle("hidden",!r.target.checked)},s.classList.toggle("hidden",!n.checked))}showEditLimitModal(e){const t=document.getElementById("edit-limit-modal"),o=document.getElementById("edit-limit-form");if(!t||!o)return;const s=(this.data.getSpendingLimits()||[]).find(l=>String(l.id)===String(e));if(!s){this.ui.showAlert("LÃ­mite no encontrado","error");return}const a=this.data.getCategories();this.ui.updateCategoriesSelect(a,"edit-limit-category"),S.safeSetValue("edit-limit-category",s.category||""),S.safeSetValue("edit-limit-amount",parseFloat(s.amount||0));const i=s.warning_percentage??80,r=o.querySelector('input[name="warningPercentage"]');r&&(r.value=i),t.dataset.limitId=String(e),this.modals.show("edit-limit-modal")}async handleEditLimitSubmit(e){var s;e.preventDefault();const t=document.getElementById("edit-limit-modal"),o=this.ui.getFormData("edit-limit-form"),n=(s=t==null?void 0:t.dataset)==null?void 0:s.limitId;if(n){if(!o.category||!o.amount){this.ui.showAlert("Por favor completa todos los campos","error");return}try{const a={category:o.category,amount:parseFloat(o.amount)};if(o.warningPercentage!==void 0&&o.warningPercentage!==""){const r=parseInt(o.warningPercentage,10);Number.isNaN(r)||(a.warning_percentage=r)}if(!await this.data.updateSpendingLimit(n,a))throw new Error("No se pudo actualizar");this.modals.hide("edit-limit-modal"),this.ui.showAlert("LÃ­mite actualizado exitosamente","success"),this.updateDashboard()}catch(a){console.error(a),this.ui.showAlert("Error al actualizar el lÃ­mite","error")}}}showAddGoalModal(){console.log("ğŸ¯ Show add goal modal"),this.modals.show("add-goal-modal")}showAddSpendingLimitModal(){console.log("âš ï¸ Show add spending limit modal");const e=document.getElementById("limit-category");if(arguments.length>0&&e){const t=arguments[0];setTimeout(()=>{e.value=t},100)}this.modals.show("add-spending-limit-modal")}showAddBudgetModal(){console.log("ğŸ’° Show add budget modal"),this.ui.showAddBudgetModal()}showManageCategoriesModal(){console.log("ğŸ·ï¸ Show manage categories modal");const e=this.data.getCategories();this.ui.updateCategoriesManagementList(e),this.modals.show("manage-categories-modal")}showImportDataModal(){console.log("ğŸ“¥ Show import data modal"),this.modals.show("import-data-modal")}showViewIncomesModal(){console.log("ğŸ‘ï¸ Show view incomes modal");const e=this.data.getIncome(this.currentMonth),t=this.data.getExtraIncomes(this.currentMonth);this.ui.updateIncomeDetails(e,t),this.modals.show("view-incomes-modal")}showInstallmentsModal(){console.log("ğŸ“Š Show installments modal"),this.modals.show("view-installments-modal")}async handleAddExpense(e){e.preventDefault(),console.log("ğŸ’³ Adding/Editing expense...");const t=this.ui.getFormData("add-expense-form"),o=T.validateExpenseForm(t);if(!o.isValid){const r=o.errors.join(`
`);this.ui.showAlert(r,"error");return}const n=o.sanitizedData,s=document.getElementById("add-expense-modal"),a=(s==null?void 0:s.dataset.editing)==="true",i=s==null?void 0:s.dataset.expenseId;try{const r={description:n.description,amount:n.amount,category:n.category,transactionDate:n.transactionDate,month:this.currentMonth,installment:1,totalInstallments:1,recurring:!1};if(a&&i){const d={description:r.description,amount:r.amount,category:r.category,transaction_date:r.transactionDate,month:r.month};if(!await this.data.updateExpense(i,d)){this.ui.showAlert("No se pudo actualizar el gasto","error");return}this.ui.showAlert("Gasto actualizado","success"),delete s.dataset.editing,delete s.dataset.expenseId,this.modals.hide("add-expense-modal"),this.updateDashboard();return}const l=!!t.hasInstallments,c=n.installmentsCount||1;if(l&&c>=2){const d=n.installmentsInterest||0,u=r.amount*(1+d/100),g=u/c,p=Array.from({length:c},()=>Math.round(g*100)/100),h=p.reduce((y,b)=>y+b,0),E=Math.round((u-h)*100)/100;p[p.length-1]=Math.round((p[p.length-1]+E)*100)/100;const w=Math.round(u*100)/100;for(let y=0;y<c;y++){const b=new Date(t.transactionDate);b.setMonth(b.getMonth()+y);const A=`${b.getFullYear()}-${(b.getMonth()+1).toString().padStart(2,"0")}`,D={...r,amount:p[y],month:A,installment:y+1,totalInstallments:c,originalAmount:w,transactionDate:b.toISOString().split("T")[0]};console.log(`ğŸ“Š Adding installment ${y+1}/${c}:`,D),await this.data.addExpense(D)}this.ui.showAlert(`Gasto dividido en ${c} cuotas${d?` con ${d}% de interÃ©s`:""}`,"success")}else await this.data.addExpense(r),this.ui.showAlert("Gasto agregado exitosamente","success");this.modals.hide("add-expense-modal"),this.updateDashboard()}catch(r){console.error("Error saving expense:",r),this.ui.showAlert("Error al guardar el gasto","error")}}async handleAddBudget(e){e.preventDefault(),console.log("ğŸ’° Adding budget...");const t=this.ui.getBudgetFormData("add-budget-form"),o=T.validateBudgetForm(t);if(!o.isValid){const s=o.errors.join(`
`);this.ui.showAlert(s,"error");return}const n=o.sanitizedData;try{const s={name:n.name,category:n.category,amount:n.amount,start_date:n.start_date,end_date:n.end_date,ai_recommended:t.ai_recommended||!1};await this.budget.addBudget(s)?(this.modals.hide("add-budget-modal"),this.ui.showAlert("Presupuesto creado exitosamente","success"),this.updateDashboard()):this.ui.showAlert("Error al crear el presupuesto","error")}catch(s){console.error("Error adding budget:",s),this.ui.showAlert("Error al crear el presupuesto","error")}}async handleEditBudget(e){e.preventDefault(),console.log("âœï¸ Editing budget...");const t=document.getElementById("edit-budget-modal"),o=t==null?void 0:t.dataset.budgetId;if(!o){this.ui.showAlert("Error: ID de presupuesto no encontrado","error");return}const n=this.ui.getBudgetFormData("edit-budget-form");if(!n.name||!n.category||!n.amount||!n.start_date||!n.end_date){this.ui.showAlert("Por favor completa todos los campos","error");return}const s=new Date(n.start_date);if(new Date(n.end_date)<=s){this.ui.showAlert("La fecha de fin debe ser posterior a la fecha de inicio","error");return}try{const i={name:n.name,category:n.category,amount:parseFloat(n.amount),start_date:n.start_date,end_date:n.end_date};await this.budget.updateBudget(o,i)?(this.modals.hide("edit-budget-modal"),this.ui.showAlert("Presupuesto actualizado exitosamente","success"),this.updateDashboard()):this.ui.showAlert("Error al actualizar el presupuesto","error")}catch(i){console.error("Error editing budget:",i),this.ui.showAlert("Error al actualizar el presupuesto","error")}}showEditBudgetModal(e){console.log("âœï¸ Show edit budget modal for:",e),this.ui.showEditBudgetModal(e)}async deleteBudget(e,t){if(confirm(`Â¿EstÃ¡s seguro de que quieres eliminar el presupuesto "${t}"?`))try{await this.budget.deleteBudget(e)?(this.ui.showAlert("Presupuesto eliminado exitosamente","success"),this.updateDashboard()):this.ui.showAlert("Error al eliminar el presupuesto","error")}catch(o){console.error("Error deleting budget:",o),this.ui.showAlert("Error al eliminar el presupuesto","error")}}async handleAddIncome(e){e.preventDefault(),console.log("ğŸ’° Adding income...");const t=this.ui.getFormData("add-income-form"),o=T.validateIncomeForm(t);if(!o.isValid){const s=o.errors.join(`
`);this.ui.showAlert(s,"error");return}const n=o.sanitizedData;try{if(n.type==="fixed")await this.data.addFixedIncome(this.currentMonth,n.amount);else{const s={description:n.description||"Ingreso extra",amount:n.amount,category:t.category||"other"};await this.data.addExtraIncome(this.currentMonth,s)}this.modals.hide("add-income-modal"),this.ui.showAlert("Ingreso agregado exitosamente","success"),this.updateDashboard()}catch(s){console.error("Error adding income:",s),this.ui.showAlert("Error al agregar el ingreso","error")}}async handleAddGoal(e){e.preventDefault(),console.log("ğŸ¯ Adding goal...");const t=this.ui.getFormData("add-goal-form"),o=T.validateGoalForm(t);if(!o.isValid){const s=o.errors.join(`
`);this.ui.showAlert(s,"error");return}const n=o.sanitizedData;try{const s={name:n.name,targetAmount:n.targetAmount,currentAmount:n.currentAmount,targetDate:n.targetDate};await this.data.addGoal(s),this.modals.hide("add-goal-modal"),this.ui.showAlert("Objetivo creado exitosamente","success"),this.updateDashboard()}catch(s){console.error("Error adding goal:",s),this.ui.showAlert("Error al crear el objetivo","error")}}async handleAddSpendingLimit(e){e.preventDefault(),console.log("ğŸš¦ Adding spending limit...");const t=this.ui.getFormData("add-spending-limit-form");if(!t.category||!t.amount){this.ui.showAlert("Por favor completa todos los campos","error");return}try{const o={category:t.category,amount:parseFloat(t.amount),warningPercentage:parseInt(t.warningPercentage)||80};console.log("ğŸš¦ Creating spending limit:",o),await this.data.addSpendingLimit(o),this.modals.hide("add-spending-limit-modal"),this.ui.showAlert("LÃ­mite de gasto creado exitosamente","success"),this.updateDashboard()}catch(o){console.error("âŒ Error adding spending limit:",o),this.ui.showAlert("Error al crear el lÃ­mite de gasto","error")}}async handleAddCategory(e){e.preventDefault(),console.log("ğŸ·ï¸ handleAddCategory started...");const t=this.ui.getFormData("add-category-form");if(console.log("ğŸ·ï¸ Form data received:",t),!t.name||!t.icon){console.error("âŒ Missing required fields:",{name:t.name,icon:t.icon}),this.ui.showAlert("Por favor completa todos los campos","error");return}try{const o=["#ef4444","#3b82f6","#8b5cf6","#f59e0b","#10b981","#6366f1","#ec4899","#06b6d4","#84cc16","#f97316"],n=o[Math.floor(Math.random()*o.length)],s={name:t.name,icon:t.icon,color:t.color||n};console.log("ğŸ·ï¸ Final category data to save:",s);const a=await this.data.addCategory(s);if(console.log("ğŸ·ï¸ addCategory result:",a),a){const i=this.data.getCategories();this.ui.updateCategoriesManagementList(i),this.ui.updateCategoriesSelect(i,"expense-category"),this.ui.updateCategoriesSelect(i,"limit-category"),this.ui.clearForm("add-category-form"),this.ui.showAlert("CategorÃ­a agregada exitosamente","success")}else this.ui.showAlert("Error al guardar la categorÃ­a en la base de datos","error")}catch(o){console.error("Error adding category:",o),this.ui.showAlert("Error al agregar la categorÃ­a","error")}}handleExportData(){console.log("ğŸ“Š Exporting data...");const e=prompt(`Â¿QuÃ© datos quieres exportar?
1. Completo (gastos + ingresos + cuotas)
2. Solo gastos
3. Solo ingresos

Escribe "completo", "gastos" o "ingresos":`);if(e){let t="complete";if(e.toLowerCase().includes("gasto")?t="expenses":e.toLowerCase().includes("ingreso")&&(t="incomes"),this.data.exportDataToCSV(t)){const n=t==="complete"?"datos completos":t==="expenses"?"gastos":"ingresos";this.ui.showAlert(`${n.charAt(0).toUpperCase()+n.slice(1)} exportados exitosamente`,"success")}else this.ui.showAlert("Error al exportar los datos","error")}}async handleImportData(){var o;console.log("ğŸ“¥ Importing data...");const e=document.getElementById("import-file"),t=((o=document.querySelector('input[name="import-type"]:checked'))==null?void 0:o.value)||"auto";if(!e.files[0]){this.ui.showAlert("Por favor selecciona un archivo CSV","error");return}try{const n=e.files[0],s=await this.data.importDataFromCSV(n,t);this.modals.hide("import-data-modal");let a=`ImportaciÃ³n exitosa: ${s.imported} registros importados`;s.errors>0&&(a+=`, ${s.errors} errores encontrados`),this.ui.showAlert(a,s.errors>0?"warning":"success"),this.updateDashboard()}catch(n){console.error("Error importing data:",n),this.ui.showAlert("Error al importar los datos: "+n.message,"error")}}handleBackupData(){console.log("â˜ï¸ Backup data..."),this.ui.showAlert("FunciÃ³n de respaldo prÃ³ximamente","info")}async prepareReportData(e){let o=[this.getCurrentMonth()];e==="last3"?o=this.getLastMonths(3):e==="last6"?o=this.getLastMonths(6):e==="year"&&(o=this.getLastMonths(12));const n={period:e,months:o.length,totalExpenses:0,totalIncome:0,categories:{},goals:this.data.getGoals(),spendingLimits:this.data.getSpendingLimits()};for(const s of o){const a=await this.data.loadExpenses(s),i=await this.data.loadIncome(s),r=await this.data.loadExtraIncomes(s);n.totalExpenses+=a.reduce((l,c)=>l+parseFloat(c.amount),0),n.totalIncome+=parseFloat(i.fixed)+parseFloat(i.extra)+r.reduce((l,c)=>l+parseFloat(c.amount),0),a.forEach(l=>{n.categories[l.category]=(n.categories[l.category]||0)+parseFloat(l.amount)})}return n}getLastMonths(e){const t=[],o=new Date;for(let n=0;n<e;n++){const s=new Date(o.getFullYear(),o.getMonth()-n,1),a=`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,"0")}`;t.push(a)}return t}showEditExpenseModal(e){console.log("âœï¸ Show edit expense modal",e);const o=(this.data.getExpenses(this.currentMonth)||[]).find(r=>String(r.id)===String(e));if(!o)return this.ui.showAlert("No se encontrÃ³ el gasto a editar","error");const n=document.getElementById("add-expense-form");if(!n)return;n.reset(),(document.getElementById("expense-description")||{}).value=o.description||"",(document.getElementById("expense-amount")||{}).value=parseFloat(o.amount||0),(document.getElementById("expense-category")||{}).value=o.category||"",(document.getElementById("expense-date")||{}).value=o.transaction_date&&String(o.transaction_date).slice(0,10)||o.created_at&&String(o.created_at).slice(0,10)||new Date().toISOString().split("T")[0];const s=document.getElementById("expense-installments"),a=document.getElementById("installments-group");if(s&&a){const r=(o.total_installments||o.totalInstallments||1)>1;if(s.checked=r,a.classList.toggle("hidden",!r),r){const l=document.getElementById("expense-installments-count");l&&(l.value=o.total_installments||o.totalInstallments||2)}}const i=document.getElementById("add-expense-modal");i&&(i.dataset.editing="true",i.dataset.expenseId=String(e)),this.modals.show("add-expense-modal")}showDeleteConfirmation(e,t){confirm(`Â¿EstÃ¡s seguro de que quieres eliminar "${t}"?`)&&this.deleteExpense(e)}async deleteExpense(e){try{await this.data.deleteExpense(e),this.ui.showAlert("Gasto eliminado exitosamente","success"),this.updateDashboard()}catch(t){console.error("Error deleting expense:",t),this.ui.showAlert("Error al eliminar el gasto","error")}}addToGoal(e){console.log("ğŸ’° Add to goal:",e);const t=this.data.getGoals().find(o=>o.id===e);if(!t){this.ui.showAlert("Objetivo no encontrado","error");return}this.ui.showAddMoneyModal(t)}editGoal(e){console.log("âœï¸ Edit goal:",e);const t=this.data.getGoals().find(o=>o.id===e);if(!t){this.ui.showAlert("Objetivo no encontrado","error");return}this.ui.showEditGoalModal(t)}async deleteGoal(e,t){if(confirm(`Â¿EstÃ¡s seguro de que quieres eliminar el objetivo "${t}"?`))try{await this.data.deleteGoal(e)?(this.ui.showAlert("Objetivo eliminado exitosamente","success"),this.updateDashboard()):this.ui.showAlert("Error al eliminar el objetivo","error")}catch(o){console.error("Error deleting goal:",o),this.ui.showAlert("Error al eliminar el objetivo","error")}}async handleEditGoal(e){e.preventDefault(),console.log("âœï¸ Handling edit goal...");const o=document.getElementById("edit-goal-modal").dataset.goalId;if(!o){this.ui.showAlert("Error: ID de objetivo no encontrado","error");return}const n=this.ui.getFormData("edit-goal-form");if(!n.name||!n.targetAmount){this.ui.showAlert("Por favor completa todos los campos requeridos","error");return}try{const s={name:n.name,target_amount:parseFloat(n.targetAmount),current_amount:parseFloat(n.currentAmount)||0};await this.data.updateGoal(o,s)?(this.modals.hide("edit-goal-modal"),this.ui.showAlert("Objetivo actualizado exitosamente","success"),this.updateDashboard()):this.ui.showAlert("Error al actualizar el objetivo","error")}catch(s){console.error("Error editing goal:",s),this.ui.showAlert("Error al actualizar el objetivo","error")}}async handleAddMoney(e){e.preventDefault(),console.log("ğŸ’° Handling add money to goal...");const o=document.getElementById("add-money-modal").dataset.goalId;if(!o){this.ui.showAlert("Error: ID de objetivo no encontrado","error");return}const n=this.ui.getFormData("add-money-form");if(!n.amount){this.ui.showAlert("Por favor ingresa un monto","error");return}try{const s=await this.data.addMoneyToGoal(o,n.amount);s.success&&(this.modals.hide("add-money-modal"),s.completed?this.ui.showAlert("Â¡Felicitaciones! Has completado tu objetivo de ahorro ğŸ‰","success"):this.ui.showAlert(`Dinero agregado exitosamente. Nuevo total: ${this.ui.formatCurrency(s.goal.current_amount)}`,"success"),this.updateDashboard())}catch(s){console.error("Error adding money to goal:",s),this.ui.showAlert(s.message||"Error al agregar dinero al objetivo","error")}}async deleteCategory(e){if(confirm("Â¿EstÃ¡s seguro de que quieres eliminar esta categorÃ­a?"))try{await this.data.deleteCategory(e),this.ui.showAlert("CategorÃ­a eliminada exitosamente","success");const t=this.data.getCategories();this.ui.updateCategoriesManagementList(t),this.ui.updateCategoriesSelect(t,"expense-category"),this.ui.updateCategoriesSelect(t,"limit-category")}catch(t){console.error("Error deleting category:",t),this.ui.showAlert("Error al eliminar la categorÃ­a","error")}}editSpendingLimit(e){console.log("âœï¸ Edit spending limit:",e),this.ui.showAlert("FunciÃ³n de editar lÃ­mite prÃ³ximamente","info")}async deleteSpendingLimit(e){if(confirm("Â¿EstÃ¡s seguro de que quieres eliminar este lÃ­mite de gasto?"))try{await this.data.deleteSpendingLimit(e),this.ui.showAlert("LÃ­mite eliminado exitosamente","success"),this.updateDashboard()}catch(t){console.error("Error deleting spending limit:",t),this.ui.showAlert("Error al eliminar el lÃ­mite","error")}}getCurrentMonth(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`}hideLoadingScreen(){setTimeout(()=>{z.hide()},300)}}document.addEventListener("DOMContentLoaded",()=>{console.log("ğŸŒŸ DOM LOADED - Creating FINZN App instance"),window.app=new fe});console.log("âœ… MAIN.JS LOADED SUCCESSFULLY");
